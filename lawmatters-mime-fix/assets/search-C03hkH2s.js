import{supabase as e}from"./supabase-Cfql4b7O.js";import{x as t}from"./ai-services-C7T4cFUa.js";async function r(r){const{query:a,userId:s,similarityThreshold:c=.7,maxResults:i=10,documentIds:n}=r;try{const{embedding:r}=await t(a),{data:d,error:o}=await e.rpc("search_similar_chunks",{query_embedding:r,similarity_threshold:c,match_count:i,user_filter:s||null});if(o)throw new Error("Failed to perform semantic search");let u=d||[];n&&n.length>0&&(u=u.filter(e=>n.includes(e.document_id)));return await Promise.all(u.map(async t=>{const{data:r}=await e.from("uploaded_documents").select("*").eq("id",t.document_id).single();return{id:t.id,document_id:t.document_id,chunk_text:t.chunk_text,similarity:t.similarity,document:r||void 0}}))}catch(d){throw d}}async function a(t){const{query:r,userId:a,documentType:s,dateRange:c}=t;try{let t=e.from("uploaded_documents").select("*").eq("user_id",a).textSearch("ocr_text",r,{type:"websearch",config:"english"});s&&(t=t.eq("document_type",s)),c&&(t=t.gte("created_at",c.start.toISOString()).lte("created_at",c.end.toISOString())),t=t.order("created_at",{ascending:!1});const{data:i,error:n}=await t;if(n)throw new Error("Failed to perform text search");return i||[]}catch(i){throw i}}async function s(e,t,s={}){const{semanticWeight:c=.7,textWeight:i=.3,maxResults:n=20,documentType:d,dateRange:o}=s;try{const[s,i]=await Promise.all([r({query:e,userId:t,maxResults:Math.ceil(n*c)}),a({query:e,userId:t,documentType:d,dateRange:o})]),u=new Set,m=[];return s.forEach(e=>{e.document&&!u.has(e.document.id)&&(u.add(e.document.id),m.push(e.document))}),i.forEach(e=>{u.has(e.id)||(u.add(e.id),m.push(e))}),{semanticResults:s,textResults:m.slice(0,n),totalResults:m.length}}catch(u){throw u}}export{s as c,r as s,a as t};
