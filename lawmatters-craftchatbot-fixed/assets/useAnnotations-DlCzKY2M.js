import{bS as e,bT as t,bU as a,r as n}from"./react-vendor-SE0pM8Ra.js";import{supabase as o}from"./supabase-Cfql4b7O.js";import{J as s}from"./vendor-CrSvAuNw.js";const r=new class{async getDocumentAnnotations(e){const{data:t,error:a}=await o.from("document_annotations").select("*").eq("document_id",e).order("created_at",{ascending:!0});if(a)throw new Error(`Failed to fetch annotations: ${a.message}`);return t||[]}async createAnnotation(e){const{data:t}=await o.auth.getUser();if(!t.user)throw new Error("User not authenticated");const{data:a,error:n}=await o.from("document_annotations").insert({...e,user_id:t.user.id,is_resolved:!1}).select().single();if(n)throw new Error(`Failed to create annotation: ${n.message}`);return a}async updateAnnotation(e,t){const{data:a,error:n}=await o.from("document_annotations").update(t).eq("id",e).select().single();if(n)throw new Error(`Failed to update annotation: ${n.message}`);return a}async deleteAnnotation(e){const{error:t}=await o.from("document_annotations").delete().eq("id",e);if(t)throw new Error(`Failed to delete annotation: ${t.message}`)}subscribeToAnnotations(e,t){return{unsubscribe:()=>{}}}async getDocumentCollaborators(e){const{data:t,error:a}=await o.from("annotation_collaborators").select("\n        *,\n        user:profiles!annotation_collaborators_user_id_fkey(id, email, first_name, last_name),\n        invited_by_user:profiles!annotation_collaborators_invited_by_fkey(id, email, first_name, last_name)\n      ").eq("document_id",e);if(a)throw new Error(`Failed to fetch collaborators: ${a.message}`);return t||[]}async inviteCollaborator(e){const{data:t,error:a}=await o.from("profiles").select("id").eq("email",e.email).single();if(a||!t)throw new Error("User not found with this email address");const{data:n,error:s}=await o.from("annotation_collaborators").insert({document_id:e.document_id,user_id:t.id,permission_level:e.permission_level,invited_by:(await o.auth.getUser()).data.user?.id}).select().single();if(s)throw new Error(`Failed to invite collaborator: ${s.message}`);return n}async removeCollaborator(e){const{error:t}=await o.from("annotation_collaborators").delete().eq("id",e);if(t)throw new Error(`Failed to remove collaborator: ${t.message}`)}async updateCollaboratorPermission(e,t){const{data:a,error:n}=await o.from("annotation_collaborators").update({permission_level:t}).eq("id",e).select().single();if(n)throw new Error(`Failed to update permission: ${n.message}`);return a}async createReply(e){const{data:t}=await o.auth.getUser();if(!t.user)throw new Error("User not authenticated");const{data:a,error:n}=await o.from("annotation_replies").insert({...e,user_id:t.user.id}).select("\n        *,\n        user:profiles!annotation_replies_user_id_fkey(id, email, first_name, last_name)\n      ").single();if(n)throw new Error(`Failed to create reply: ${n.message}`);return a}};function i(o,i){const c=e(),{data:l=[],isLoading:d,error:u,refetch:m}=t({queryKey:["annotations",o,i],queryFn:()=>r.getDocumentAnnotations(o,i),enabled:!!o,staleTime:3e4}),g=a({mutationFn:r.createAnnotation,onSuccess:e=>{c.setQueryData(["annotations",o,i],(t=[])=>[...t,e]),s.success("Annotation created successfully")},onError:e=>{s.error(`Failed to create annotation: ${e.message}`)}}),f=a({mutationFn:({id:e,data:t})=>r.updateAnnotation(e,t),onSuccess:e=>{c.setQueryData(["annotations",o,i],(t=[])=>t.map(t=>t.id===e.id?e:t)),s.success("Annotation updated successfully")},onError:e=>{s.error(`Failed to update annotation: ${e.message}`)}}),y=a({mutationFn:r.deleteAnnotation,onSuccess:(e,t)=>{c.setQueryData(["annotations",o,i],(e=[])=>e.filter(e=>e.id!==t)),s.success("Annotation deleted successfully")},onError:e=>{s.error(`Failed to delete annotation: ${e.message}`)}});return{annotations:l,isLoading:d,error:u,refetch:m,createAnnotation:n.useCallback(e=>g.mutateAsync(e),[g]),updateAnnotation:n.useCallback((e,t)=>f.mutateAsync({id:e,data:t}),[f]),deleteAnnotation:n.useCallback(e=>y.mutateAsync(e),[y]),isCreating:g.isPending,isUpdating:f.isPending,isDeleting:y.isPending}}function c(t){const o=e(),i=a({mutationFn:r.addComment,onSuccess:e=>{o.setQueriesData({queryKey:["annotations"]},(a=[])=>a.map(a=>a.id===t?{...a,comments:[...a.comments||[],e]}:a)),s.success("Comment added successfully")},onError:e=>{s.error(`Failed to add comment: ${e.message}`)}}),c=a({mutationFn:({id:e,content:t})=>r.updateComment(e,t),onSuccess:e=>{o.setQueriesData({queryKey:["annotations"]},(a=[])=>a.map(a=>a.id===t?{...a,comments:a.comments?.map(t=>t.id===e.id?e:t)||[]}:a)),s.success("Comment updated successfully")},onError:e=>{s.error(`Failed to update comment: ${e.message}`)}}),l=a({mutationFn:r.deleteComment,onSuccess:(e,a)=>{o.setQueriesData({queryKey:["annotations"]},(e=[])=>e.map(e=>e.id===t?{...e,comments:e.comments?.filter(e=>e.id!==a)||[]}:e)),s.success("Comment deleted successfully")},onError:e=>{s.error(`Failed to delete comment: ${e.message}`)}});return{addComment:n.useCallback(e=>i.mutateAsync(e),[i]),updateComment:n.useCallback((e,t)=>c.mutateAsync({id:e,content:t}),[c]),deleteComment:n.useCallback(e=>l.mutateAsync(e),[l]),isAddingComment:i.isPending,isUpdatingComment:c.isPending,isDeletingComment:l.isPending}}function l(){const t=e(),o=a({mutationFn:r.shareAnnotation,onSuccess:e=>{t.setQueriesData({queryKey:["annotations"]},(t=[])=>t.map(t=>t.id===e.annotationId?{...t,shares:[...t.shares||[],e]}:t)),s.success("Annotation shared successfully")},onError:e=>{s.error(`Failed to share annotation: ${e.message}`)}}),i=a({mutationFn:r.removeShare,onSuccess:(e,a)=>{t.setQueriesData({queryKey:["annotations"]},(e=[])=>e.map(e=>({...e,shares:e.shares?.filter(e=>e.id!==a)||[]}))),s.success("Share removed successfully")},onError:e=>{s.error(`Failed to remove share: ${e.message}`)}});return{shareAnnotation:n.useCallback(e=>o.mutateAsync(e),[o]),removeShare:n.useCallback(e=>i.mutateAsync(e),[i]),isSharing:o.isPending,isRemoving:i.isPending}}function d(){const[e,t]=n.useState({annotation:null,isEditing:!1}),[a,o]=n.useState({type:"highlight",color:"yellow",isActive:!1}),[s,r]=n.useState({isDrawing:!1,currentPath:"",strokeWidth:2,color:"red"});return{selectedAnnotation:e,activeTool:a,drawingState:s,selectAnnotation:n.useCallback((e,a=!1)=>{t({annotation:e,isEditing:a})},[]),activateTool:n.useCallback((e,t="yellow")=>{o({type:e,color:t,isActive:!0})},[]),deactivateTool:n.useCallback(()=>{o(e=>({...e,isActive:!1}))},[]),startDrawing:n.useCallback((e="red",t=2)=>{r({isDrawing:!0,currentPath:"",strokeWidth:t,color:e})},[]),updateDrawingPath:n.useCallback(e=>{r(t=>({...t,currentPath:e}))},[]),stopDrawing:n.useCallback(()=>{r(e=>({...e,isDrawing:!1}))},[])}}export{l as a,i as b,d as c,c as u};
