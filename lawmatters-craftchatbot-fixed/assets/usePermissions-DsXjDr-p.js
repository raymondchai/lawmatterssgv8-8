import{r as e,j as s,F as t,w as a,aL as r,y as n,Y as i,bH as l,bG as o,s as c,cB as d,cC as m,ct as u}from"./react-vendor-SE0pM8Ra.js";import{ad as h,L as x,M as g,A as p,E as w,G as f,H as j,K as _,B as v,C as y,o as N,q as E,r as T,s as S,t as R,u as A,v as b,z as D,y as U}from"./ai-services-C7T4cFUa.js";import{supabase as P}from"./supabase-Cfql4b7O.js";import{f as M}from"./utilities-CJeqyZZO.js";const I=new class{async getDashboardAnalytics(e){try{const s=e?.end||new Date,t=e?.start||new Date(Date.now()-2592e6),[a,r,n,i]=await Promise.all([this.getTotalTemplates(),this.getTotalDownloads(),this.getTotalRevenue(),this.getTotalUsers()]),[l,o,c]=await Promise.all([this.getDownloadsInPeriod(t,s),this.getRevenueInPeriod(t,s),this.getNewUsersInPeriod(t,s)]),[d,m,u,h,x,g]=await Promise.all([this.getPopularTemplates(10),this.getCategoryStats(),this.getUserEngagementMetrics(t,s),this.getRevenueBreakdown(),this.getDownloadTrends(t,s),this.getFormatStats()]);return{totalTemplates:a,totalDownloads:r,totalRevenue:n,totalUsers:i,downloadsThisMonth:l,revenueThisMonth:o,newUsersThisMonth:c,popularTemplates:d,categoryStats:m,userEngagement:u,revenueBreakdown:h,downloadTrends:x,formatStats:g}}catch(s){throw new Error("Failed to fetch analytics data")}}async getTemplatePerformance(e){try{let s=P.from("templates").select("\n          id,\n          title,\n          download_count,\n          rating_average,\n          updated_at,\n          template_analytics!inner(event_type),\n          template_downloads!inner(format),\n          template_customizations!inner(id)\n        ");e&&(s=s.eq("id",e));const{data:t,error:a}=await s;if(a)throw a;return t.map(e=>{const s=e.template_analytics?.filter(e=>"template_view"===e.event_type).length||0,t=e.template_customizations?.length||0,a=e.download_count||0;return{templateId:e.id,title:e.title,views:s,customizations:t,downloads:a,revenue:50*a,rating:e.rating_average||0,conversionRate:s>0?a/s*100:0,lastUpdated:new Date(e.updated_at)}})}catch(s){throw new Error("Failed to fetch template performance data")}}async getRevenueAnalytics(){try{const e=await this.getTotalRevenue(),s=await this.getRevenueInPeriod(new Date(Date.now()-2592e6),new Date),t=await this.getRevenueInPeriod(new Date(Date.now()-5184e6),new Date(Date.now()-2592e6)),a=t>0?(s-t)/t*100:0,r=await this.getTopRevenueTemplates(5);return{totalRevenue:e,monthlyRevenue:s,revenueGrowth:a,averageOrderValue:await this.getAverageOrderValue(),topRevenueTemplates:r}}catch(e){throw new Error("Failed to fetch revenue analytics")}}async getTotalTemplates(){const{count:e,error:s}=await P.from("templates").select("*",{count:"exact",head:!0}).eq("is_active",!0);if(s)throw s;return e||0}async getTotalDownloads(){const{count:e,error:s}=await P.from("template_downloads").select("*",{count:"exact",head:!0});if(s)throw s;return e||0}async getTotalRevenue(){return 25*await this.getTotalDownloads()}async getTotalUsers(){const{count:e,error:s}=await P.from("profiles").select("*",{count:"exact",head:!0});if(s)throw s;return e||0}async getDownloadsInPeriod(e,s){const{count:t,error:a}=await P.from("template_downloads").select("*",{count:"exact",head:!0}).gte("created_at",e.toISOString()).lte("created_at",s.toISOString());if(a)throw a;return t||0}async getRevenueInPeriod(e,s){return 25*await this.getDownloadsInPeriod(e,s)}async getNewUsersInPeriod(e,s){const{count:t,error:a}=await P.from("profiles").select("*",{count:"exact",head:!0}).gte("created_at",e.toISOString()).lte("created_at",s.toISOString());if(a)throw a;return t||0}async getPopularTemplates(e=10){const{data:s,error:t}=await P.from("templates").select("\n        id,\n        title,\n        download_count,\n        price_sgd,\n        categories(name)\n      ").eq("is_active",!0).order("download_count",{ascending:!1}).limit(e);if(t)throw t;return s.map(e=>({id:e.id,title:e.title,downloadCount:e.download_count||0,revenue:(e.download_count||0)*(e.price_sgd||0),category:e.categories?.name||"Uncategorized"}))}async getCategoryStats(){const{data:e,error:s}=await P.from("template_categories").select("\n        id,\n        name,\n        templates(id, download_count, price_sgd)\n      ");if(s)throw s;return e.map(e=>({categoryId:e.id,categoryName:e.name,templateCount:e.templates?.length||0,downloadCount:e.templates?.reduce((e,s)=>e+(s.download_count||0),0)||0,revenue:e.templates?.reduce((e,s)=>e+(s.download_count||0)*(s.price_sgd||0),0)||0}))}async getUserEngagementMetrics(e,s){return{averageSessionDuration:180,bounceRate:35.5,conversionRate:12.8,repeatUsers:45}}async getRevenueBreakdown(){return{public:0,premium:15e3,enterprise:8500}}async getDownloadTrends(e,s){const t=[],a=Math.ceil((s.getTime()-e.getTime())/864e5);for(let r=0;r<a;r++){const s=new Date(e.getTime()+24*r*60*60*1e3);t.push({date:s.toISOString().split("T")[0],downloads:Math.floor(50*Math.random())+10,revenue:Math.floor(1e3*Math.random())+200})}return t}async getFormatStats(){const{data:e,error:s}=await P.from("template_downloads").select("format");if(s)throw s;const t=e.reduce((e,s)=>(e[s.format]=(e[s.format]||0)+1,e),{}),a=Object.values(t).reduce((e,s)=>e+s,0);return Object.entries(t).map(([e,s])=>({format:e,count:s,percentage:a>0?s/a*100:0}))}async getTopRevenueTemplates(e=5){const{data:s,error:t}=await P.from("templates").select("\n        id,\n        title,\n        download_count,\n        price_sgd\n      ").eq("is_active",!0).order("download_count",{ascending:!1}).limit(e);if(t)throw t;return s.map(e=>({templateId:e.id,title:e.title,revenue:(e.download_count||0)*(e.price_sgd||0),downloads:e.download_count||0}))}async getAverageOrderValue(){const e=await this.getTotalRevenue(),s=await this.getTotalDownloads();return s>0?e/s:0}},F=({className:U=""})=>{const[P,F]=e.useState(null),[L,C]=e.useState([]),[O,k]=e.useState(null),[q,V]=e.useState(!0),[G,Y]=e.useState(null),[$,W]=e.useState("30d"),[B,z]=e.useState("overview");e.useEffect(()=>{H()},[$]);const H=async()=>{try{V(!0),Y(null);const e=new Date,s=new Date;switch($){case"7d":s.setDate(e.getDate()-7);break;case"30d":s.setDate(e.getDate()-30);break;case"90d":s.setDate(e.getDate()-90);break;case"1y":s.setFullYear(e.getFullYear()-1)}const[t,a,r]=await Promise.all([I.getDashboardAnalytics({start:s,end:e}),I.getTemplatePerformance(),I.getRevenueAnalytics()]);F(t),C(a),k(r)}catch(e){Y(e instanceof Error?e.message:"Failed to load analytics")}finally{V(!1)}},K=e=>new Intl.NumberFormat("en-SG",{style:"currency",currency:"SGD"}).format(e),J=e=>new Intl.NumberFormat("en-SG").format(e),Q=e=>`${e.toFixed(1)}%`,X=e=>e>0?s.jsx(d,{className:"h-4 w-4 text-green-500"}):e<0?s.jsx(m,{className:"h-4 w-4 text-red-500"}):s.jsx(u,{className:"h-4 w-4 text-gray-500"});if(q)return s.jsxs("div",{className:`space-y-6 ${U}`,children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(h,{className:"h-8 w-64"}),s.jsx(h,{className:"h-10 w-32"})]}),s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[...Array(4)].map((e,t)=>s.jsx(h,{className:"h-32"},t))}),s.jsx(h,{className:"h-96"})]});if(G||!P)return s.jsx("div",{className:U,children:s.jsx(x,{children:s.jsx(g,{children:G||"Failed to load analytics data. Please try again."})})});const Z=[{title:"Total Templates",value:J(P.totalTemplates),change:"+12%",changeValue:12,icon:t,color:"text-blue-600"},{title:"Total Downloads",value:J(P.totalDownloads),change:"+8.5%",changeValue:8.5,icon:a,color:"text-green-600"},{title:"Total Revenue",value:K(P.totalRevenue),change:"+15.2%",changeValue:15.2,icon:r,color:"text-purple-600"},{title:"Active Users",value:J(P.totalUsers),change:"+6.8%",changeValue:6.8,icon:n,color:"text-orange-600"}];return s.jsxs("div",{className:`space-y-6 ${U}`,children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("h2",{className:"text-3xl font-bold text-gray-900",children:"Template Analytics"}),s.jsx("p",{className:"text-gray-600 mt-1",children:"Comprehensive insights into template marketplace performance"})]}),s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsxs(p,{value:$,onValueChange:W,children:[s.jsx(w,{className:"w-32",children:s.jsx(f,{})}),s.jsxs(j,{children:[s.jsx(_,{value:"7d",children:"Last 7 days"}),s.jsx(_,{value:"30d",children:"Last 30 days"}),s.jsx(_,{value:"90d",children:"Last 90 days"}),s.jsx(_,{value:"1y",children:"Last year"})]})]}),s.jsxs(v,{variant:"outline",onClick:H,disabled:q,children:[s.jsx(i,{className:"h-4 w-4 mr-2"}),"Refresh"]})]})]}),s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:Z.map((e,t)=>s.jsx(y,{children:s.jsx(N,{className:"p-6",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex-1",children:[s.jsx("p",{className:"text-sm font-medium text-gray-600",children:e.title}),s.jsx("p",{className:"text-2xl font-bold text-gray-900 mt-1",children:e.value}),s.jsxs("div",{className:"flex items-center mt-2",children:[X(e.changeValue),s.jsx("span",{className:"text-sm ml-1 "+(e.changeValue>0?"text-green-600":e.changeValue<0?"text-red-600":"text-gray-600"),children:e.change}),s.jsx("span",{className:"text-xs text-gray-500 ml-1",children:"vs last period"})]})]}),s.jsx(e.icon,{className:`h-8 w-8 ${e.color}`})]})})},t))}),s.jsxs(E,{value:B,onValueChange:z,children:[s.jsxs(T,{className:"grid w-full grid-cols-4",children:[s.jsx(S,{value:"overview",children:"Overview"}),s.jsx(S,{value:"performance",children:"Performance"}),s.jsx(S,{value:"revenue",children:"Revenue"}),s.jsx(S,{value:"engagement",children:"Engagement"})]}),s.jsxs(R,{value:"overview",className:"space-y-6",children:[s.jsxs("div",{className:"grid lg:grid-cols-2 gap-6",children:[s.jsxs(y,{children:[s.jsxs(A,{children:[s.jsxs(b,{className:"flex items-center gap-2",children:[s.jsx(l,{className:"h-5 w-5"}),"Popular Templates"]}),s.jsx(D,{children:"Top performing templates by downloads"})]}),s.jsx(N,{children:s.jsx("div",{className:"space-y-4",children:P.popularTemplates.slice(0,5).map((e,t)=>s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center",children:s.jsx("span",{className:"text-sm font-medium text-blue-600",children:t+1})}),s.jsxs("div",{children:[s.jsx("p",{className:"font-medium text-gray-900",children:e.title}),s.jsx("p",{className:"text-sm text-gray-500",children:e.category})]})]}),s.jsxs("div",{className:"text-right",children:[s.jsx("p",{className:"font-medium",children:J(e.downloadCount)}),s.jsx("p",{className:"text-sm text-gray-500",children:"downloads"})]})]},e.id))})})]}),s.jsxs(y,{children:[s.jsxs(A,{children:[s.jsxs(b,{className:"flex items-center gap-2",children:[s.jsx(o,{className:"h-5 w-5"}),"Category Performance"]}),s.jsx(D,{children:"Downloads and revenue by category"})]}),s.jsx(N,{children:s.jsx("div",{className:"space-y-4",children:P.categoryStats.slice(0,5).map(e=>s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"font-medium",children:e.categoryName}),s.jsxs("span",{className:"text-sm text-gray-500",children:[J(e.downloadCount)," downloads"]})]}),s.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:s.jsx("div",{className:"bg-blue-600 h-2 rounded-full",style:{width:`${Math.min(e.downloadCount/Math.max(...P.categoryStats.map(e=>e.downloadCount))*100,100)}%`}})})]},e.categoryId))})})]})]}),s.jsxs(y,{children:[s.jsxs(A,{children:[s.jsx(b,{children:"Download Format Preferences"}),s.jsx(D,{children:"User preferences for document formats"})]}),s.jsx(N,{children:s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:P.formatStats.map(e=>s.jsxs("div",{className:"text-center p-4 border rounded-lg",children:[s.jsx("div",{className:"text-2xl font-bold text-gray-900",children:Q(e.percentage)}),s.jsx("div",{className:"text-sm text-gray-600 uppercase tracking-wide",children:e.format}),s.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[J(e.count)," downloads"]})]},e.format))})})]})]}),s.jsx(R,{value:"performance",className:"space-y-6",children:s.jsxs(y,{children:[s.jsxs(A,{children:[s.jsx(b,{children:"Template Performance Metrics"}),s.jsx(D,{children:"Detailed performance analysis for all templates"})]}),s.jsx(N,{children:s.jsx("div",{className:"overflow-x-auto",children:s.jsxs("table",{className:"w-full",children:[s.jsx("thead",{children:s.jsxs("tr",{className:"border-b",children:[s.jsx("th",{className:"text-left p-2",children:"Template"}),s.jsx("th",{className:"text-right p-2",children:"Views"}),s.jsx("th",{className:"text-right p-2",children:"Downloads"}),s.jsx("th",{className:"text-right p-2",children:"Conversion"}),s.jsx("th",{className:"text-right p-2",children:"Revenue"}),s.jsx("th",{className:"text-right p-2",children:"Rating"})]})}),s.jsx("tbody",{children:L.slice(0,10).map(e=>s.jsxs("tr",{className:"border-b",children:[s.jsx("td",{className:"p-2",children:s.jsxs("div",{children:[s.jsx("p",{className:"font-medium",children:e.title}),s.jsxs("p",{className:"text-xs text-gray-500",children:["Updated ",M(e.lastUpdated,{addSuffix:!0})]})]})}),s.jsx("td",{className:"text-right p-2",children:J(e.views)}),s.jsx("td",{className:"text-right p-2",children:J(e.downloads)}),s.jsx("td",{className:"text-right p-2",children:Q(e.conversionRate)}),s.jsx("td",{className:"text-right p-2",children:K(e.revenue)}),s.jsx("td",{className:"text-right p-2",children:s.jsxs("div",{className:"flex items-center justify-end gap-1",children:[s.jsx(c,{className:"h-4 w-4 text-yellow-400 fill-current"}),e.rating.toFixed(1)]})})]},e.templateId))})]})})})]})}),s.jsx(R,{value:"revenue",className:"space-y-6",children:O&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[s.jsx(y,{children:s.jsx(N,{className:"p-6",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Monthly Revenue"}),s.jsx("p",{className:"text-2xl font-bold text-gray-900",children:K(O.monthlyRevenue)}),s.jsxs("div",{className:"flex items-center mt-1",children:[X(O.revenueGrowth),s.jsx("span",{className:"text-sm ml-1 "+(O.revenueGrowth>0?"text-green-600":"text-red-600"),children:Q(O.revenueGrowth)})]})]}),s.jsx(r,{className:"h-8 w-8 text-green-600"})]})})}),s.jsx(y,{children:s.jsx(N,{className:"p-6",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Average Order Value"}),s.jsx("p",{className:"text-2xl font-bold text-gray-900",children:K(O.averageOrderValue)})]}),s.jsx(o,{className:"h-8 w-8 text-blue-600"})]})})}),s.jsx(y,{children:s.jsx(N,{className:"p-6",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Total Revenue"}),s.jsx("p",{className:"text-2xl font-bold text-gray-900",children:K(O.totalRevenue)})]}),s.jsx(l,{className:"h-8 w-8 text-purple-600"})]})})})]}),s.jsxs(y,{children:[s.jsxs(A,{children:[s.jsx(b,{children:"Top Revenue Generating Templates"}),s.jsx(D,{children:"Templates contributing most to revenue"})]}),s.jsx(N,{children:s.jsx("div",{className:"space-y-4",children:O.topRevenueTemplates.map((e,t)=>s.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"w-8 h-8 bg-green-100 rounded-full flex items-center justify-center",children:s.jsx("span",{className:"text-sm font-medium text-green-600",children:t+1})}),s.jsxs("div",{children:[s.jsx("p",{className:"font-medium text-gray-900",children:e.title}),s.jsxs("p",{className:"text-sm text-gray-500",children:[J(e.downloads)," downloads"]})]})]}),s.jsx("div",{className:"text-right",children:s.jsx("p",{className:"font-bold text-green-600",children:K(e.revenue)})})]},e.templateId))})})]})]})}),s.jsx(R,{value:"engagement",className:"space-y-6",children:s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[s.jsx(y,{children:s.jsx(N,{className:"p-6",children:s.jsxs("div",{className:"text-center",children:[s.jsxs("p",{className:"text-2xl font-bold text-gray-900",children:[P.userEngagement.averageSessionDuration,"s"]}),s.jsx("p",{className:"text-sm text-gray-600",children:"Avg Session Duration"})]})})}),s.jsx(y,{children:s.jsx(N,{className:"p-6",children:s.jsxs("div",{className:"text-center",children:[s.jsx("p",{className:"text-2xl font-bold text-gray-900",children:Q(P.userEngagement.bounceRate)}),s.jsx("p",{className:"text-sm text-gray-600",children:"Bounce Rate"})]})})}),s.jsx(y,{children:s.jsx(N,{className:"p-6",children:s.jsxs("div",{className:"text-center",children:[s.jsx("p",{className:"text-2xl font-bold text-gray-900",children:Q(P.userEngagement.conversionRate)}),s.jsx("p",{className:"text-sm text-gray-600",children:"Conversion Rate"})]})})}),s.jsx(y,{children:s.jsx(N,{className:"p-6",children:s.jsxs("div",{className:"text-center",children:[s.jsx("p",{className:"text-2xl font-bold text-gray-900",children:Q(P.userEngagement.repeatUsers)}),s.jsx("p",{className:"text-sm text-gray-600",children:"Repeat Users"})]})})})]})})]})]})},L={async getPermissions(){const{data:e,error:s}=await P.from("permissions").select("*").order("resource",{ascending:!0}).order("action",{ascending:!0});if(s)throw new Error("Failed to fetch permissions");return e||[]},async getRolePermissions(e){let s=P.from("role_permissions").select("\n        *,\n        permission:permissions(*)\n      ").order("role",{ascending:!0});e&&(s=s.eq("role",e));const{data:t,error:a}=await s;if(a)throw new Error("Failed to fetch role permissions");return t||[]},async updateRolePermissions(e,s){const{error:t}=await P.from("role_permissions").delete().eq("role",e);if(t)throw new Error("Failed to update role permissions");if(s.length>0){const t=s.map(s=>({role:e,permission_id:s})),{error:a}=await P.from("role_permissions").insert(t);if(a)throw new Error("Failed to update role permissions")}await this.logAction("update_role_permissions","role_permissions",e,null,{role:e,permission_ids:s})},async getUsers(e={}){let s=P.from("profiles").select("*").order("created_at",{ascending:!1});e.role&&(s=s.eq("role",e.role)),e.search&&(s=s.or(`full_name.ilike.%${e.search}%,email.ilike.%${e.search}%`));const{data:t,error:a}=await s;if(a)throw new Error("Failed to fetch users");return t||[]},async getUserWithPermissions(e){const{data:s,error:t}=await P.rpc("get_user_permissions",{user_uuid:e});if(t)throw new Error("Failed to fetch user permissions");const{data:a,error:r}=await P.from("profiles").select("*").eq("id",e).single();if(r)throw new Error("Failed to fetch user profile");return{...a,permissions:s||[]}},async updateUserRole(e,s){const{data:t}=await P.from("profiles").select("*").eq("id",e).single(),{data:a,error:r}=await P.from("profiles").update({role:s}).eq("id",e).select().single();if(r)throw new Error("Failed to update user role");return await this.logAction("update_user_role","profiles",e,{role:t?.role},{role:s}),a},async deleteUser(e){const{data:s}=await P.from("profiles").select("*").eq("id",e).single(),{error:t}=await P.from("profiles").delete().eq("id",e);if(t)throw new Error("Failed to delete user");await this.logAction("delete_user","profiles",e,s,null)},async getUserPermissions(e){const{data:s,error:t}=await P.from("user_permissions").select("\n        *,\n        permission:permissions(*),\n        granted_by_user:profiles!user_permissions_granted_by_fkey(full_name, email)\n      ").eq("user_id",e).order("created_at",{ascending:!1});if(t)throw new Error("Failed to fetch user permissions");return s||[]},async grantUserPermission(e){const{data:{user:s}}=await P.auth.getUser();if(!s)throw new Error("User not authenticated");const{data:t,error:a}=await P.from("user_permissions").upsert({...e,granted_by:s.id}).select("\n        *,\n        permission:permissions(*)\n      ").single();if(a)throw new Error("Failed to grant user permission");return await this.logAction("grant_user_permission","user_permissions",t.id,null,e),t},async revokeUserPermission(e,s){const{error:t}=await P.from("user_permissions").delete().eq("user_id",e).eq("permission_id",s);if(t)throw new Error("Failed to revoke user permission");await this.logAction("revoke_user_permission","user_permissions",`${e}-${s}`,{user_id:e,permission_id:s},null)},async hasPermission(e){const{data:{user:s}}=await P.auth.getUser();if(!s)return!1;const{data:t,error:a}=await P.rpc("user_has_permission",{user_uuid:s.id,permission_name:e});return!a&&(t||!1)},async getUserPermissionsList(e){const{data:{user:s}}=await P.auth.getUser(),t=e||s?.id;if(!t)return[];const{data:a,error:r}=await P.rpc("get_user_permissions",{user_uuid:t});return r?[]:(a||[]).filter(e=>e.granted_by_role||e.granted_individually).map(e=>e.permission_name)},async getAuditLogs(e={}){let s=P.from("audit_logs").select("\n        *,\n        user:profiles(full_name, email, role)\n      ").order("created_at",{ascending:!1}).limit(100);e.user_id&&(s=s.eq("user_id",e.user_id)),e.action&&(s=s.eq("action",e.action)),e.resource_type&&(s=s.eq("resource_type",e.resource_type)),e.date_from&&(s=s.gte("created_at",e.date_from.toISOString())),e.date_to&&(s=s.lte("created_at",e.date_to.toISOString()));const{data:t,error:a}=await s;if(a)throw new Error("Failed to fetch audit logs");return t||[]},async logAction(e,s,t,a,r,n,i){const{data:{user:l}}=await P.auth.getUser();if(!l)return;const{error:o}=await P.rpc("log_admin_action",{user_uuid:l.id,action_name:e,resource_type_name:s,resource_id_value:t,old_values_json:a,new_values_json:r,ip_addr:n,user_agent_string:i})},async bulkUpdateUserRoles(e,s){const{error:t}=await P.from("profiles").update({role:s}).in("id",e);if(t)throw new Error("Failed to bulk update user roles");await this.logAction("bulk_update_user_roles","profiles",e.join(","),null,{user_ids:e,role:s})},async bulkDeleteUsers(e){const{error:s}=await P.from("profiles").delete().in("id",e);if(s)throw new Error("Failed to bulk delete users");await this.logAction("bulk_delete_users","profiles",e.join(","),{user_ids:e},null)}},C=()=>{const[s,t]=e.useState([]),[a,r]=e.useState(!0),{user:n,profile:i}=U(),l=async()=>{if(!n)return t([]),void r(!1);try{r(!0);const e=await L.getUserPermissionsList();t(e)}catch(e){t([])}finally{r(!1)}};e.useEffect(()=>{l()},[n]);const o=e=>!!i?.role&&(Array.isArray(e)?e.includes(i.role):i.role===e),c=o(["admin","super_admin"]),d=o(["moderator","admin","super_admin"]),m=o("super_admin");return{permissions:s,hasPermission:e=>s.includes(e),hasAnyPermission:e=>e.some(e=>s.includes(e)),hasAllPermissions:e=>e.every(e=>s.includes(e)),hasRole:o,isAdmin:c,isModerator:d,isSuperAdmin:m,loading:a,refetch:l}},O=()=>{const{profile:e}=U();return{canAccessAdmin:()=>e?.role&&["admin","super_admin"].includes(e.role),canAccessModerator:()=>e?.role&&["moderator","admin","super_admin"].includes(e.role),canManageUsers:()=>e?.role&&["admin","super_admin"].includes(e.role),canManageSystem:()=>"super_admin"===e?.role,userRole:e?.role||"user"}},k={DOCUMENTS_CREATE:"documents.create",DOCUMENTS_READ:"documents.read",DOCUMENTS_UPDATE:"documents.update",DOCUMENTS_DELETE:"documents.delete",DOCUMENTS_READ_ALL:"documents.read_all",TEMPLATES_CREATE:"templates.create",TEMPLATES_READ:"templates.read",TEMPLATES_UPDATE:"templates.update",TEMPLATES_DELETE:"templates.delete",TEMPLATES_MODERATE:"templates.moderate",TEMPLATES_MANAGE:"templates.manage",LAW_FIRMS_CREATE:"law_firms.create",LAW_FIRMS_READ:"law_firms.read",LAW_FIRMS_UPDATE:"law_firms.update",LAW_FIRMS_DELETE:"law_firms.delete",LAW_FIRMS_VERIFY:"law_firms.verify",LAW_FIRMS_MODERATE_REVIEWS:"law_firms.moderate_reviews",USERS_CREATE:"users.create",USERS_READ:"users.read",USERS_UPDATE:"users.update",USERS_DELETE:"users.delete",USERS_MANAGE_ROLES:"users.manage_roles",USERS_MANAGE_PERMISSIONS:"users.manage_permissions",SYSTEM_ANALYTICS:"system.analytics",SYSTEM_MONITORING:"system.monitoring",SYSTEM_AUDIT_LOGS:"system.audit_logs",SYSTEM_SETTINGS:"system.settings"};export{k as P,F as T,O as a,L as r,C as u};
