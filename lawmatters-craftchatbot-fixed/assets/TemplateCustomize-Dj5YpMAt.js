import{aH as e,u as s,r as a,j as t,b5 as l,aI as i,bE as r,b0 as n,bO as c,aU as m,w as o,F as d}from"./react-vendor-SE0pM8Ra.js";import{ac as x,ad as h,C as u,o as j,B as p,ae as f,h as g,u as v,v as N,z as b,a0 as w,L as y,M as k,I as C,a1 as S,A as E,E as L,G as z,H as $,K as F,p as _}from"./ai-services-C7T4cFUa.js";import{supabase as T}from"./supabase-Cfql4b7O.js";import"./ui-components-ByoYm48K.js";import"./data-fetching-De8LKKym.js";import"./vendor-CrSvAuNw.js";import"./ocr-worker-Ehk6BbiK.js";import"./pdf-worker-CdhgQTyu.js";import"./utilities-CJeqyZZO.js";import"./forms-Mu2Tem6y.js";function O(){const{slug:O}=e(),H=s(),[P,D]=a.useState(null),[I,U]=a.useState(null),[B,M]=a.useState(!0),[q,V]=a.useState(!1),[R,A]=a.useState(!1),[G,K]=a.useState(null),[X,J]=a.useState({}),[Q,W]=a.useState({}),[Y,Z]=a.useState(!1),[ee,se]=a.useState("");a.useEffect(()=>{O&&ae(O)},[O]);const ae=async e=>{try{M(!0);const s=await x.getTemplate(e);if(!s)return void K("Template not found");D(s);const a={};s.fields.forEach(e=>{void 0!==e.defaultValue&&(a[e.name]=e.defaultValue)}),J(a),await x.trackEvent(s.id,"customization_started",{source:"customize_page",access_level:s.accessLevel})}catch(s){K(s instanceof Error?s.message:"Failed to load template")}finally{M(!1)}},te=()=>{if(!P)return!1;const e={};return P.fields.forEach(s=>{const a=((e,s)=>{if(e.required&&(!s||""===s.toString().trim()))return`${e.label} is required`;if(s&&e.validation){const a=e.validation;if(a.minLength&&s.toString().length<a.minLength)return`${e.label} must be at least ${a.minLength} characters`;if(a.maxLength&&s.toString().length>a.maxLength)return`${e.label} must be no more than ${a.maxLength} characters`;if(a.pattern&&!new RegExp(a.pattern).test(s.toString()))return`${e.label} format is invalid`;if("number"===e.type){const t=Number(s);if(a.min&&t<a.min)return`${e.label} must be at least ${a.min}`;if(a.max&&t>a.max)return`${e.label} must be no more than ${a.max}`}}return null})(s,X[s.name]);a&&(e[s.name]=a)}),W(e),0===Object.keys(e).length},le=(e,s)=>{J(a=>({...a,[e]:s})),Q[e]&&W(s=>{const a={...s};return delete a[e],a})},ie=async(e="pdf")=>{if(P&&I)try{A(!0);const{data:s,error:a}=await T.functions.invoke("template-document-generator",{body:{customizationId:I.id,format:e,templateData:{title:P.title,content:P.content.template||"",customFields:X}}});if(a)throw new Error(a.message||"Failed to generate document");const t=document.createElement("a");t.href=s.downloadUrl,t.download=`${P.title.replace(/[^a-z0-9]/gi,"_").toLowerCase()}.${e}`,document.body.appendChild(t),t.click(),document.body.removeChild(t),await x.recordDownload(P.id,I.id,e)}catch(s){K(s instanceof Error?s.message:"Failed to download document")}finally{A(!1)}},re=e=>{const s=X[e.name]||"",a=Q[e.name],l={id:e.id,value:s,onChange:s=>le(e.name,s.target.value),placeholder:e.placeholder,className:a?"border-red-500":""};switch(e.type){case"textarea":return t.jsx(_,{...l,rows:4});case"select":return t.jsxs(E,{value:s,onValueChange:s=>le(e.name,s),children:[t.jsx(L,{className:a?"border-red-500":"",children:t.jsx(z,{placeholder:e.placeholder})}),t.jsx($,{children:e.options?.map(e=>t.jsx(F,{value:e.value,children:e.label},e.value))})]});case"checkbox":return t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(S,{id:e.id,checked:!0===s,onCheckedChange:s=>le(e.name,s)}),t.jsx(w,{htmlFor:e.id,children:e.label})]});case"number":return t.jsx(C,{...l,type:"number",min:e.validation?.min,max:e.validation?.max,onChange:s=>le(e.name,Number(s.target.value))});case"date":return t.jsx(C,{...l,type:"date"});case"email":return t.jsx(C,{...l,type:"email"});case"phone":return t.jsx(C,{...l,type:"tel"});default:return t.jsx(C,{...l,type:"text"})}};return B?t.jsx("div",{className:"min-h-screen bg-gray-50",children:t.jsx("div",{className:"container mx-auto px-4 py-8",children:t.jsxs("div",{className:"max-w-4xl mx-auto space-y-8",children:[t.jsx(h,{className:"h-8 w-32"}),t.jsxs("div",{className:"grid lg:grid-cols-2 gap-8",children:[t.jsxs("div",{className:"space-y-6",children:[t.jsx(h,{className:"h-64 w-full"}),t.jsx(h,{className:"h-32 w-full"})]}),t.jsx("div",{className:"space-y-6",children:t.jsx(h,{className:"h-48 w-full"})})]})]})})}):G||!P?t.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:t.jsx(u,{className:"w-full max-w-md",children:t.jsxs(j,{className:"p-8 text-center",children:[t.jsx(l,{className:"h-12 w-12 text-red-500 mx-auto mb-4"}),t.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Unable to Load Template"}),t.jsx("p",{className:"text-gray-600 mb-6",children:G||"The template you're trying to customize is not available."}),t.jsx(p,{onClick:()=>H(f.templateBrowser),children:"Browse Templates"})]})})}):t.jsx("div",{className:"min-h-screen bg-gray-50",children:t.jsx("div",{className:"container mx-auto px-4 py-8",children:t.jsxs("div",{className:"max-w-6xl mx-auto",children:[t.jsxs("div",{className:"flex items-center justify-between mb-8",children:[t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsxs(p,{variant:"ghost",size:"sm",onClick:()=>H(`${f.templatePreview}/${P.slug}`),children:[t.jsx(i,{className:"h-4 w-4 mr-2"}),"Back to Preview"]}),t.jsxs("div",{children:[t.jsxs("h1",{className:"text-2xl font-bold text-gray-900",children:["Customize: ",P.title]}),t.jsx("p",{className:"text-gray-600",children:"Fill in the fields below to customize your document"})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(g,{variant:"outline",children:P.category?.name}),"public"!==P.accessLevel&&t.jsx(g,{variant:"secondary",children:P.accessLevel})]})]}),t.jsxs("div",{className:"grid lg:grid-cols-2 gap-8",children:[t.jsxs("div",{className:"space-y-6",children:[t.jsxs(u,{children:[t.jsxs(v,{children:[t.jsxs(N,{className:"flex items-center gap-2",children:[t.jsx(r,{className:"h-5 w-5"}),"Document Fields"]}),t.jsx(b,{children:"Complete the form below to customize your document"})]}),t.jsx(j,{className:"space-y-6",children:P.fields.map(e=>t.jsxs("div",{className:"space-y-2",children:[t.jsxs(w,{htmlFor:e.id,className:"flex items-center gap-2",children:[e.label,e.required&&t.jsx("span",{className:"text-red-500",children:"*"})]}),re(e),e.helpText&&t.jsx("p",{className:"text-xs text-gray-500",children:e.helpText}),Q[e.name]&&t.jsx("p",{className:"text-xs text-red-500",children:Q[e.name]})]},e.id))})]}),t.jsx(u,{children:t.jsxs(j,{className:"p-6",children:[t.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[t.jsxs(p,{onClick:async()=>{if(P&&te())try{if(V(!0),I){const e=await x.updateCustomization(I.id,{customFields:X});U(e)}else{const e=crypto.randomUUID(),s=await x.createCustomization(P.id,X,void 0,e);U(s)}await x.trackEvent(P.id,"customization_saved",{fields_filled:Object.keys(X).length,completion_rate:Object.keys(X).length/P.fields.length*100})}catch(e){K(e instanceof Error?e.message:"Failed to save customization")}finally{V(!1)}},disabled:q,className:"flex-1",children:[q?t.jsx(n,{className:"h-4 w-4 mr-2 animate-spin"}):t.jsx(c,{className:"h-4 w-4 mr-2"}),"Save Progress"]}),t.jsxs(p,{variant:"outline",onClick:async()=>{if(P&&te())try{A(!0);let e=P.content.template||"";Object.entries(X).forEach(([s,a])=>{const t=new RegExp(`{{${s}}}`,"g");e=e.replace(t,a?.toString()||"")}),se(e),Z(!0),await x.trackEvent(P.id,"preview_generated",{fields_filled:Object.keys(X).length})}catch(e){K(e instanceof Error?e.message:"Failed to generate preview")}finally{A(!1)}},disabled:R,className:"flex-1",children:[R?t.jsx(n,{className:"h-4 w-4 mr-2 animate-spin"}):t.jsx(m,{className:"h-4 w-4 mr-2"}),"Preview"]}),t.jsxs("div",{className:"flex gap-2 flex-1",children:[t.jsxs(p,{variant:"outline",onClick:()=>ie("pdf"),disabled:!I||R,className:"flex-1",children:[t.jsx(o,{className:"h-4 w-4 mr-2"}),"PDF"]}),t.jsxs(p,{variant:"outline",onClick:()=>ie("docx"),disabled:!I||R,className:"flex-1",children:[t.jsx(o,{className:"h-4 w-4 mr-2"}),"DOCX"]}),t.jsxs(p,{variant:"outline",onClick:()=>ie("html"),disabled:!I||R,className:"flex-1",children:[t.jsx(o,{className:"h-4 w-4 mr-2"}),"HTML"]})]})]}),Object.keys(Q).length>0&&t.jsxs(y,{className:"mt-4",children:[t.jsx(l,{className:"h-4 w-4"}),t.jsx(k,{children:"Please fix the validation errors above before proceeding."})]})]})})]}),t.jsx("div",{className:"space-y-6",children:t.jsxs(u,{className:"sticky top-6",children:[t.jsxs(v,{children:[t.jsxs(N,{className:"flex items-center gap-2",children:[t.jsx(d,{className:"h-5 w-5"}),"Live Preview"]}),t.jsx(b,{children:"See how your document will look as you fill in the fields"})]}),t.jsx(j,{children:Y&&ee?t.jsx("div",{className:"prose max-w-none border rounded-lg p-4 bg-white min-h-96 text-sm",dangerouslySetInnerHTML:{__html:ee}}):P.previewHtml?t.jsx("div",{className:"prose max-w-none border rounded-lg p-4 bg-white min-h-96 text-sm opacity-60",dangerouslySetInnerHTML:{__html:P.previewHtml}}):t.jsx("div",{className:"border rounded-lg p-8 bg-white min-h-96 flex items-center justify-center text-gray-500",children:t.jsxs("div",{className:"text-center",children:[t.jsx(d,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),t.jsx("p",{children:"Fill in the fields to see your customized document"})]})})})]})})]})]})})})}export{O as default};
