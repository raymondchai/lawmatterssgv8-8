import{bR as A,bS as F,bT as h,r as l}from"./react-vendor-DgOuH3B5.js";import{supabase as f}from"./supabase-B5_W4sir.js";import{J as m}from"./vendor-DXfpcdns.js";class v{async getDocumentAnnotations(e){const{data:t,error:s}=await f.from("document_annotations").select("*").eq("document_id",e).order("created_at",{ascending:!0});if(s)throw new Error(`Failed to fetch annotations: ${s.message}`);return t||[]}async createAnnotation(e){const{data:t}=await f.auth.getUser();if(!t.user)throw new Error("User not authenticated");const{data:s,error:o}=await f.from("document_annotations").insert({...e,user_id:t.user.id,is_resolved:!1}).select().single();if(o)throw new Error(`Failed to create annotation: ${o.message}`);return s}async updateAnnotation(e,t){const{data:s,error:o}=await f.from("document_annotations").update(t).eq("id",e).select().single();if(o)throw new Error(`Failed to update annotation: ${o.message}`);return s}async deleteAnnotation(e){const{error:t}=await f.from("document_annotations").delete().eq("id",e);if(t)throw new Error(`Failed to delete annotation: ${t.message}`)}subscribeToAnnotations(e,t){return f.channel(`annotations:${e}`).on("postgres_changes",{event:"*",schema:"public",table:"document_annotations",filter:`document_id=eq.${e}`},t).subscribe()}async getDocumentCollaborators(e){const{data:t,error:s}=await f.from("annotation_collaborators").select(`
        *,
        user:profiles!annotation_collaborators_user_id_fkey(id, email, first_name, last_name),
        invited_by_user:profiles!annotation_collaborators_invited_by_fkey(id, email, first_name, last_name)
      `).eq("document_id",e);if(s)throw new Error(`Failed to fetch collaborators: ${s.message}`);return t||[]}async inviteCollaborator(e){var y;const{data:t,error:s}=await f.from("profiles").select("id").eq("email",e.email).single();if(s||!t)throw new Error("User not found with this email address");const{data:o,error:r}=await f.from("annotation_collaborators").insert({document_id:e.document_id,user_id:t.id,permission_level:e.permission_level,invited_by:(y=(await f.auth.getUser()).data.user)==null?void 0:y.id}).select().single();if(r)throw new Error(`Failed to invite collaborator: ${r.message}`);return o}async removeCollaborator(e){const{error:t}=await f.from("annotation_collaborators").delete().eq("id",e);if(t)throw new Error(`Failed to remove collaborator: ${t.message}`)}async updateCollaboratorPermission(e,t){const{data:s,error:o}=await f.from("annotation_collaborators").update({permission_level:t}).eq("id",e).select().single();if(o)throw new Error(`Failed to update permission: ${o.message}`);return s}async createReply(e){const{data:t}=await f.auth.getUser();if(!t.user)throw new Error("User not authenticated");const{data:s,error:o}=await f.from("annotation_replies").insert({...e,user_id:t.user.id}).select(`
        *,
        user:profiles!annotation_replies_user_id_fkey(id, email, first_name, last_name)
      `).single();if(o)throw new Error(`Failed to create reply: ${o.message}`);return s}}const _=new v;function $(d,e){const t=A(),{data:s=[],isLoading:o,error:r,refetch:y}=F({queryKey:["annotations",d,e],queryFn:()=>_.getDocumentAnnotations(d,e),enabled:!!d,staleTime:3e4}),g=h({mutationFn:_.createAnnotation,onSuccess:n=>{t.setQueryData(["annotations",d,e],(w=[])=>[...w,n]),m.success("Annotation created successfully")},onError:n=>{m.error(`Failed to create annotation: ${n.message}`)}}),a=h({mutationFn:({id:n,data:w})=>_.updateAnnotation(n,w),onSuccess:n=>{t.setQueryData(["annotations",d,e],(w=[])=>w.map(b=>b.id===n.id?n:b)),m.success("Annotation updated successfully")},onError:n=>{m.error(`Failed to update annotation: ${n.message}`)}}),c=h({mutationFn:_.deleteAnnotation,onSuccess:(n,w)=>{t.setQueryData(["annotations",d,e],(b=[])=>b.filter(C=>C.id!==w)),m.success("Annotation deleted successfully")},onError:n=>{m.error(`Failed to delete annotation: ${n.message}`)}}),u=l.useCallback(n=>g.mutateAsync(n),[g]),p=l.useCallback((n,w)=>a.mutateAsync({id:n,data:w}),[a]),i=l.useCallback(n=>c.mutateAsync(n),[c]);return{annotations:s,isLoading:o,error:r,refetch:y,createAnnotation:u,updateAnnotation:p,deleteAnnotation:i,isCreating:g.isPending,isUpdating:a.isPending,isDeleting:c.isPending}}function k(d){const e=A(),t=h({mutationFn:_.addComment,onSuccess:a=>{e.setQueriesData({queryKey:["annotations"]},(c=[])=>c.map(u=>u.id===d?{...u,comments:[...u.comments||[],a]}:u)),m.success("Comment added successfully")},onError:a=>{m.error(`Failed to add comment: ${a.message}`)}}),s=h({mutationFn:({id:a,content:c})=>_.updateComment(a,c),onSuccess:a=>{e.setQueriesData({queryKey:["annotations"]},(c=[])=>c.map(u=>{var p;return u.id===d?{...u,comments:((p=u.comments)==null?void 0:p.map(i=>i.id===a.id?a:i))||[]}:u})),m.success("Comment updated successfully")},onError:a=>{m.error(`Failed to update comment: ${a.message}`)}}),o=h({mutationFn:_.deleteComment,onSuccess:(a,c)=>{e.setQueriesData({queryKey:["annotations"]},(u=[])=>u.map(p=>{var i;return p.id===d?{...p,comments:((i=p.comments)==null?void 0:i.filter(n=>n.id!==c))||[]}:p})),m.success("Comment deleted successfully")},onError:a=>{m.error(`Failed to delete comment: ${a.message}`)}}),r=l.useCallback(a=>t.mutateAsync(a),[t]),y=l.useCallback((a,c)=>s.mutateAsync({id:a,content:c}),[s]),g=l.useCallback(a=>o.mutateAsync(a),[o]);return{addComment:r,updateComment:y,deleteComment:g,isAddingComment:t.isPending,isUpdatingComment:s.isPending,isDeletingComment:o.isPending}}function q(){const d=A(),e=h({mutationFn:_.shareAnnotation,onSuccess:r=>{d.setQueriesData({queryKey:["annotations"]},(y=[])=>y.map(g=>g.id===r.annotationId?{...g,shares:[...g.shares||[],r]}:g)),m.success("Annotation shared successfully")},onError:r=>{m.error(`Failed to share annotation: ${r.message}`)}}),t=h({mutationFn:_.removeShare,onSuccess:(r,y)=>{d.setQueriesData({queryKey:["annotations"]},(g=[])=>g.map(a=>{var c;return{...a,shares:((c=a.shares)==null?void 0:c.filter(u=>u.id!==y))||[]}})),m.success("Share removed successfully")},onError:r=>{m.error(`Failed to remove share: ${r.message}`)}}),s=l.useCallback(r=>e.mutateAsync(r),[e]),o=l.useCallback(r=>t.mutateAsync(r),[t]);return{shareAnnotation:s,removeShare:o,isSharing:e.isPending,isRemoving:t.isPending}}function P(){const[d,e]=l.useState({annotation:null,isEditing:!1}),[t,s]=l.useState({type:"highlight",color:"yellow",isActive:!1}),[o,r]=l.useState({isDrawing:!1,currentPath:"",strokeWidth:2,color:"red"}),y=l.useCallback((i,n=!1)=>{e({annotation:i,isEditing:n})},[]),g=l.useCallback((i,n="yellow")=>{s({type:i,color:n,isActive:!0})},[]),a=l.useCallback(()=>{s(i=>({...i,isActive:!1}))},[]),c=l.useCallback((i="red",n=2)=>{r({isDrawing:!0,currentPath:"",strokeWidth:n,color:i})},[]),u=l.useCallback(i=>{r(n=>({...n,currentPath:i}))},[]),p=l.useCallback(()=>{r(i=>({...i,isDrawing:!1}))},[]);return{selectedAnnotation:d,activeTool:t,drawingState:o,selectAnnotation:y,activateTool:g,deactivateTool:a,startDrawing:c,updateDrawingPath:u,stopDrawing:p}}export{q as a,$ as b,P as c,k as u};
