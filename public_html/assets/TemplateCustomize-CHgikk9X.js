import{aC as te,u as re,r as i,j as e,b3 as H,aD as ne,bD as le,a_ as M,bN as ie,aR as ce,w as f,F as B}from"./react-vendor-DgOuH3B5.js";import{ab as m,ac as v,C as w,o as b,B as d,ad as V,h as A,u as R,v as U,z as q,a0 as G,L as oe,M as me,I as p,a1 as de,A as xe,E as he,G as ue,H as pe,K as je,p as ge}from"./ai-services-DbCQJDXZ.js";import{supabase as ve}from"./supabase-B5_W4sir.js";import"./ui-components-BA32w1ww.js";import"./data-fetching-C9PAuT9r.js";import"./vendor-DXfpcdns.js";import"./ocr-worker-CHC1Ilq1.js";import"./pdf-worker-D8bnToiL.js";import"./utilities-x5TAO4by.js";import"./forms-zYe9FhTN.js";function Le(){var _;const{slug:N}=te(),C=re(),[n,K]=i.useState(null),[o,S]=i.useState(null),[X,k]=i.useState(!0),[E,F]=i.useState(!1),[x,j]=i.useState(!1),[L,h]=i.useState(null),[c,z]=i.useState({}),[u,T]=i.useState({}),[J,Q]=i.useState(!1),[D,W]=i.useState("");i.useEffect(()=>{N&&Y(N)},[N]);const Y=async s=>{try{k(!0);const a=await m.getTemplate(s);if(!a){h("Template not found");return}K(a);const t={};a.fields.forEach(r=>{r.defaultValue!==void 0&&(t[r.name]=r.defaultValue)}),z(t),await m.trackEvent(a.id,"customization_started",{source:"customize_page",access_level:a.accessLevel})}catch(a){h(a instanceof Error?a.message:"Failed to load template")}finally{k(!1)}},Z=(s,a)=>{if(s.required&&(!a||a.toString().trim()===""))return`${s.label} is required`;if(a&&s.validation){const t=s.validation;if(t.minLength&&a.toString().length<t.minLength)return`${s.label} must be at least ${t.minLength} characters`;if(t.maxLength&&a.toString().length>t.maxLength)return`${s.label} must be no more than ${t.maxLength} characters`;if(t.pattern&&!new RegExp(t.pattern).test(a.toString()))return`${s.label} format is invalid`;if(s.type==="number"){const r=Number(a);if(t.min&&r<t.min)return`${s.label} must be at least ${t.min}`;if(t.max&&r>t.max)return`${s.label} must be no more than ${t.max}`}}return null},$=()=>{if(!n)return!1;const s={};return n.fields.forEach(a=>{const t=Z(a,c[a.name]);t&&(s[a.name]=t)}),T(s),Object.keys(s).length===0},g=(s,a)=>{z(t=>({...t,[s]:a})),u[s]&&T(t=>{const r={...t};return delete r[s],r})},ee=async()=>{if(!(!n||!$()))try{if(F(!0),o){const s=await m.updateCustomization(o.id,{customFields:c});S(s)}else{const s=crypto.randomUUID(),a=await m.createCustomization(n.id,c,void 0,s);S(a)}await m.trackEvent(n.id,"customization_saved",{fields_filled:Object.keys(c).length,completion_rate:Object.keys(c).length/n.fields.length*100})}catch(s){h(s instanceof Error?s.message:"Failed to save customization")}finally{F(!1)}},se=async()=>{if(!(!n||!$()))try{j(!0);let s=n.content.template||"";Object.entries(c).forEach(([a,t])=>{const r=new RegExp(`{{${a}}}`,"g");s=s.replace(r,(t==null?void 0:t.toString())||"")}),W(s),Q(!0),await m.trackEvent(n.id,"preview_generated",{fields_filled:Object.keys(c).length})}catch(s){h(s instanceof Error?s.message:"Failed to generate preview")}finally{j(!1)}},y=async(s="pdf")=>{if(!(!n||!o))try{j(!0);const{data:a,error:t}=await ve.functions.invoke("template-document-generator",{body:{customizationId:o.id,format:s,templateData:{title:n.title,content:n.content.template||"",customFields:c}}});if(t)throw new Error(t.message||"Failed to generate document");const r=document.createElement("a");r.href=a.downloadUrl,r.download=`${n.title.replace(/[^a-z0-9]/gi,"_").toLowerCase()}.${s}`,document.body.appendChild(r),r.click(),document.body.removeChild(r),await m.recordDownload(n.id,o.id,s)}catch(a){h(a instanceof Error?a.message:"Failed to download document")}finally{j(!1)}},ae=s=>{var P,I,O;const a=c[s.name]||"",t=u[s.name],r={id:s.id,value:a,onChange:l=>g(s.name,l.target.value),placeholder:s.placeholder,className:t?"border-red-500":""};switch(s.type){case"textarea":return e.jsx(ge,{...r,rows:4});case"select":return e.jsxs(xe,{value:a,onValueChange:l=>g(s.name,l),children:[e.jsx(he,{className:t?"border-red-500":"",children:e.jsx(ue,{placeholder:s.placeholder})}),e.jsx(pe,{children:(P=s.options)==null?void 0:P.map(l=>e.jsx(je,{value:l.value,children:l.label},l.value))})]});case"checkbox":return e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(de,{id:s.id,checked:a===!0,onCheckedChange:l=>g(s.name,l)}),e.jsx(G,{htmlFor:s.id,children:s.label})]});case"number":return e.jsx(p,{...r,type:"number",min:(I=s.validation)==null?void 0:I.min,max:(O=s.validation)==null?void 0:O.max,onChange:l=>g(s.name,Number(l.target.value))});case"date":return e.jsx(p,{...r,type:"date"});case"email":return e.jsx(p,{...r,type:"email"});case"phone":return e.jsx(p,{...r,type:"tel"});default:return e.jsx(p,{...r,type:"text"})}};return X?e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsxs("div",{className:"max-w-4xl mx-auto space-y-8",children:[e.jsx(v,{className:"h-8 w-32"}),e.jsxs("div",{className:"grid lg:grid-cols-2 gap-8",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsx(v,{className:"h-64 w-full"}),e.jsx(v,{className:"h-32 w-full"})]}),e.jsx("div",{className:"space-y-6",children:e.jsx(v,{className:"h-48 w-full"})})]})]})})}):L||!n?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsx(w,{className:"w-full max-w-md",children:e.jsxs(b,{className:"p-8 text-center",children:[e.jsx(H,{className:"h-12 w-12 text-red-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Unable to Load Template"}),e.jsx("p",{className:"text-gray-600 mb-6",children:L||"The template you're trying to customize is not available."}),e.jsx(d,{onClick:()=>C(V.templateBrowser),children:"Browse Templates"})]})})}):e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(d,{variant:"ghost",size:"sm",onClick:()=>C(`${V.templatePreview}/${n.slug}`),children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),"Back to Preview"]}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold text-gray-900",children:["Customize: ",n.title]}),e.jsx("p",{className:"text-gray-600",children:"Fill in the fields below to customize your document"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(A,{variant:"outline",children:(_=n.category)==null?void 0:_.name}),n.accessLevel!=="public"&&e.jsx(A,{variant:"secondary",children:n.accessLevel})]})]}),e.jsxs("div",{className:"grid lg:grid-cols-2 gap-8",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs(w,{children:[e.jsxs(R,{children:[e.jsxs(U,{className:"flex items-center gap-2",children:[e.jsx(le,{className:"h-5 w-5"}),"Document Fields"]}),e.jsx(q,{children:"Complete the form below to customize your document"})]}),e.jsx(b,{className:"space-y-6",children:n.fields.map(s=>e.jsxs("div",{className:"space-y-2",children:[e.jsxs(G,{htmlFor:s.id,className:"flex items-center gap-2",children:[s.label,s.required&&e.jsx("span",{className:"text-red-500",children:"*"})]}),ae(s),s.helpText&&e.jsx("p",{className:"text-xs text-gray-500",children:s.helpText}),u[s.name]&&e.jsx("p",{className:"text-xs text-red-500",children:u[s.name]})]},s.id))})]}),e.jsx(w,{children:e.jsxs(b,{className:"p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsxs(d,{onClick:ee,disabled:E,className:"flex-1",children:[E?e.jsx(M,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(ie,{className:"h-4 w-4 mr-2"}),"Save Progress"]}),e.jsxs(d,{variant:"outline",onClick:se,disabled:x,className:"flex-1",children:[x?e.jsx(M,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(ce,{className:"h-4 w-4 mr-2"}),"Preview"]}),e.jsxs("div",{className:"flex gap-2 flex-1",children:[e.jsxs(d,{variant:"outline",onClick:()=>y("pdf"),disabled:!o||x,className:"flex-1",children:[e.jsx(f,{className:"h-4 w-4 mr-2"}),"PDF"]}),e.jsxs(d,{variant:"outline",onClick:()=>y("docx"),disabled:!o||x,className:"flex-1",children:[e.jsx(f,{className:"h-4 w-4 mr-2"}),"DOCX"]}),e.jsxs(d,{variant:"outline",onClick:()=>y("html"),disabled:!o||x,className:"flex-1",children:[e.jsx(f,{className:"h-4 w-4 mr-2"}),"HTML"]})]})]}),Object.keys(u).length>0&&e.jsxs(oe,{className:"mt-4",children:[e.jsx(H,{className:"h-4 w-4"}),e.jsx(me,{children:"Please fix the validation errors above before proceeding."})]})]})})]}),e.jsx("div",{className:"space-y-6",children:e.jsxs(w,{className:"sticky top-6",children:[e.jsxs(R,{children:[e.jsxs(U,{className:"flex items-center gap-2",children:[e.jsx(B,{className:"h-5 w-5"}),"Live Preview"]}),e.jsx(q,{children:"See how your document will look as you fill in the fields"})]}),e.jsx(b,{children:J&&D?e.jsx("div",{className:"prose max-w-none border rounded-lg p-4 bg-white min-h-96 text-sm",dangerouslySetInnerHTML:{__html:D}}):n.previewHtml?e.jsx("div",{className:"prose max-w-none border rounded-lg p-4 bg-white min-h-96 text-sm opacity-60",dangerouslySetInnerHTML:{__html:n.previewHtml}}):e.jsx("div",{className:"border rounded-lg p-8 bg-white min-h-96 flex items-center justify-center text-gray-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx(B,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),e.jsx("p",{children:"Fill in the fields to see your customized document"})]})})})]})})]})]})})})}export{Le as default};
