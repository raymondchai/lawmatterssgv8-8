import{a as e,R as t}from"./react-vendor-92YuBQvb.js";import{c as a,a6 as r,bh as s,am as n,an as l,Z as o,Q as c,au as i,at as m,ad as d,ae as u,af as g,ag as p,ai as E,B as w,ar as f,z as h,A as _,W as y,X as v,Y as N,$ as x,a0 as T,a1 as S,aQ as R,ab as A,aX as b,K as D,be as U,a7 as M}from"./index-BheJWwZO.js";import{M as P}from"./minus-BnNHPIMG.js";
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const I=a("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]),F=a("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]);
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const k=new class TemplateAnalyticsService{async getDashboardAnalytics(e){try{const t=e?.end||new Date,a=e?.start||new Date(Date.now()-2592e6),[r,s,n,l]=await Promise.all([this.getTotalTemplates(),this.getTotalDownloads(),this.getTotalRevenue(),this.getTotalUsers()]),[o,c,i]=await Promise.all([this.getDownloadsInPeriod(a,t),this.getRevenueInPeriod(a,t),this.getNewUsersInPeriod(a,t)]),[m,d,u,g,p,E]=await Promise.all([this.getPopularTemplates(10),this.getCategoryStats(),this.getUserEngagementMetrics(a,t),this.getRevenueBreakdown(),this.getDownloadTrends(a,t),this.getFormatStats()]);return{totalTemplates:r,totalDownloads:s,totalRevenue:n,totalUsers:l,downloadsThisMonth:o,revenueThisMonth:c,newUsersThisMonth:i,popularTemplates:m,categoryStats:d,userEngagement:u,revenueBreakdown:g,downloadTrends:p,formatStats:E}}catch(t){throw console.error("Error fetching dashboard analytics:",t),new Error("Failed to fetch analytics data")}}async getTemplatePerformance(e){try{let t=r.from("templates").select("\n          id,\n          title,\n          download_count,\n          rating_average,\n          updated_at,\n          template_analytics!inner(event_type),\n          template_downloads!inner(format),\n          template_customizations!inner(id)\n        ");e&&(t=t.eq("id",e));const{data:a,error:s}=await t;if(s)throw s;return a.map(e=>{const t=e.template_analytics?.filter(e=>"template_view"===e.event_type).length||0,a=e.template_customizations?.length||0,r=e.download_count||0;return{templateId:e.id,title:e.title,views:t,customizations:a,downloads:r,revenue:50*r,rating:e.rating_average||0,conversionRate:t>0?r/t*100:0,lastUpdated:new Date(e.updated_at)}})}catch(t){throw console.error("Error fetching template performance:",t),new Error("Failed to fetch template performance data")}}async getRevenueAnalytics(){try{const e=await this.getTotalRevenue(),t=await this.getRevenueInPeriod(new Date(Date.now()-2592e6),new Date),a=await this.getRevenueInPeriod(new Date(Date.now()-5184e6),new Date(Date.now()-2592e6)),r=a>0?(t-a)/a*100:0,s=await this.getTopRevenueTemplates(5);return{totalRevenue:e,monthlyRevenue:t,revenueGrowth:r,averageOrderValue:await this.getAverageOrderValue(),topRevenueTemplates:s}}catch(e){throw console.error("Error fetching revenue analytics:",e),new Error("Failed to fetch revenue analytics")}}async getTotalTemplates(){const{count:e,error:t}=await r.from("templates").select("*",{count:"exact",head:!0}).eq("is_active",!0);if(t)throw t;return e||0}async getTotalDownloads(){const{count:e,error:t}=await r.from("template_downloads").select("*",{count:"exact",head:!0});if(t)throw t;return e||0}async getTotalRevenue(){return 25*await this.getTotalDownloads()}async getTotalUsers(){const{count:e,error:t}=await r.from("profiles").select("*",{count:"exact",head:!0});if(t)throw t;return e||0}async getDownloadsInPeriod(e,t){const{count:a,error:s}=await r.from("template_downloads").select("*",{count:"exact",head:!0}).gte("created_at",e.toISOString()).lte("created_at",t.toISOString());if(s)throw s;return a||0}async getRevenueInPeriod(e,t){return 25*await this.getDownloadsInPeriod(e,t)}async getNewUsersInPeriod(e,t){const{count:a,error:s}=await r.from("profiles").select("*",{count:"exact",head:!0}).gte("created_at",e.toISOString()).lte("created_at",t.toISOString());if(s)throw s;return a||0}async getPopularTemplates(e=10){const{data:t,error:a}=await r.from("templates").select("\n        id,\n        title,\n        download_count,\n        price_sgd,\n        categories(name)\n      ").eq("is_active",!0).order("download_count",{ascending:!1}).limit(e);if(a)throw a;return t.map(e=>({id:e.id,title:e.title,downloadCount:e.download_count||0,revenue:(e.download_count||0)*(e.price_sgd||0),category:e.categories?.name||"Uncategorized"}))}async getCategoryStats(){const{data:e,error:t}=await r.from("template_categories").select("\n        id,\n        name,\n        templates(id, download_count, price_sgd)\n      ");if(t)throw t;return e.map(e=>({categoryId:e.id,categoryName:e.name,templateCount:e.templates?.length||0,downloadCount:e.templates?.reduce((e,t)=>e+(t.download_count||0),0)||0,revenue:e.templates?.reduce((e,t)=>e+(t.download_count||0)*(t.price_sgd||0),0)||0}))}async getUserEngagementMetrics(e,t){return{averageSessionDuration:180,bounceRate:35.5,conversionRate:12.8,repeatUsers:45}}async getRevenueBreakdown(){return{public:0,premium:15e3,enterprise:8500}}async getDownloadTrends(e,t){const a=[],r=Math.ceil((t.getTime()-e.getTime())/864e5);for(let s=0;s<r;s++){const t=new Date(e.getTime()+24*s*60*60*1e3);a.push({date:t.toISOString().split("T")[0],downloads:Math.floor(50*Math.random())+10,revenue:Math.floor(1e3*Math.random())+200})}return a}async getFormatStats(){const{data:e,error:t}=await r.from("template_downloads").select("format");if(t)throw t;const a=e.reduce((e,t)=>(e[t.format]=(e[t.format]||0)+1,e),{}),s=Object.values(a).reduce((e,t)=>e+t,0);return Object.entries(a).map(([e,t])=>({format:e,count:t,percentage:s>0?t/s*100:0}))}async getTopRevenueTemplates(e=5){const{data:t,error:a}=await r.from("templates").select("\n        id,\n        title,\n        download_count,\n        price_sgd\n      ").eq("is_active",!0).order("download_count",{ascending:!1}).limit(e);if(a)throw a;return t.map(e=>({templateId:e.id,title:e.title,revenue:(e.download_count||0)*(e.price_sgd||0),downloads:e.download_count||0}))}async getAverageOrderValue(){const e=await this.getTotalRevenue(),t=await this.getTotalDownloads();return t>0?e/t:0}},TemplateAnalyticsDashboard=({className:a=""})=>{const[r,M]=e.useState(null),[L,O]=e.useState([]),[C,j]=e.useState(null),[q,V]=e.useState(!0),[G,$]=e.useState(null),[W,Y]=e.useState("30d"),[z,B]=e.useState("overview");e.useEffect(()=>{loadAnalyticsData()},[W]);const loadAnalyticsData=async()=>{try{V(!0),$(null);const e=new Date,t=new Date;switch(W){case"7d":t.setDate(e.getDate()-7);break;case"30d":t.setDate(e.getDate()-30);break;case"90d":t.setDate(e.getDate()-90);break;case"1y":t.setFullYear(e.getFullYear()-1)}const[a,r,s]=await Promise.all([k.getDashboardAnalytics({start:t,end:e}),k.getTemplatePerformance(),k.getRevenueAnalytics()]);M(a),O(r),j(s)}catch(e){console.error("Error loading analytics:",e),$(e instanceof Error?e.message:"Failed to load analytics")}finally{V(!1)}},formatCurrency=e=>new Intl.NumberFormat("en-SG",{style:"currency",currency:"SGD"}).format(e),formatNumber=e=>new Intl.NumberFormat("en-SG").format(e),formatPercentage=e=>`${e.toFixed(1)}%`,getTrendIcon=e=>e>0?t.createElement(F,{className:"h-4 w-4 text-green-500"}):e<0?t.createElement(I,{className:"h-4 w-4 text-red-500"}):t.createElement(P,{className:"h-4 w-4 text-gray-500"});if(q)return t.createElement("div",{className:`space-y-6 ${a}`},t.createElement("div",{className:"flex items-center justify-between"},t.createElement(s,{className:"h-8 w-64"}),t.createElement(s,{className:"h-10 w-32"})),t.createElement("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"},[...Array(4)].map((e,a)=>t.createElement(s,{key:a,className:"h-32"}))),t.createElement(s,{className:"h-96"}));if(G||!r)return t.createElement("div",{className:a},t.createElement(n,null,t.createElement(l,null,G||"Failed to load analytics data. Please try again.")));const Q=[{title:"Total Templates",value:formatNumber(r.totalTemplates),change:"+12%",changeValue:12,icon:o,color:"text-blue-600"},{title:"Total Downloads",value:formatNumber(r.totalDownloads),change:"+8.5%",changeValue:8.5,icon:c,color:"text-green-600"},{title:"Total Revenue",value:formatCurrency(r.totalRevenue),change:"+15.2%",changeValue:15.2,icon:i,color:"text-purple-600"},{title:"Active Users",value:formatNumber(r.totalUsers),change:"+6.8%",changeValue:6.8,icon:m,color:"text-orange-600"}];return t.createElement("div",{className:`space-y-6 ${a}`},t.createElement("div",{className:"flex items-center justify-between"},t.createElement("div",null,t.createElement("h2",{className:"text-3xl font-bold text-gray-900"},"Template Analytics"),t.createElement("p",{className:"text-gray-600 mt-1"},"Comprehensive insights into template marketplace performance")),t.createElement("div",{className:"flex items-center gap-3"},t.createElement(d,{value:W,onValueChange:Y},t.createElement(u,{className:"w-32"},t.createElement(g,null)),t.createElement(p,null,t.createElement(E,{value:"7d"},"Last 7 days"),t.createElement(E,{value:"30d"},"Last 30 days"),t.createElement(E,{value:"90d"},"Last 90 days"),t.createElement(E,{value:"1y"},"Last year"))),t.createElement(w,{variant:"outline",onClick:loadAnalyticsData,disabled:q},t.createElement(f,{className:"h-4 w-4 mr-2"}),"Refresh"))),t.createElement("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"},Q.map((e,a)=>t.createElement(h,{key:a},t.createElement(_,{className:"p-6"},t.createElement("div",{className:"flex items-center justify-between"},t.createElement("div",{className:"flex-1"},t.createElement("p",{className:"text-sm font-medium text-gray-600"},e.title),t.createElement("p",{className:"text-2xl font-bold text-gray-900 mt-1"},e.value),t.createElement("div",{className:"flex items-center mt-2"},getTrendIcon(e.changeValue),t.createElement("span",{className:"text-sm ml-1 "+(e.changeValue>0?"text-green-600":e.changeValue<0?"text-red-600":"text-gray-600")},e.change),t.createElement("span",{className:"text-xs text-gray-500 ml-1"},"vs last period"))),t.createElement(e.icon,{className:`h-8 w-8 ${e.color}`})))))),t.createElement(y,{value:z,onValueChange:B},t.createElement(v,{className:"grid w-full grid-cols-4"},t.createElement(N,{value:"overview"},"Overview"),t.createElement(N,{value:"performance"},"Performance"),t.createElement(N,{value:"revenue"},"Revenue"),t.createElement(N,{value:"engagement"},"Engagement")),t.createElement(x,{value:"overview",className:"space-y-6"},t.createElement("div",{className:"grid lg:grid-cols-2 gap-6"},t.createElement(h,null,t.createElement(T,null,t.createElement(S,{className:"flex items-center gap-2"},t.createElement(R,{className:"h-5 w-5"}),"Popular Templates"),t.createElement(A,null,"Top performing templates by downloads")),t.createElement(_,null,t.createElement("div",{className:"space-y-4"},r.popularTemplates.slice(0,5).map((e,a)=>t.createElement("div",{key:e.id,className:"flex items-center justify-between"},t.createElement("div",{className:"flex items-center gap-3"},t.createElement("div",{className:"w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center"},t.createElement("span",{className:"text-sm font-medium text-blue-600"},a+1)),t.createElement("div",null,t.createElement("p",{className:"font-medium text-gray-900"},e.title),t.createElement("p",{className:"text-sm text-gray-500"},e.category))),t.createElement("div",{className:"text-right"},t.createElement("p",{className:"font-medium"},formatNumber(e.downloadCount)),t.createElement("p",{className:"text-sm text-gray-500"},"downloads"))))))),t.createElement(h,null,t.createElement(T,null,t.createElement(S,{className:"flex items-center gap-2"},t.createElement(b,{className:"h-5 w-5"}),"Category Performance"),t.createElement(A,null,"Downloads and revenue by category")),t.createElement(_,null,t.createElement("div",{className:"space-y-4"},r.categoryStats.slice(0,5).map(e=>t.createElement("div",{key:e.categoryId,className:"space-y-2"},t.createElement("div",{className:"flex items-center justify-between"},t.createElement("span",{className:"font-medium"},e.categoryName),t.createElement("span",{className:"text-sm text-gray-500"},formatNumber(e.downloadCount)," downloads")),t.createElement("div",{className:"w-full bg-gray-200 rounded-full h-2"},t.createElement("div",{className:"bg-blue-600 h-2 rounded-full",style:{width:`${Math.min(e.downloadCount/Math.max(...r.categoryStats.map(e=>e.downloadCount))*100,100)}%`}})))))))),t.createElement(h,null,t.createElement(T,null,t.createElement(S,null,"Download Format Preferences"),t.createElement(A,null,"User preferences for document formats")),t.createElement(_,null,t.createElement("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4"},r.formatStats.map(e=>t.createElement("div",{key:e.format,className:"text-center p-4 border rounded-lg"},t.createElement("div",{className:"text-2xl font-bold text-gray-900"},formatPercentage(e.percentage)),t.createElement("div",{className:"text-sm text-gray-600 uppercase tracking-wide"},e.format),t.createElement("div",{className:"text-xs text-gray-500 mt-1"},formatNumber(e.count)," downloads"))))))),t.createElement(x,{value:"performance",className:"space-y-6"},t.createElement(h,null,t.createElement(T,null,t.createElement(S,null,"Template Performance Metrics"),t.createElement(A,null,"Detailed performance analysis for all templates")),t.createElement(_,null,t.createElement("div",{className:"overflow-x-auto"},t.createElement("table",{className:"w-full"},t.createElement("thead",null,t.createElement("tr",{className:"border-b"},t.createElement("th",{className:"text-left p-2"},"Template"),t.createElement("th",{className:"text-right p-2"},"Views"),t.createElement("th",{className:"text-right p-2"},"Downloads"),t.createElement("th",{className:"text-right p-2"},"Conversion"),t.createElement("th",{className:"text-right p-2"},"Revenue"),t.createElement("th",{className:"text-right p-2"},"Rating"))),t.createElement("tbody",null,L.slice(0,10).map(e=>t.createElement("tr",{key:e.templateId,className:"border-b"},t.createElement("td",{className:"p-2"},t.createElement("div",null,t.createElement("p",{className:"font-medium"},e.title),t.createElement("p",{className:"text-xs text-gray-500"},"Updated ",D(e.lastUpdated,{addSuffix:!0})))),t.createElement("td",{className:"text-right p-2"},formatNumber(e.views)),t.createElement("td",{className:"text-right p-2"},formatNumber(e.downloads)),t.createElement("td",{className:"text-right p-2"},formatPercentage(e.conversionRate)),t.createElement("td",{className:"text-right p-2"},formatCurrency(e.revenue)),t.createElement("td",{className:"text-right p-2"},t.createElement("div",{className:"flex items-center justify-end gap-1"},t.createElement(U,{className:"h-4 w-4 text-yellow-400 fill-current"}),e.rating.toFixed(1))))))))))),t.createElement(x,{value:"revenue",className:"space-y-6"},C&&t.createElement(t.Fragment,null,t.createElement("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6"},t.createElement(h,null,t.createElement(_,{className:"p-6"},t.createElement("div",{className:"flex items-center justify-between"},t.createElement("div",null,t.createElement("p",{className:"text-sm font-medium text-gray-600"},"Monthly Revenue"),t.createElement("p",{className:"text-2xl font-bold text-gray-900"},formatCurrency(C.monthlyRevenue)),t.createElement("div",{className:"flex items-center mt-1"},getTrendIcon(C.revenueGrowth),t.createElement("span",{className:"text-sm ml-1 "+(C.revenueGrowth>0?"text-green-600":"text-red-600")},formatPercentage(C.revenueGrowth)))),t.createElement(i,{className:"h-8 w-8 text-green-600"})))),t.createElement(h,null,t.createElement(_,{className:"p-6"},t.createElement("div",{className:"flex items-center justify-between"},t.createElement("div",null,t.createElement("p",{className:"text-sm font-medium text-gray-600"},"Average Order Value"),t.createElement("p",{className:"text-2xl font-bold text-gray-900"},formatCurrency(C.averageOrderValue))),t.createElement(b,{className:"h-8 w-8 text-blue-600"})))),t.createElement(h,null,t.createElement(_,{className:"p-6"},t.createElement("div",{className:"flex items-center justify-between"},t.createElement("div",null,t.createElement("p",{className:"text-sm font-medium text-gray-600"},"Total Revenue"),t.createElement("p",{className:"text-2xl font-bold text-gray-900"},formatCurrency(C.totalRevenue))),t.createElement(R,{className:"h-8 w-8 text-purple-600"}))))),t.createElement(h,null,t.createElement(T,null,t.createElement(S,null,"Top Revenue Generating Templates"),t.createElement(A,null,"Templates contributing most to revenue")),t.createElement(_,null,t.createElement("div",{className:"space-y-4"},C.topRevenueTemplates.map((e,a)=>t.createElement("div",{key:e.templateId,className:"flex items-center justify-between p-4 border rounded-lg"},t.createElement("div",{className:"flex items-center gap-3"},t.createElement("div",{className:"w-8 h-8 bg-green-100 rounded-full flex items-center justify-center"},t.createElement("span",{className:"text-sm font-medium text-green-600"},a+1)),t.createElement("div",null,t.createElement("p",{className:"font-medium text-gray-900"},e.title),t.createElement("p",{className:"text-sm text-gray-500"},formatNumber(e.downloads)," downloads"))),t.createElement("div",{className:"text-right"},t.createElement("p",{className:"font-bold text-green-600"},formatCurrency(e.revenue)))))))))),t.createElement(x,{value:"engagement",className:"space-y-6"},t.createElement("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"},t.createElement(h,null,t.createElement(_,{className:"p-6"},t.createElement("div",{className:"text-center"},t.createElement("p",{className:"text-2xl font-bold text-gray-900"},r.userEngagement.averageSessionDuration,"s"),t.createElement("p",{className:"text-sm text-gray-600"},"Avg Session Duration")))),t.createElement(h,null,t.createElement(_,{className:"p-6"},t.createElement("div",{className:"text-center"},t.createElement("p",{className:"text-2xl font-bold text-gray-900"},formatPercentage(r.userEngagement.bounceRate)),t.createElement("p",{className:"text-sm text-gray-600"},"Bounce Rate")))),t.createElement(h,null,t.createElement(_,{className:"p-6"},t.createElement("div",{className:"text-center"},t.createElement("p",{className:"text-2xl font-bold text-gray-900"},formatPercentage(r.userEngagement.conversionRate)),t.createElement("p",{className:"text-sm text-gray-600"},"Conversion Rate")))),t.createElement(h,null,t.createElement(_,{className:"p-6"},t.createElement("div",{className:"text-center"},t.createElement("p",{className:"text-2xl font-bold text-gray-900"},formatPercentage(r.userEngagement.repeatUsers)),t.createElement("p",{className:"text-sm text-gray-600"},"Repeat Users"))))))))},L={async getPermissions(){const{data:e,error:t}=await r.from("permissions").select("*").order("resource",{ascending:!0}).order("action",{ascending:!0});if(t)throw console.error("Error fetching permissions:",t),new Error("Failed to fetch permissions");return e||[]},async getRolePermissions(e){let t=r.from("role_permissions").select("\n        *,\n        permission:permissions(*)\n      ").order("role",{ascending:!0});e&&(t=t.eq("role",e));const{data:a,error:s}=await t;if(s)throw console.error("Error fetching role permissions:",s),new Error("Failed to fetch role permissions");return a||[]},async updateRolePermissions(e,t){const{error:a}=await r.from("role_permissions").delete().eq("role",e);if(a)throw console.error("Error deleting role permissions:",a),new Error("Failed to update role permissions");if(t.length>0){const a=t.map(t=>({role:e,permission_id:t})),{error:s}=await r.from("role_permissions").insert(a);if(s)throw console.error("Error inserting role permissions:",s),new Error("Failed to update role permissions")}await this.logAction("update_role_permissions","role_permissions",e,null,{role:e,permission_ids:t})},async getUsers(e={}){let t=r.from("profiles").select("*").order("created_at",{ascending:!1});e.role&&(t=t.eq("role",e.role)),e.search&&(t=t.or(`full_name.ilike.%${e.search}%,email.ilike.%${e.search}%`));const{data:a,error:s}=await t;if(s)throw console.error("Error fetching users:",s),new Error("Failed to fetch users");return a||[]},async getUserWithPermissions(e){const{data:t,error:a}=await r.rpc("get_user_permissions",{user_uuid:e});if(a)throw console.error("Error fetching user permissions:",a),new Error("Failed to fetch user permissions");const{data:s,error:n}=await r.from("profiles").select("*").eq("id",e).single();if(n)throw console.error("Error fetching user profile:",n),new Error("Failed to fetch user profile");return{...s,permissions:t||[]}},async updateUserRole(e,t){const{data:a}=await r.from("profiles").select("*").eq("id",e).single(),{data:s,error:n}=await r.from("profiles").update({role:t}).eq("id",e).select().single();if(n)throw console.error("Error updating user role:",n),new Error("Failed to update user role");return await this.logAction("update_user_role","profiles",e,{role:a?.role},{role:t}),s},async deleteUser(e){const{data:t}=await r.from("profiles").select("*").eq("id",e).single(),{error:a}=await r.from("profiles").delete().eq("id",e);if(a)throw console.error("Error deleting user:",a),new Error("Failed to delete user");await this.logAction("delete_user","profiles",e,t,null)},async getUserPermissions(e){const{data:t,error:a}=await r.from("user_permissions").select("\n        *,\n        permission:permissions(*),\n        granted_by_user:profiles!user_permissions_granted_by_fkey(full_name, email)\n      ").eq("user_id",e).order("created_at",{ascending:!1});if(a)throw console.error("Error fetching user permissions:",a),new Error("Failed to fetch user permissions");return t||[]},async grantUserPermission(e){const{data:{user:t}}=await r.auth.getUser();if(!t)throw new Error("User not authenticated");const{data:a,error:s}=await r.from("user_permissions").upsert({...e,granted_by:t.id}).select("\n        *,\n        permission:permissions(*)\n      ").single();if(s)throw console.error("Error granting user permission:",s),new Error("Failed to grant user permission");return await this.logAction("grant_user_permission","user_permissions",a.id,null,e),a},async revokeUserPermission(e,t){const{error:a}=await r.from("user_permissions").delete().eq("user_id",e).eq("permission_id",t);if(a)throw console.error("Error revoking user permission:",a),new Error("Failed to revoke user permission");await this.logAction("revoke_user_permission","user_permissions",`${e}-${t}`,{user_id:e,permission_id:t},null)},async hasPermission(e){const{data:{user:t}}=await r.auth.getUser();if(!t)return!1;const{data:a,error:s}=await r.rpc("user_has_permission",{user_uuid:t.id,permission_name:e});return s?(console.error("Error checking permission:",s),!1):a||!1},async getUserPermissionsList(e){const{data:{user:t}}=await r.auth.getUser(),a=e||t?.id;if(!a)return[];const{data:s,error:n}=await r.rpc("get_user_permissions",{user_uuid:a});return n?(console.error("Error fetching user permissions list:",n),[]):(s||[]).filter(e=>e.granted_by_role||e.granted_individually).map(e=>e.permission_name)},async getAuditLogs(e={}){let t=r.from("audit_logs").select("\n        *,\n        user:profiles(full_name, email, role)\n      ").order("created_at",{ascending:!1}).limit(100);e.user_id&&(t=t.eq("user_id",e.user_id)),e.action&&(t=t.eq("action",e.action)),e.resource_type&&(t=t.eq("resource_type",e.resource_type)),e.date_from&&(t=t.gte("created_at",e.date_from.toISOString())),e.date_to&&(t=t.lte("created_at",e.date_to.toISOString()));const{data:a,error:s}=await t;if(s)throw console.error("Error fetching audit logs:",s),new Error("Failed to fetch audit logs");return a||[]},async logAction(e,t,a,s,n,l,o){const{data:{user:c}}=await r.auth.getUser();if(!c)return;const{error:i}=await r.rpc("log_admin_action",{user_uuid:c.id,action_name:e,resource_type_name:t,resource_id_value:a,old_values_json:s,new_values_json:n,ip_addr:l,user_agent_string:o});i&&console.error("Error logging action:",i)},async bulkUpdateUserRoles(e,t){const{error:a}=await r.from("profiles").update({role:t}).in("id",e);if(a)throw console.error("Error bulk updating user roles:",a),new Error("Failed to bulk update user roles");await this.logAction("bulk_update_user_roles","profiles",e.join(","),null,{user_ids:e,role:t})},async bulkDeleteUsers(e){const{error:t}=await r.from("profiles").delete().in("id",e);if(t)throw console.error("Error bulk deleting users:",t),new Error("Failed to bulk delete users");await this.logAction("bulk_delete_users","profiles",e.join(","),{user_ids:e},null)}},usePermissions=()=>{const[t,a]=e.useState([]),[r,s]=e.useState(!0),{user:n,profile:l}=M(),fetchPermissions=async()=>{if(!n)return a([]),void s(!1);try{s(!0);const e=await L.getUserPermissionsList();a(e)}catch(e){console.error("Error fetching permissions:",e),a([])}finally{s(!1)}};e.useEffect(()=>{fetchPermissions()},[n]);const hasRole=e=>!!l?.role&&(Array.isArray(e)?e.includes(l.role):l.role===e),o=hasRole(["admin","super_admin"]),c=hasRole(["moderator","admin","super_admin"]),i=hasRole("super_admin");return{permissions:t,hasPermission:e=>t.includes(e),hasAnyPermission:e=>e.some(e=>t.includes(e)),hasAllPermissions:e=>e.every(e=>t.includes(e)),hasRole:hasRole,isAdmin:o,isModerator:c,isSuperAdmin:i,loading:r,refetch:fetchPermissions}},useRoleAccess=()=>{const{profile:e}=M();return{canAccessAdmin:()=>e?.role&&["admin","super_admin"].includes(e.role),canAccessModerator:()=>e?.role&&["moderator","admin","super_admin"].includes(e.role),canManageUsers:()=>e?.role&&["admin","super_admin"].includes(e.role),canManageSystem:()=>"super_admin"===e?.role,userRole:e?.role||"user"}},O={DOCUMENTS_CREATE:"documents.create",DOCUMENTS_READ:"documents.read",DOCUMENTS_UPDATE:"documents.update",DOCUMENTS_DELETE:"documents.delete",DOCUMENTS_READ_ALL:"documents.read_all",TEMPLATES_CREATE:"templates.create",TEMPLATES_READ:"templates.read",TEMPLATES_UPDATE:"templates.update",TEMPLATES_DELETE:"templates.delete",TEMPLATES_MODERATE:"templates.moderate",TEMPLATES_MANAGE:"templates.manage",LAW_FIRMS_CREATE:"law_firms.create",LAW_FIRMS_READ:"law_firms.read",LAW_FIRMS_UPDATE:"law_firms.update",LAW_FIRMS_DELETE:"law_firms.delete",LAW_FIRMS_VERIFY:"law_firms.verify",LAW_FIRMS_MODERATE_REVIEWS:"law_firms.moderate_reviews",USERS_CREATE:"users.create",USERS_READ:"users.read",USERS_UPDATE:"users.update",USERS_DELETE:"users.delete",USERS_MANAGE_ROLES:"users.manage_roles",USERS_MANAGE_PERMISSIONS:"users.manage_permissions",SYSTEM_ANALYTICS:"system.analytics",SYSTEM_MONITORING:"system.monitoring",SYSTEM_AUDIT_LOGS:"system.audit_logs",SYSTEM_SETTINGS:"system.settings"};export{O as P,TemplateAnalyticsDashboard as T,useRoleAccess as a,L as r,usePermissions as u};
