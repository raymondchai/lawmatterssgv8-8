import{r as e,j as s}from"./react-vendor-C9QDz5CC-1751188485170.js";import{v as t,ae as r,L as a,M as n,z as i,A as l,E as o,G as c,K as d,B as m,C as u,n as h,p as g,q as x,r as p,s as w,t as f,u as j,y as _,w as v}from"./index-DIADPChn-1751188485170.js";import{F as y,w as N,aI as E,y as T,N as S,bx as R,bw as b,s as A,cd as D,ce as U,c5 as P}from"./ui-components-3sBZsGlG-1751188485170.js";import{f as M}from"./utilities-DwzqNXNX-1751188485170.js";const I=new class TemplateAnalyticsService{async getDashboardAnalytics(e){try{const s=e?.end||new Date,t=e?.start||new Date(Date.now()-2592e6),[r,a,n,i]=await Promise.all([this.getTotalTemplates(),this.getTotalDownloads(),this.getTotalRevenue(),this.getTotalUsers()]),[l,o,c]=await Promise.all([this.getDownloadsInPeriod(t,s),this.getRevenueInPeriod(t,s),this.getNewUsersInPeriod(t,s)]),[d,m,u,h,g,x]=await Promise.all([this.getPopularTemplates(10),this.getCategoryStats(),this.getUserEngagementMetrics(t,s),this.getRevenueBreakdown(),this.getDownloadTrends(t,s),this.getFormatStats()]);return{totalTemplates:r,totalDownloads:a,totalRevenue:n,totalUsers:i,downloadsThisMonth:l,revenueThisMonth:o,newUsersThisMonth:c,popularTemplates:d,categoryStats:m,userEngagement:u,revenueBreakdown:h,downloadTrends:g,formatStats:x}}catch(s){throw console.error("Error fetching dashboard analytics:",s),new Error("Failed to fetch analytics data")}}async getTemplatePerformance(e){try{let s=t.from("templates").select("\n          id,\n          title,\n          download_count,\n          rating_average,\n          updated_at,\n          template_analytics!inner(event_type),\n          template_downloads!inner(format),\n          template_customizations!inner(id)\n        ");e&&(s=s.eq("id",e));const{data:r,error:a}=await s;if(a)throw a;return r.map(e=>{const s=e.template_analytics?.filter(e=>"template_view"===e.event_type).length||0,t=e.template_customizations?.length||0,r=e.download_count||0;return{templateId:e.id,title:e.title,views:s,customizations:t,downloads:r,revenue:50*r,rating:e.rating_average||0,conversionRate:s>0?r/s*100:0,lastUpdated:new Date(e.updated_at)}})}catch(s){throw console.error("Error fetching template performance:",s),new Error("Failed to fetch template performance data")}}async getRevenueAnalytics(){try{const e=await this.getTotalRevenue(),s=await this.getRevenueInPeriod(new Date(Date.now()-2592e6),new Date),t=await this.getRevenueInPeriod(new Date(Date.now()-5184e6),new Date(Date.now()-2592e6)),r=t>0?(s-t)/t*100:0,a=await this.getTopRevenueTemplates(5);return{totalRevenue:e,monthlyRevenue:s,revenueGrowth:r,averageOrderValue:await this.getAverageOrderValue(),topRevenueTemplates:a}}catch(e){throw console.error("Error fetching revenue analytics:",e),new Error("Failed to fetch revenue analytics")}}async getTotalTemplates(){const{count:e,error:s}=await t.from("templates").select("*",{count:"exact",head:!0}).eq("is_active",!0);if(s)throw s;return e||0}async getTotalDownloads(){const{count:e,error:s}=await t.from("template_downloads").select("*",{count:"exact",head:!0});if(s)throw s;return e||0}async getTotalRevenue(){return 25*await this.getTotalDownloads()}async getTotalUsers(){const{count:e,error:s}=await t.from("profiles").select("*",{count:"exact",head:!0});if(s)throw s;return e||0}async getDownloadsInPeriod(e,s){const{count:r,error:a}=await t.from("template_downloads").select("*",{count:"exact",head:!0}).gte("created_at",e.toISOString()).lte("created_at",s.toISOString());if(a)throw a;return r||0}async getRevenueInPeriod(e,s){return 25*await this.getDownloadsInPeriod(e,s)}async getNewUsersInPeriod(e,s){const{count:r,error:a}=await t.from("profiles").select("*",{count:"exact",head:!0}).gte("created_at",e.toISOString()).lte("created_at",s.toISOString());if(a)throw a;return r||0}async getPopularTemplates(e=10){const{data:s,error:r}=await t.from("templates").select("\n        id,\n        title,\n        download_count,\n        price_sgd,\n        categories(name)\n      ").eq("is_active",!0).order("download_count",{ascending:!1}).limit(e);if(r)throw r;return s.map(e=>({id:e.id,title:e.title,downloadCount:e.download_count||0,revenue:(e.download_count||0)*(e.price_sgd||0),category:e.categories?.name||"Uncategorized"}))}async getCategoryStats(){const{data:e,error:s}=await t.from("template_categories").select("\n        id,\n        name,\n        templates(id, download_count, price_sgd)\n      ");if(s)throw s;return e.map(e=>({categoryId:e.id,categoryName:e.name,templateCount:e.templates?.length||0,downloadCount:e.templates?.reduce((e,s)=>e+(s.download_count||0),0)||0,revenue:e.templates?.reduce((e,s)=>e+(s.download_count||0)*(s.price_sgd||0),0)||0}))}async getUserEngagementMetrics(e,s){return{averageSessionDuration:180,bounceRate:35.5,conversionRate:12.8,repeatUsers:45}}async getRevenueBreakdown(){return{public:0,premium:15e3,enterprise:8500}}async getDownloadTrends(e,s){const t=[],r=Math.ceil((s.getTime()-e.getTime())/864e5);for(let a=0;a<r;a++){const s=new Date(e.getTime()+24*a*60*60*1e3);t.push({date:s.toISOString().split("T")[0],downloads:Math.floor(50*Math.random())+10,revenue:Math.floor(1e3*Math.random())+200})}return t}async getFormatStats(){const{data:e,error:s}=await t.from("template_downloads").select("format");if(s)throw s;const r=e.reduce((e,s)=>(e[s.format]=(e[s.format]||0)+1,e),{}),a=Object.values(r).reduce((e,s)=>e+s,0);return Object.entries(r).map(([e,s])=>({format:e,count:s,percentage:a>0?s/a*100:0}))}async getTopRevenueTemplates(e=5){const{data:s,error:r}=await t.from("templates").select("\n        id,\n        title,\n        download_count,\n        price_sgd\n      ").eq("is_active",!0).order("download_count",{ascending:!1}).limit(e);if(r)throw r;return s.map(e=>({templateId:e.id,title:e.title,revenue:(e.download_count||0)*(e.price_sgd||0),downloads:e.download_count||0}))}async getAverageOrderValue(){const e=await this.getTotalRevenue(),s=await this.getTotalDownloads();return s>0?e/s:0}},TemplateAnalyticsDashboard=({className:t=""})=>{const[v,F]=e.useState(null),[L,C]=e.useState([]),[O,k]=e.useState(null),[q,V]=e.useState(!0),[G,$]=e.useState(null),[W,Y]=e.useState("30d"),[z,B]=e.useState("overview");e.useEffect(()=>{loadAnalyticsData()},[W]);const loadAnalyticsData=async()=>{try{V(!0),$(null);const e=new Date,s=new Date;switch(W){case"7d":s.setDate(e.getDate()-7);break;case"30d":s.setDate(e.getDate()-30);break;case"90d":s.setDate(e.getDate()-90);break;case"1y":s.setFullYear(e.getFullYear()-1)}const[t,r,a]=await Promise.all([I.getDashboardAnalytics({start:s,end:e}),I.getTemplatePerformance(),I.getRevenueAnalytics()]);F(t),C(r),k(a)}catch(e){console.error("Error loading analytics:",e),$(e instanceof Error?e.message:"Failed to load analytics")}finally{V(!1)}},formatCurrency=e=>new Intl.NumberFormat("en-SG",{style:"currency",currency:"SGD"}).format(e),formatNumber=e=>new Intl.NumberFormat("en-SG").format(e),formatPercentage=e=>`${e.toFixed(1)}%`,getTrendIcon=e=>e>0?s.jsx(D,{className:"h-4 w-4 text-green-500"}):e<0?s.jsx(U,{className:"h-4 w-4 text-red-500"}):s.jsx(P,{className:"h-4 w-4 text-gray-500"});if(q)return s.jsxs("div",{className:`space-y-6 ${t}`,children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(r,{className:"h-8 w-64"}),s.jsx(r,{className:"h-10 w-32"})]}),s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[...Array(4)].map((e,t)=>s.jsx(r,{className:"h-32"},t))}),s.jsx(r,{className:"h-96"})]});if(G||!v)return s.jsx("div",{className:t,children:s.jsx(a,{children:s.jsx(n,{children:G||"Failed to load analytics data. Please try again."})})});const K=[{title:"Total Templates",value:formatNumber(v.totalTemplates),change:"+12%",changeValue:12,icon:y,color:"text-blue-600"},{title:"Total Downloads",value:formatNumber(v.totalDownloads),change:"+8.5%",changeValue:8.5,icon:N,color:"text-green-600"},{title:"Total Revenue",value:formatCurrency(v.totalRevenue),change:"+15.2%",changeValue:15.2,icon:E,color:"text-purple-600"},{title:"Active Users",value:formatNumber(v.totalUsers),change:"+6.8%",changeValue:6.8,icon:T,color:"text-orange-600"}];return s.jsxs("div",{className:`space-y-6 ${t}`,children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("h2",{className:"text-3xl font-bold text-gray-900",children:"Template Analytics"}),s.jsx("p",{className:"text-gray-600 mt-1",children:"Comprehensive insights into template marketplace performance"})]}),s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsxs(i,{value:W,onValueChange:Y,children:[s.jsx(l,{className:"w-32",children:s.jsx(o,{})}),s.jsxs(c,{children:[s.jsx(d,{value:"7d",children:"Last 7 days"}),s.jsx(d,{value:"30d",children:"Last 30 days"}),s.jsx(d,{value:"90d",children:"Last 90 days"}),s.jsx(d,{value:"1y",children:"Last year"})]})]}),s.jsxs(m,{variant:"outline",onClick:loadAnalyticsData,disabled:q,children:[s.jsx(S,{className:"h-4 w-4 mr-2"}),"Refresh"]})]})]}),s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:K.map((e,t)=>s.jsx(u,{children:s.jsx(h,{className:"p-6",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex-1",children:[s.jsx("p",{className:"text-sm font-medium text-gray-600",children:e.title}),s.jsx("p",{className:"text-2xl font-bold text-gray-900 mt-1",children:e.value}),s.jsxs("div",{className:"flex items-center mt-2",children:[getTrendIcon(e.changeValue),s.jsx("span",{className:"text-sm ml-1 "+(e.changeValue>0?"text-green-600":e.changeValue<0?"text-red-600":"text-gray-600"),children:e.change}),s.jsx("span",{className:"text-xs text-gray-500 ml-1",children:"vs last period"})]})]}),s.jsx(e.icon,{className:`h-8 w-8 ${e.color}`})]})})},t))}),s.jsxs(g,{value:z,onValueChange:B,children:[s.jsxs(x,{className:"grid w-full grid-cols-4",children:[s.jsx(p,{value:"overview",children:"Overview"}),s.jsx(p,{value:"performance",children:"Performance"}),s.jsx(p,{value:"revenue",children:"Revenue"}),s.jsx(p,{value:"engagement",children:"Engagement"})]}),s.jsxs(w,{value:"overview",className:"space-y-6",children:[s.jsxs("div",{className:"grid lg:grid-cols-2 gap-6",children:[s.jsxs(u,{children:[s.jsxs(f,{children:[s.jsxs(j,{className:"flex items-center gap-2",children:[s.jsx(R,{className:"h-5 w-5"}),"Popular Templates"]}),s.jsx(_,{children:"Top performing templates by downloads"})]}),s.jsx(h,{children:s.jsx("div",{className:"space-y-4",children:v.popularTemplates.slice(0,5).map((e,t)=>s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center",children:s.jsx("span",{className:"text-sm font-medium text-blue-600",children:t+1})}),s.jsxs("div",{children:[s.jsx("p",{className:"font-medium text-gray-900",children:e.title}),s.jsx("p",{className:"text-sm text-gray-500",children:e.category})]})]}),s.jsxs("div",{className:"text-right",children:[s.jsx("p",{className:"font-medium",children:formatNumber(e.downloadCount)}),s.jsx("p",{className:"text-sm text-gray-500",children:"downloads"})]})]},e.id))})})]}),s.jsxs(u,{children:[s.jsxs(f,{children:[s.jsxs(j,{className:"flex items-center gap-2",children:[s.jsx(b,{className:"h-5 w-5"}),"Category Performance"]}),s.jsx(_,{children:"Downloads and revenue by category"})]}),s.jsx(h,{children:s.jsx("div",{className:"space-y-4",children:v.categoryStats.slice(0,5).map(e=>s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"font-medium",children:e.categoryName}),s.jsxs("span",{className:"text-sm text-gray-500",children:[formatNumber(e.downloadCount)," downloads"]})]}),s.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:s.jsx("div",{className:"bg-blue-600 h-2 rounded-full",style:{width:`${Math.min(e.downloadCount/Math.max(...v.categoryStats.map(e=>e.downloadCount))*100,100)}%`}})})]},e.categoryId))})})]})]}),s.jsxs(u,{children:[s.jsxs(f,{children:[s.jsx(j,{children:"Download Format Preferences"}),s.jsx(_,{children:"User preferences for document formats"})]}),s.jsx(h,{children:s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:v.formatStats.map(e=>s.jsxs("div",{className:"text-center p-4 border rounded-lg",children:[s.jsx("div",{className:"text-2xl font-bold text-gray-900",children:formatPercentage(e.percentage)}),s.jsx("div",{className:"text-sm text-gray-600 uppercase tracking-wide",children:e.format}),s.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[formatNumber(e.count)," downloads"]})]},e.format))})})]})]}),s.jsx(w,{value:"performance",className:"space-y-6",children:s.jsxs(u,{children:[s.jsxs(f,{children:[s.jsx(j,{children:"Template Performance Metrics"}),s.jsx(_,{children:"Detailed performance analysis for all templates"})]}),s.jsx(h,{children:s.jsx("div",{className:"overflow-x-auto",children:s.jsxs("table",{className:"w-full",children:[s.jsx("thead",{children:s.jsxs("tr",{className:"border-b",children:[s.jsx("th",{className:"text-left p-2",children:"Template"}),s.jsx("th",{className:"text-right p-2",children:"Views"}),s.jsx("th",{className:"text-right p-2",children:"Downloads"}),s.jsx("th",{className:"text-right p-2",children:"Conversion"}),s.jsx("th",{className:"text-right p-2",children:"Revenue"}),s.jsx("th",{className:"text-right p-2",children:"Rating"})]})}),s.jsx("tbody",{children:L.slice(0,10).map(e=>s.jsxs("tr",{className:"border-b",children:[s.jsx("td",{className:"p-2",children:s.jsxs("div",{children:[s.jsx("p",{className:"font-medium",children:e.title}),s.jsxs("p",{className:"text-xs text-gray-500",children:["Updated ",M(e.lastUpdated,{addSuffix:!0})]})]})}),s.jsx("td",{className:"text-right p-2",children:formatNumber(e.views)}),s.jsx("td",{className:"text-right p-2",children:formatNumber(e.downloads)}),s.jsx("td",{className:"text-right p-2",children:formatPercentage(e.conversionRate)}),s.jsx("td",{className:"text-right p-2",children:formatCurrency(e.revenue)}),s.jsx("td",{className:"text-right p-2",children:s.jsxs("div",{className:"flex items-center justify-end gap-1",children:[s.jsx(A,{className:"h-4 w-4 text-yellow-400 fill-current"}),e.rating.toFixed(1)]})})]},e.templateId))})]})})})]})}),s.jsx(w,{value:"revenue",className:"space-y-6",children:O&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[s.jsx(u,{children:s.jsx(h,{className:"p-6",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Monthly Revenue"}),s.jsx("p",{className:"text-2xl font-bold text-gray-900",children:formatCurrency(O.monthlyRevenue)}),s.jsxs("div",{className:"flex items-center mt-1",children:[getTrendIcon(O.revenueGrowth),s.jsx("span",{className:"text-sm ml-1 "+(O.revenueGrowth>0?"text-green-600":"text-red-600"),children:formatPercentage(O.revenueGrowth)})]})]}),s.jsx(E,{className:"h-8 w-8 text-green-600"})]})})}),s.jsx(u,{children:s.jsx(h,{className:"p-6",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Average Order Value"}),s.jsx("p",{className:"text-2xl font-bold text-gray-900",children:formatCurrency(O.averageOrderValue)})]}),s.jsx(b,{className:"h-8 w-8 text-blue-600"})]})})}),s.jsx(u,{children:s.jsx(h,{className:"p-6",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Total Revenue"}),s.jsx("p",{className:"text-2xl font-bold text-gray-900",children:formatCurrency(O.totalRevenue)})]}),s.jsx(R,{className:"h-8 w-8 text-purple-600"})]})})})]}),s.jsxs(u,{children:[s.jsxs(f,{children:[s.jsx(j,{children:"Top Revenue Generating Templates"}),s.jsx(_,{children:"Templates contributing most to revenue"})]}),s.jsx(h,{children:s.jsx("div",{className:"space-y-4",children:O.topRevenueTemplates.map((e,t)=>s.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"w-8 h-8 bg-green-100 rounded-full flex items-center justify-center",children:s.jsx("span",{className:"text-sm font-medium text-green-600",children:t+1})}),s.jsxs("div",{children:[s.jsx("p",{className:"font-medium text-gray-900",children:e.title}),s.jsxs("p",{className:"text-sm text-gray-500",children:[formatNumber(e.downloads)," downloads"]})]})]}),s.jsx("div",{className:"text-right",children:s.jsx("p",{className:"font-bold text-green-600",children:formatCurrency(e.revenue)})})]},e.templateId))})})]})]})}),s.jsx(w,{value:"engagement",className:"space-y-6",children:s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[s.jsx(u,{children:s.jsx(h,{className:"p-6",children:s.jsxs("div",{className:"text-center",children:[s.jsxs("p",{className:"text-2xl font-bold text-gray-900",children:[v.userEngagement.averageSessionDuration,"s"]}),s.jsx("p",{className:"text-sm text-gray-600",children:"Avg Session Duration"})]})})}),s.jsx(u,{children:s.jsx(h,{className:"p-6",children:s.jsxs("div",{className:"text-center",children:[s.jsx("p",{className:"text-2xl font-bold text-gray-900",children:formatPercentage(v.userEngagement.bounceRate)}),s.jsx("p",{className:"text-sm text-gray-600",children:"Bounce Rate"})]})})}),s.jsx(u,{children:s.jsx(h,{className:"p-6",children:s.jsxs("div",{className:"text-center",children:[s.jsx("p",{className:"text-2xl font-bold text-gray-900",children:formatPercentage(v.userEngagement.conversionRate)}),s.jsx("p",{className:"text-sm text-gray-600",children:"Conversion Rate"})]})})}),s.jsx(u,{children:s.jsx(h,{className:"p-6",children:s.jsxs("div",{className:"text-center",children:[s.jsx("p",{className:"text-2xl font-bold text-gray-900",children:formatPercentage(v.userEngagement.repeatUsers)}),s.jsx("p",{className:"text-sm text-gray-600",children:"Repeat Users"})]})})})]})})]})]})},F={async getPermissions(){const{data:e,error:s}=await t.from("permissions").select("*").order("resource",{ascending:!0}).order("action",{ascending:!0});if(s)throw console.error("Error fetching permissions:",s),new Error("Failed to fetch permissions");return e||[]},async getRolePermissions(e){let s=t.from("role_permissions").select("\n        *,\n        permission:permissions(*)\n      ").order("role",{ascending:!0});e&&(s=s.eq("role",e));const{data:r,error:a}=await s;if(a)throw console.error("Error fetching role permissions:",a),new Error("Failed to fetch role permissions");return r||[]},async updateRolePermissions(e,s){const{error:r}=await t.from("role_permissions").delete().eq("role",e);if(r)throw console.error("Error deleting role permissions:",r),new Error("Failed to update role permissions");if(s.length>0){const r=s.map(s=>({role:e,permission_id:s})),{error:a}=await t.from("role_permissions").insert(r);if(a)throw console.error("Error inserting role permissions:",a),new Error("Failed to update role permissions")}await this.logAction("update_role_permissions","role_permissions",e,null,{role:e,permission_ids:s})},async getUsers(e={}){let s=t.from("profiles").select("*").order("created_at",{ascending:!1});e.role&&(s=s.eq("role",e.role)),e.search&&(s=s.or(`full_name.ilike.%${e.search}%,email.ilike.%${e.search}%`));const{data:r,error:a}=await s;if(a)throw console.error("Error fetching users:",a),new Error("Failed to fetch users");return r||[]},async getUserWithPermissions(e){const{data:s,error:r}=await t.rpc("get_user_permissions",{user_uuid:e});if(r)throw console.error("Error fetching user permissions:",r),new Error("Failed to fetch user permissions");const{data:a,error:n}=await t.from("profiles").select("*").eq("id",e).single();if(n)throw console.error("Error fetching user profile:",n),new Error("Failed to fetch user profile");return{...a,permissions:s||[]}},async updateUserRole(e,s){const{data:r}=await t.from("profiles").select("*").eq("id",e).single(),{data:a,error:n}=await t.from("profiles").update({role:s}).eq("id",e).select().single();if(n)throw console.error("Error updating user role:",n),new Error("Failed to update user role");return await this.logAction("update_user_role","profiles",e,{role:r?.role},{role:s}),a},async deleteUser(e){const{data:s}=await t.from("profiles").select("*").eq("id",e).single(),{error:r}=await t.from("profiles").delete().eq("id",e);if(r)throw console.error("Error deleting user:",r),new Error("Failed to delete user");await this.logAction("delete_user","profiles",e,s,null)},async getUserPermissions(e){const{data:s,error:r}=await t.from("user_permissions").select("\n        *,\n        permission:permissions(*),\n        granted_by_user:profiles!user_permissions_granted_by_fkey(full_name, email)\n      ").eq("user_id",e).order("created_at",{ascending:!1});if(r)throw console.error("Error fetching user permissions:",r),new Error("Failed to fetch user permissions");return s||[]},async grantUserPermission(e){const{data:{user:s}}=await t.auth.getUser();if(!s)throw new Error("User not authenticated");const{data:r,error:a}=await t.from("user_permissions").upsert({...e,granted_by:s.id}).select("\n        *,\n        permission:permissions(*)\n      ").single();if(a)throw console.error("Error granting user permission:",a),new Error("Failed to grant user permission");return await this.logAction("grant_user_permission","user_permissions",r.id,null,e),r},async revokeUserPermission(e,s){const{error:r}=await t.from("user_permissions").delete().eq("user_id",e).eq("permission_id",s);if(r)throw console.error("Error revoking user permission:",r),new Error("Failed to revoke user permission");await this.logAction("revoke_user_permission","user_permissions",`${e}-${s}`,{user_id:e,permission_id:s},null)},async hasPermission(e){const{data:{user:s}}=await t.auth.getUser();if(!s)return!1;const{data:r,error:a}=await t.rpc("user_has_permission",{user_uuid:s.id,permission_name:e});return a?(console.error("Error checking permission:",a),!1):r||!1},async getUserPermissionsList(e){const{data:{user:s}}=await t.auth.getUser(),r=e||s?.id;if(!r)return[];const{data:a,error:n}=await t.rpc("get_user_permissions",{user_uuid:r});return n?(console.error("Error fetching user permissions list:",n),[]):(a||[]).filter(e=>e.granted_by_role||e.granted_individually).map(e=>e.permission_name)},async getAuditLogs(e={}){let s=t.from("audit_logs").select("\n        *,\n        user:profiles(full_name, email, role)\n      ").order("created_at",{ascending:!1}).limit(100);e.user_id&&(s=s.eq("user_id",e.user_id)),e.action&&(s=s.eq("action",e.action)),e.resource_type&&(s=s.eq("resource_type",e.resource_type)),e.date_from&&(s=s.gte("created_at",e.date_from.toISOString())),e.date_to&&(s=s.lte("created_at",e.date_to.toISOString()));const{data:r,error:a}=await s;if(a)throw console.error("Error fetching audit logs:",a),new Error("Failed to fetch audit logs");return r||[]},async logAction(e,s,r,a,n,i,l){const{data:{user:o}}=await t.auth.getUser();if(!o)return;const{error:c}=await t.rpc("log_admin_action",{user_uuid:o.id,action_name:e,resource_type_name:s,resource_id_value:r,old_values_json:a,new_values_json:n,ip_addr:i,user_agent_string:l});c&&console.error("Error logging action:",c)},async bulkUpdateUserRoles(e,s){const{error:r}=await t.from("profiles").update({role:s}).in("id",e);if(r)throw console.error("Error bulk updating user roles:",r),new Error("Failed to bulk update user roles");await this.logAction("bulk_update_user_roles","profiles",e.join(","),null,{user_ids:e,role:s})},async bulkDeleteUsers(e){const{error:s}=await t.from("profiles").delete().in("id",e);if(s)throw console.error("Error bulk deleting users:",s),new Error("Failed to bulk delete users");await this.logAction("bulk_delete_users","profiles",e.join(","),{user_ids:e},null)}},usePermissions=()=>{const[s,t]=e.useState([]),[r,a]=e.useState(!0),{user:n,profile:i}=v(),fetchPermissions=async()=>{if(!n)return t([]),void a(!1);try{a(!0);const e=await F.getUserPermissionsList();t(e)}catch(e){console.error("Error fetching permissions:",e),t([])}finally{a(!1)}};e.useEffect(()=>{fetchPermissions()},[n]);const hasRole=e=>!!i?.role&&(Array.isArray(e)?e.includes(i.role):i.role===e),l=hasRole(["admin","super_admin"]),o=hasRole(["moderator","admin","super_admin"]),c=hasRole("super_admin");return{permissions:s,hasPermission:e=>s.includes(e),hasAnyPermission:e=>e.some(e=>s.includes(e)),hasAllPermissions:e=>e.every(e=>s.includes(e)),hasRole:hasRole,isAdmin:l,isModerator:o,isSuperAdmin:c,loading:r,refetch:fetchPermissions}},useRoleAccess=()=>{const{profile:e}=v();return{canAccessAdmin:()=>e?.role&&["admin","super_admin"].includes(e.role),canAccessModerator:()=>e?.role&&["moderator","admin","super_admin"].includes(e.role),canManageUsers:()=>e?.role&&["admin","super_admin"].includes(e.role),canManageSystem:()=>"super_admin"===e?.role,userRole:e?.role||"user"}},L={DOCUMENTS_CREATE:"documents.create",DOCUMENTS_READ:"documents.read",DOCUMENTS_UPDATE:"documents.update",DOCUMENTS_DELETE:"documents.delete",DOCUMENTS_READ_ALL:"documents.read_all",TEMPLATES_CREATE:"templates.create",TEMPLATES_READ:"templates.read",TEMPLATES_UPDATE:"templates.update",TEMPLATES_DELETE:"templates.delete",TEMPLATES_MODERATE:"templates.moderate",TEMPLATES_MANAGE:"templates.manage",LAW_FIRMS_CREATE:"law_firms.create",LAW_FIRMS_READ:"law_firms.read",LAW_FIRMS_UPDATE:"law_firms.update",LAW_FIRMS_DELETE:"law_firms.delete",LAW_FIRMS_VERIFY:"law_firms.verify",LAW_FIRMS_MODERATE_REVIEWS:"law_firms.moderate_reviews",USERS_CREATE:"users.create",USERS_READ:"users.read",USERS_UPDATE:"users.update",USERS_DELETE:"users.delete",USERS_MANAGE_ROLES:"users.manage_roles",USERS_MANAGE_PERMISSIONS:"users.manage_permissions",SYSTEM_ANALYTICS:"system.analytics",SYSTEM_MONITORING:"system.monitoring",SYSTEM_AUDIT_LOGS:"system.audit_logs",SYSTEM_SETTINGS:"system.settings"};export{L as P,TemplateAnalyticsDashboard as T,useRoleAccess as a,F as r,usePermissions as u};
