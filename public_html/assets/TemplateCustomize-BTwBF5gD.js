import{a as e,R as t}from"./react-vendor-92YuBQvb.js";import{bf as a,b1 as l,bg as n,bh as s,z as r,A as m,a4 as c,B as i,bi as o,b5 as d,p as u,a0 as E,a1 as p,_ as f,ab as g,aN as h,ap as x,aF as v,V as b,Q as N,am as y,an as w,Z as k,a6 as C,I as S,aO as z,ad as L,ae as $,af as F,ag as _,ai as j,H as T}from"./index-BheJWwZO.js";import"./supabase-Br4R_luN.js";function TemplateCustomize(){const{slug:O}=a(),P=l(),[D,H]=e.useState(null),[I,B]=e.useState(null),[U,V]=e.useState(!0),[q,M]=e.useState(!1),[R,A]=e.useState(!1),[Q,X]=e.useState(null),[Z,G]=e.useState({}),[J,K]=e.useState({}),[W,Y]=e.useState(!1),[ee,te]=e.useState("");e.useEffect(()=>{O&&loadTemplate(O)},[O]);const loadTemplate=async e=>{try{V(!0);const t=await n.getTemplate(e);if(!t)return void X("Template not found");H(t);const a={};t.fields.forEach(e=>{void 0!==e.defaultValue&&(a[e.name]=e.defaultValue)}),G(a),await n.trackEvent(t.id,"customization_started",{source:"customize_page",access_level:t.accessLevel})}catch(t){X(t instanceof Error?t.message:"Failed to load template")}finally{V(!1)}},validateForm=()=>{if(!D)return!1;const e={};return D.fields.forEach(t=>{const a=((e,t)=>{if(e.required&&(!t||""===t.toString().trim()))return`${e.label} is required`;if(t&&e.validation){const a=e.validation;if(a.minLength&&t.toString().length<a.minLength)return`${e.label} must be at least ${a.minLength} characters`;if(a.maxLength&&t.toString().length>a.maxLength)return`${e.label} must be no more than ${a.maxLength} characters`;if(a.pattern&&!new RegExp(a.pattern).test(t.toString()))return`${e.label} format is invalid`;if("number"===e.type){const l=Number(t);if(a.min&&l<a.min)return`${e.label} must be at least ${a.min}`;if(a.max&&l>a.max)return`${e.label} must be no more than ${a.max}`}}return null})(t,Z[t.name]);a&&(e[t.name]=a)}),K(e),0===Object.keys(e).length},handleFieldChange=(e,t)=>{G(a=>({...a,[e]:t})),J[e]&&K(t=>{const a={...t};return delete a[e],a})},handleDownload=async(e="pdf")=>{if(D&&I)try{A(!0);const{data:t,error:a}=await C.functions.invoke("template-document-generator",{body:{customizationId:I.id,format:e,templateData:{title:D.title,content:D.content.template||"",customFields:Z}}});if(a)throw new Error(a.message||"Failed to generate document");const l=document.createElement("a");l.href=t.downloadUrl,l.download=`${D.title.replace(/[^a-z0-9]/gi,"_").toLowerCase()}.${e}`,document.body.appendChild(l),l.click(),document.body.removeChild(l),await n.recordDownload(D.id,I.id,e)}catch(t){X(t instanceof Error?t.message:"Failed to download document")}finally{A(!1)}};return U?t.createElement("div",{className:"min-h-screen bg-gray-50"},t.createElement("div",{className:"container mx-auto px-4 py-8"},t.createElement("div",{className:"max-w-4xl mx-auto space-y-8"},t.createElement(s,{className:"h-8 w-32"}),t.createElement("div",{className:"grid lg:grid-cols-2 gap-8"},t.createElement("div",{className:"space-y-6"},t.createElement(s,{className:"h-64 w-full"}),t.createElement(s,{className:"h-32 w-full"})),t.createElement("div",{className:"space-y-6"},t.createElement(s,{className:"h-48 w-full"})))))):Q||!D?t.createElement("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center"},t.createElement(r,{className:"w-full max-w-md"},t.createElement(m,{className:"p-8 text-center"},t.createElement(c,{className:"h-12 w-12 text-red-500 mx-auto mb-4"}),t.createElement("h3",{className:"text-lg font-semibold text-gray-900 mb-2"},"Unable to Load Template"),t.createElement("p",{className:"text-gray-600 mb-6"},Q||"The template you're trying to customize is not available."),t.createElement(i,{onClick:()=>P(o.templateBrowser)},"Browse Templates")))):t.createElement("div",{className:"min-h-screen bg-gray-50"},t.createElement("div",{className:"container mx-auto px-4 py-8"},t.createElement("div",{className:"max-w-6xl mx-auto"},t.createElement("div",{className:"flex items-center justify-between mb-8"},t.createElement("div",{className:"flex items-center gap-4"},t.createElement(i,{variant:"ghost",size:"sm",onClick:()=>P(`${o.templatePreview}/${D.slug}`)},t.createElement(d,{className:"h-4 w-4 mr-2"}),"Back to Preview"),t.createElement("div",null,t.createElement("h1",{className:"text-2xl font-bold text-gray-900"},"Customize: ",D.title),t.createElement("p",{className:"text-gray-600"},"Fill in the fields below to customize your document"))),t.createElement("div",{className:"flex items-center gap-2"},t.createElement(u,{variant:"outline"},D.category?.name),"public"!==D.accessLevel&&t.createElement(u,{variant:"secondary"},D.accessLevel))),t.createElement("div",{className:"grid lg:grid-cols-2 gap-8"},t.createElement("div",{className:"space-y-6"},t.createElement(r,null,t.createElement(E,null,t.createElement(p,{className:"flex items-center gap-2"},t.createElement(f,{className:"h-5 w-5"}),"Document Fields"),t.createElement(g,null,"Complete the form below to customize your document")),t.createElement(m,{className:"space-y-6"},D.fields.map(e=>t.createElement("div",{key:e.id,className:"space-y-2"},t.createElement(h,{htmlFor:e.id,className:"flex items-center gap-2"},e.label,e.required&&t.createElement("span",{className:"text-red-500"},"*")),(e=>{const a=Z[e.name]||"",l=J[e.name],n={id:e.id,value:a,onChange:t=>handleFieldChange(e.name,t.target.value),placeholder:e.placeholder,className:l?"border-red-500":""};switch(e.type){case"textarea":return t.createElement(T,{...n,rows:4});case"select":return t.createElement(L,{value:a,onValueChange:t=>handleFieldChange(e.name,t)},t.createElement($,{className:l?"border-red-500":""},t.createElement(F,{placeholder:e.placeholder})),t.createElement(_,null,e.options?.map(e=>t.createElement(j,{key:e.value,value:e.value},e.label))));case"checkbox":return t.createElement("div",{className:"flex items-center space-x-2"},t.createElement(z,{id:e.id,checked:!0===a,onCheckedChange:t=>handleFieldChange(e.name,t)}),t.createElement(h,{htmlFor:e.id},e.label));case"number":return t.createElement(S,{...n,type:"number",min:e.validation?.min,max:e.validation?.max,onChange:t=>handleFieldChange(e.name,Number(t.target.value))});case"date":return t.createElement(S,{...n,type:"date"});case"email":return t.createElement(S,{...n,type:"email"});case"phone":return t.createElement(S,{...n,type:"tel"});default:return t.createElement(S,{...n,type:"text"})}})(e),e.helpText&&t.createElement("p",{className:"text-xs text-gray-500"},e.helpText),J[e.name]&&t.createElement("p",{className:"text-xs text-red-500"},J[e.name]))))),t.createElement(r,null,t.createElement(m,{className:"p-6"},t.createElement("div",{className:"flex flex-col sm:flex-row gap-3"},t.createElement(i,{onClick:async()=>{if(D&&validateForm())try{if(M(!0),I){const e=await n.updateCustomization(I.id,{customFields:Z});B(e)}else{const e=crypto.randomUUID(),t=await n.createCustomization(D.id,Z,void 0,e);B(t)}await n.trackEvent(D.id,"customization_saved",{fields_filled:Object.keys(Z).length,completion_rate:Object.keys(Z).length/D.fields.length*100})}catch(e){X(e instanceof Error?e.message:"Failed to save customization")}finally{M(!1)}},disabled:q,className:"flex-1"},q?t.createElement(x,{className:"h-4 w-4 mr-2 animate-spin"}):t.createElement(v,{className:"h-4 w-4 mr-2"}),"Save Progress"),t.createElement(i,{variant:"outline",onClick:async()=>{if(D&&validateForm())try{A(!0);let e=D.content.template||"";Object.entries(Z).forEach(([t,a])=>{const l=new RegExp(`{{${t}}}`,"g");e=e.replace(l,a?.toString()||"")}),te(e),Y(!0),await n.trackEvent(D.id,"preview_generated",{fields_filled:Object.keys(Z).length})}catch(e){X(e instanceof Error?e.message:"Failed to generate preview")}finally{A(!1)}},disabled:R,className:"flex-1"},R?t.createElement(x,{className:"h-4 w-4 mr-2 animate-spin"}):t.createElement(b,{className:"h-4 w-4 mr-2"}),"Preview"),t.createElement("div",{className:"flex gap-2 flex-1"},t.createElement(i,{variant:"outline",onClick:()=>handleDownload("pdf"),disabled:!I||R,className:"flex-1"},t.createElement(N,{className:"h-4 w-4 mr-2"}),"PDF"),t.createElement(i,{variant:"outline",onClick:()=>handleDownload("docx"),disabled:!I||R,className:"flex-1"},t.createElement(N,{className:"h-4 w-4 mr-2"}),"DOCX"),t.createElement(i,{variant:"outline",onClick:()=>handleDownload("html"),disabled:!I||R,className:"flex-1"},t.createElement(N,{className:"h-4 w-4 mr-2"}),"HTML"))),Object.keys(J).length>0&&t.createElement(y,{className:"mt-4"},t.createElement(c,{className:"h-4 w-4"}),t.createElement(w,null,"Please fix the validation errors above before proceeding."))))),t.createElement("div",{className:"space-y-6"},t.createElement(r,{className:"sticky top-6"},t.createElement(E,null,t.createElement(p,{className:"flex items-center gap-2"},t.createElement(k,{className:"h-5 w-5"}),"Live Preview"),t.createElement(g,null,"See how your document will look as you fill in the fields")),t.createElement(m,null,W&&ee?t.createElement("div",{className:"prose max-w-none border rounded-lg p-4 bg-white min-h-96 text-sm",dangerouslySetInnerHTML:{__html:ee}}):D.previewHtml?t.createElement("div",{className:"prose max-w-none border rounded-lg p-4 bg-white min-h-96 text-sm opacity-60",dangerouslySetInnerHTML:{__html:D.previewHtml}}):t.createElement("div",{className:"border rounded-lg p-8 bg-white min-h-96 flex items-center justify-center text-gray-500"},t.createElement("div",{className:"text-center"},t.createElement(k,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),t.createElement("p",null,"Fill in the fields to see your customized document"))))))))))}export{TemplateCustomize as default};
