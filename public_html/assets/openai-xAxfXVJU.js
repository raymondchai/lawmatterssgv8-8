import{bw as e}from"./index-BheJWwZO.js";import"./react-vendor-92YuBQvb.js";import"./supabase-Br4R_luN.js";function __classPrivateFieldSet(e,t,s,n,r){if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return t.set(e,s),s}function __classPrivateFieldGet(e,t,s,n){if("a"===s&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?n:"a"===s?n.call(e):n?n.value:t.get(e)}let uuid4=function(){const{crypto:e}=globalThis;if(e?.randomUUID)return uuid4=e.randomUUID.bind(e),e.randomUUID();const t=new Uint8Array(1),s=e?()=>e.getRandomValues(t)[0]:()=>255*Math.random()&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,e=>(+e^s()&15>>+e/4).toString(16))};function isAbortError(e){return"object"==typeof e&&null!==e&&("name"in e&&"AbortError"===e.name||"message"in e&&String(e.message).includes("FetchRequestCanceledException"))}const castToError=e=>{if(e instanceof Error)return e;if("object"==typeof e&&null!==e){try{if("[object Error]"===Object.prototype.toString.call(e)){const t=new Error(e.message,e.cause?{cause:e.cause}:{});return e.stack&&(t.stack=e.stack),e.cause&&!t.cause&&(t.cause=e.cause),e.name&&(t.name=e.name),t}}catch{}try{return new Error(JSON.stringify(e))}catch{}}return new Error(e)};class OpenAIError extends Error{}class APIError extends OpenAIError{constructor(e,t,s,n){super(`${APIError.makeMessage(e,t,s)}`),this.status=e,this.headers=n,this.requestID=n?.get("x-request-id"),this.error=t;const r=t;this.code=r?.code,this.param=r?.param,this.type=r?.type}static makeMessage(e,t,s){const n=t?.message?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):s;return e&&n?`${e} ${n}`:e?`${e} status code (no body)`:n||"(no status code or body)"}static generate(e,t,s,n){if(!e||!n)return new APIConnectionError({message:s,cause:castToError(t)});const r=t?.error;return 400===e?new BadRequestError(e,r,s,n):401===e?new AuthenticationError(e,r,s,n):403===e?new PermissionDeniedError(e,r,s,n):404===e?new NotFoundError(e,r,s,n):409===e?new ConflictError(e,r,s,n):422===e?new UnprocessableEntityError(e,r,s,n):429===e?new RateLimitError(e,r,s,n):e>=500?new InternalServerError(e,r,s,n):new APIError(e,r,s,n)}}class APIUserAbortError extends APIError{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class APIConnectionError extends APIError{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class APIConnectionTimeoutError extends APIConnectionError{constructor({message:e}={}){super({message:e??"Request timed out."})}}class BadRequestError extends APIError{}class AuthenticationError extends APIError{}class PermissionDeniedError extends APIError{}class NotFoundError extends APIError{}class ConflictError extends APIError{}class UnprocessableEntityError extends APIError{}class RateLimitError extends APIError{}class InternalServerError extends APIError{}class LengthFinishReasonError extends OpenAIError{constructor(){super("Could not parse response content as the length limit was reached")}}class ContentFilterFinishReasonError extends OpenAIError{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}const t=/^[a-z][a-z0-9+.-]*:/i;let isArray=e=>(isArray=Array.isArray,isArray(e)),s=isArray;function isObj(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)}const sleep=e=>new Promise(t=>setTimeout(t,e)),n="5.5.1";const getPlatformProperties=()=>{const e=function getDetectedPlatform(){return"undefined"!=typeof Deno&&null!=Deno.build?"deno":"undefined"!=typeof EdgeRuntime?"edge":"[object process]"===Object.prototype.toString.call(void 0!==globalThis.process?globalThis.process:0)?"node":"unknown"}();if("deno"===e)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":n,"X-Stainless-OS":normalizePlatform(Deno.build.os),"X-Stainless-Arch":normalizeArch(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":n,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if("node"===e)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":n,"X-Stainless-OS":normalizePlatform(globalThis.process.platform??"unknown"),"X-Stainless-Arch":normalizeArch(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};const t=function getBrowserInfo(){if("undefined"==typeof navigator||!navigator)return null;const e=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:t,pattern:s}of e){const e=s.exec(navigator.userAgent);if(e){return{browser:t,version:`${e[1]||0}.${e[2]||0}.${e[3]||0}`}}}return null}();return t?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":n,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${t.browser}`,"X-Stainless-Runtime-Version":t.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":n,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};const normalizeArch=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",normalizePlatform=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown";let r;function makeReadableStream(...e){const t=globalThis.ReadableStream;if(void 0===t)throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new t(...e)}function ReadableStreamFrom(e){let t=Symbol.asyncIterator in e?e[Symbol.asyncIterator]():e[Symbol.iterator]();return makeReadableStream({start(){},async pull(e){const{done:s,value:n}=await t.next();s?e.close():e.enqueue(n)},async cancel(){await(t.return?.())}})}function ReadableStreamToAsyncIterable(e){if(e[Symbol.asyncIterator])return e;const t=e.getReader();return{async next(){try{const e=await t.read();return e?.done&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){const e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}const FallbackEncoder=({headers:e,body:t})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(t)}),a="RFC3986",default_formatter=e=>String(e),o={RFC1738:e=>String(e).replace(/%20/g,"+"),RFC3986:default_formatter};let has=(e,t)=>(has=Object.hasOwn??Function.prototype.call.bind(Object.prototype.hasOwnProperty),has(e,t));const i=(()=>{const e=[];for(let t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e})(),l=1024;function maybe_map(e,t){if(isArray(e)){const s=[];for(let n=0;n<e.length;n+=1)s.push(t(e[n]));return s}return t(e)}const c={brackets:e=>String(e)+"[]",comma:"comma",indices:(e,t)=>String(e)+"["+t+"]",repeat:e=>String(e)},push_to_array=function(e,t){Array.prototype.push.apply(e,isArray(t)?t:[t])};let u;const d={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:(e,t,s,n,r)=>{if(0===e.length)return e;let a=e;if("symbol"==typeof e?a=Symbol.prototype.toString.call(e):"string"!=typeof e&&(a=String(e)),"iso-8859-1"===s)return escape(a).replace(/%u[0-9a-f]{4}/gi,function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"});let o="";for(let c=0;c<a.length;c+=l){const e=a.length>=l?a.slice(c,c+l):a,t=[];for(let s=0;s<e.length;++s){let n=e.charCodeAt(s);45===n||46===n||95===n||126===n||n>=48&&n<=57||n>=65&&n<=90||n>=97&&n<=122||"RFC1738"===r&&(40===n||41===n)?t[t.length]=e.charAt(s):n<128?t[t.length]=i[n]:n<2048?t[t.length]=i[192|n>>6]+i[128|63&n]:n<55296||n>=57344?t[t.length]=i[224|n>>12]+i[128|n>>6&63]+i[128|63&n]:(s+=1,n=65536+((1023&n)<<10|1023&e.charCodeAt(s)),t[t.length]=i[240|n>>18]+i[128|n>>12&63]+i[128|n>>6&63]+i[128|63&n])}o+=t.join("")}return o},encodeValuesOnly:!1,format:a,formatter:default_formatter,indices:!1,serializeDate:e=>(u??(u=Function.prototype.call.bind(Date.prototype.toISOString)))(e),skipNulls:!1,strictNullHandling:!1};const h={};function inner_stringify(e,t,s,n,r,a,o,i,l,c,u,p,f,m,_,g,y,b){let w=e,v=b,P=0,A=!1;for(;void 0!==(v=v.get(h))&&!A;){const t=v.get(e);if(P+=1,void 0!==t){if(t===P)throw new RangeError("Cyclic object value");A=!0}void 0===v.get(h)&&(P=0)}if("function"==typeof c?w=c(t,w):w instanceof Date?w=f?.(w):"comma"===s&&isArray(w)&&(w=maybe_map(w,function(e){return e instanceof Date?f?.(e):e})),null===w){if(a)return l&&!g?l(t,d.encoder,y,"key",m):t;w=""}if(function is_non_nullish_primitive(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e||"symbol"==typeof e||"bigint"==typeof e}(w)||function is_buffer(e){return!(!e||"object"!=typeof e||!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e)))}(w)){if(l){const e=g?t:l(t,d.encoder,y,"key",m);return[_?.(e)+"="+_?.(l(w,d.encoder,y,"value",m))]}return[_?.(t)+"="+_?.(String(w))]}const I=[];if(void 0===w)return I;let S;if("comma"===s&&isArray(w))g&&l&&(w=maybe_map(w,l)),S=[{value:w.length>0?w.join(",")||null:void 0}];else if(isArray(c))S=c;else{const e=Object.keys(w);S=u?e.sort(u):e}const F=i?String(t).replace(/\./g,"%2E"):String(t),R=n&&isArray(w)&&1===w.length?F+"[]":F;if(r&&isArray(w)&&0===w.length)return R+"[]";for(let d=0;d<S.length;++d){const t=S[d],v="object"==typeof t&&void 0!==t.value?t.value:w[t];if(o&&null===v)continue;const A=p&&i?t.replace(/\./g,"%2E"):t,F=isArray(w)?"function"==typeof s?s(R,A):R:R+(p?"."+A:"["+A+"]");b.set(e,P);const E=new WeakMap;E.set(h,b),push_to_array(I,inner_stringify(v,F,s,n,r,a,o,i,"comma"===s&&g&&isArray(w)?null:l,c,u,p,f,m,_,g,y,E))}return I}function stringify(e,t={}){let s=e;const n=function normalize_stringify_options(e=d){if(void 0!==e.allowEmptyArrays&&"boolean"!=typeof e.allowEmptyArrays)throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(void 0!==e.encodeDotInKeys&&"boolean"!=typeof e.encodeDotInKeys)throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");const t=e.charset||d.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let s=a;if(void 0!==e.format){if(!has(o,e.format))throw new TypeError("Unknown format option provided.");s=e.format}const n=o[s];let r,i=d.filter;if(("function"==typeof e.filter||isArray(e.filter))&&(i=e.filter),r=e.arrayFormat&&e.arrayFormat in c?e.arrayFormat:"indices"in e?e.indices?"indices":"repeat":d.arrayFormat,"commaRoundTrip"in e&&"boolean"!=typeof e.commaRoundTrip)throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const l=void 0===e.allowDots?1==!!e.encodeDotInKeys||d.allowDots:!!e.allowDots;return{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:d.addQueryPrefix,allowDots:l,allowEmptyArrays:"boolean"==typeof e.allowEmptyArrays?!!e.allowEmptyArrays:d.allowEmptyArrays,arrayFormat:r,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:d.charsetSentinel,commaRoundTrip:!!e.commaRoundTrip,delimiter:void 0===e.delimiter?d.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:d.encode,encodeDotInKeys:"boolean"==typeof e.encodeDotInKeys?e.encodeDotInKeys:d.encodeDotInKeys,encoder:"function"==typeof e.encoder?e.encoder:d.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:d.encodeValuesOnly,filter:i,format:s,formatter:n,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:d.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:d.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:d.strictNullHandling}}(t);let r,i;"function"==typeof n.filter?(i=n.filter,s=i("",s)):isArray(n.filter)&&(i=n.filter,r=i);const l=[];if("object"!=typeof s||null===s)return"";const u=c[n.arrayFormat],h="comma"===u&&n.commaRoundTrip;r||(r=Object.keys(s)),n.sort&&r.sort(n.sort);const p=new WeakMap;for(let a=0;a<r.length;++a){const e=r[a];n.skipNulls&&null===s[e]||push_to_array(l,inner_stringify(s[e],e,u,h,n.allowEmptyArrays,n.strictNullHandling,n.skipNulls,n.encodeDotInKeys,n.encode?n.encoder:null,n.filter,n.sort,n.allowDots,n.serializeDate,n.format,n.formatter,n.encodeValuesOnly,n.charset,p))}const f=l.join(n.delimiter);let m=!0===n.addQueryPrefix?"?":"";return n.charsetSentinel&&("iso-8859-1"===n.charset?m+="utf8=%26%2310003%3B&":m+="utf8=%E2%9C%93&"),f.length>0?m+f:""}let p,f;function encodeUTF8(e){let t;return(p??(t=new globalThis.TextEncoder,p=t.encode.bind(t)))(e)}function decodeUTF8(e){let t;return(f??(t=new globalThis.TextDecoder,f=t.decode.bind(t)))(e)}var m,_;class LineDecoder{constructor(){m.set(this,void 0),_.set(this,void 0),__classPrivateFieldSet(this,m,new Uint8Array),__classPrivateFieldSet(this,_,null)}decode(e){if(null==e)return[];const t=e instanceof ArrayBuffer?new Uint8Array(e):"string"==typeof e?encodeUTF8(e):e;__classPrivateFieldSet(this,m,function concatBytes(e){let t=0;for(const r of e)t+=r.length;const s=new Uint8Array(t);let n=0;for(const r of e)s.set(r,n),n+=r.length;return s}([__classPrivateFieldGet(this,m,"f"),t]));const s=[];let n;for(;null!=(n=findNewlineIndex(__classPrivateFieldGet(this,m,"f"),__classPrivateFieldGet(this,_,"f")));){if(n.carriage&&null==__classPrivateFieldGet(this,_,"f")){__classPrivateFieldSet(this,_,n.index);continue}if(null!=__classPrivateFieldGet(this,_,"f")&&(n.index!==__classPrivateFieldGet(this,_,"f")+1||n.carriage)){s.push(decodeUTF8(__classPrivateFieldGet(this,m,"f").subarray(0,__classPrivateFieldGet(this,_,"f")-1))),__classPrivateFieldSet(this,m,__classPrivateFieldGet(this,m,"f").subarray(__classPrivateFieldGet(this,_,"f"))),__classPrivateFieldSet(this,_,null);continue}const e=null!==__classPrivateFieldGet(this,_,"f")?n.preceding-1:n.preceding,t=decodeUTF8(__classPrivateFieldGet(this,m,"f").subarray(0,e));s.push(t),__classPrivateFieldSet(this,m,__classPrivateFieldGet(this,m,"f").subarray(n.index)),__classPrivateFieldSet(this,_,null)}return s}flush(){return __classPrivateFieldGet(this,m,"f").length?this.decode("\n"):[]}}function findNewlineIndex(e,t){for(let s=t??0;s<e.length;s++){if(10===e[s])return{preceding:s,index:s+1,carriage:!1};if(13===e[s])return{preceding:s,index:s+1,carriage:!0}}return null}function findDoubleNewlineIndex(e){for(let t=0;t<e.length-1;t++){if(10===e[t]&&10===e[t+1])return t+2;if(13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return-1}m=new WeakMap,_=new WeakMap,LineDecoder.NEWLINE_CHARS=new Set(["\n","\r"]),LineDecoder.NEWLINE_REGEXP=/\r\n|[\n\r]/g;class Stream{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let s=!1;return new Stream(async function*iterator(){if(s)throw new OpenAIError("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let n=!1;try{for await(const s of async function*_iterSSEMessages(e,t){if(!e.body){if(t.abort(),void 0!==globalThis.navigator&&"ReactNative"===globalThis.navigator.product)throw new OpenAIError("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api");throw new OpenAIError("Attempted to iterate over a response with no body")}const s=new SSEDecoder,n=new LineDecoder,r=ReadableStreamToAsyncIterable(e.body);for await(const a of async function*iterSSEChunks(e){let t=new Uint8Array;for await(const s of e){if(null==s)continue;const e=s instanceof ArrayBuffer?new Uint8Array(s):"string"==typeof s?encodeUTF8(s):s;let n,r=new Uint8Array(t.length+e.length);for(r.set(t),r.set(e,t.length),t=r;-1!==(n=findDoubleNewlineIndex(t));)yield t.slice(0,n),t=t.slice(n)}t.length>0&&(yield t)}(r))for(const e of n.decode(a)){const t=s.decode(e);t&&(yield t)}for(const a of n.flush()){const e=s.decode(a);e&&(yield e)}}(e,t))if(!n)if(s.data.startsWith("[DONE]"))n=!0;else if(null===s.event||s.event.startsWith("response.")||s.event.startsWith("transcript.")){let t;try{t=JSON.parse(s.data)}catch(r){throw console.error("Could not parse message into JSON:",s.data),console.error("From chunk:",s.raw),r}if(t&&t.error)throw new APIError(void 0,t.error,void 0,e.headers);yield t}else{let e;try{e=JSON.parse(s.data)}catch(r){throw console.error("Could not parse message into JSON:",s.data),console.error("From chunk:",s.raw),r}if("error"==s.event)throw new APIError(void 0,e.error,e.message,void 0);yield{event:s.event,data:e}}n=!0}catch(r){if(isAbortError(r))return;throw r}finally{n||t.abort()}},t)}static fromReadableStream(e,t){let s=!1;return new Stream(async function*iterator(){if(s)throw new OpenAIError("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let n=!1;try{for await(const t of async function*iterLines(){const t=new LineDecoder,s=ReadableStreamToAsyncIterable(e);for await(const e of s)for(const s of t.decode(e))yield s;for(const e of t.flush())yield e}())n||t&&(yield JSON.parse(t));n=!0}catch(r){if(isAbortError(r))return;throw r}finally{n||t.abort()}},t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],s=this.iterator(),teeIterator=n=>({next:()=>{if(0===n.length){const n=s.next();e.push(n),t.push(n)}return n.shift()}});return[new Stream(()=>teeIterator(e),this.controller),new Stream(()=>teeIterator(t),this.controller)]}toReadableStream(){const e=this;let t;return makeReadableStream({async start(){t=e[Symbol.asyncIterator]()},async pull(e){try{const{value:s,done:n}=await t.next();if(n)return e.close();const r=encodeUTF8(JSON.stringify(s)+"\n");e.enqueue(r)}catch(s){e.error(s)}},async cancel(){await(t.return?.())}})}}class SSEDecoder{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,s,n]=function partition(e,t){const s=e.indexOf(t);if(-1!==s)return[e.substring(0,s),t,e.substring(s+t.length)];return[e,"",""]}(e,":");return n.startsWith(" ")&&(n=n.substring(1)),"event"===t?this.event=n:"data"===t&&this.data.push(n),null}}const g={off:0,error:200,warn:300,info:400,debug:500},parseLogLevel=(e,t,s)=>{if(e)return function hasOwn(e,t){return Object.prototype.hasOwnProperty.call(e,t)}(g,e)?e:void loggerFor(s).warn(`${t} was set to ${JSON.stringify(e)}, expected one of ${JSON.stringify(Object.keys(g))}`)};function noop(){}function makeLogFn(e,t,s){return!t||g[e]>g[s]?noop:t[e].bind(t)}const y={error:noop,warn:noop,info:noop,debug:noop};let b=new WeakMap;function loggerFor(e){const t=e.logger,s=e.logLevel??"off";if(!t)return y;const n=b.get(t);if(n&&n[0]===s)return n[1];const r={error:makeLogFn("error",t,s),warn:makeLogFn("warn",t,s),info:makeLogFn("info",t,s),debug:makeLogFn("debug",t,s)};return b.set(t,[s,r]),r}const formatRequestDetails=e=>(e.options&&(e.options={...e.options},delete e.options.headers),e.headers&&(e.headers=Object.fromEntries((e.headers instanceof Headers?[...e.headers]:Object.entries(e.headers)).map(([e,t])=>[e,"authorization"===e.toLowerCase()||"cookie"===e.toLowerCase()||"set-cookie"===e.toLowerCase()?"***":t]))),"retryOfRequestLogID"in e&&(e.retryOfRequestLogID&&(e.retryOf=e.retryOfRequestLogID),delete e.retryOfRequestLogID),e);async function defaultParseResponse(e,t){const{response:s,requestLogID:n,retryOfRequestLogID:r,startTime:a}=t,o=await(async()=>{if(t.options.stream)return loggerFor(e).debug("response",s.status,s.url,s.headers,s.body),t.options.__streamClass?t.options.__streamClass.fromSSEResponse(s,t.controller):Stream.fromSSEResponse(s,t.controller);if(204===s.status)return null;if(t.options.__binaryResponse)return s;const n=s.headers.get("content-type"),r=n?.split(";")[0]?.trim();if(r?.includes("application/json")||r?.endsWith("+json")){return addRequestID(await s.json(),s)}return await s.text()})();return loggerFor(e).debug(`[${n}] response parsed`,formatRequestDetails({retryOfRequestLogID:r,url:s.url,status:s.status,body:o,durationMs:Date.now()-a})),o}function addRequestID(e,t){return!e||"object"!=typeof e||Array.isArray(e)?e:Object.defineProperty(e,"_request_id",{value:t.headers.get("x-request-id"),enumerable:!1})}var w,v;class APIPromise extends Promise{constructor(e,t,s=defaultParseResponse){super(e=>{e(null)}),this.responsePromise=t,this.parseResponse=s,w.set(this,void 0),__classPrivateFieldSet(this,w,e)}_thenUnwrap(e){return new APIPromise(__classPrivateFieldGet(this,w,"f"),this.responsePromise,async(t,s)=>addRequestID(e(await this.parseResponse(t,s),s),s.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(__classPrivateFieldGet(this,w,"f"),e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}w=new WeakMap;class AbstractPage{constructor(e,t,s,n){v.set(this,void 0),__classPrivateFieldSet(this,v,e),this.options=n,this.response=t,this.body=s}hasNextPage(){return!!this.getPaginatedItems().length&&null!=this.nextPageRequestOptions()}async getNextPage(){const e=this.nextPageRequestOptions();if(!e)throw new OpenAIError("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await __classPrivateFieldGet(this,v,"f").requestAPIList(this.constructor,e)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(v=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class PagePromise extends APIPromise{constructor(e,t,s){super(e,t,async(e,t)=>new s(e,t.response,await defaultParseResponse(e,t),t.options))}async*[Symbol.asyncIterator](){const e=await(this);for await(const t of e)yield t}}class Page extends AbstractPage{constructor(e,t,s,n){super(e,t,s,n),this.data=s.data||[],this.object=s.object}getPaginatedItems(){return this.data??[]}nextPageRequestOptions(){return null}}class CursorPage extends AbstractPage{constructor(e,t,s,n){super(e,t,s,n),this.data=s.data||[],this.has_more=s.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return!1!==this.has_more&&super.hasNextPage()}nextPageRequestOptions(){const e=this.getPaginatedItems(),t=e[e.length-1]?.id;return t?{...this.options,query:{...(s=this.options.query,"object"!=typeof s?{}:s??{}),after:t}}:null;var s}}const checkFileSupport=()=>{if("undefined"==typeof File){const{process:e}=globalThis,t="string"==typeof e?.versions?.node&&parseInt(e.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(t?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function makeFile(e,t,s){return checkFileSupport(),new File(e,t??"unknown_file",s)}function getName(e){return("object"==typeof e&&null!==e&&("name"in e&&e.name&&String(e.name)||"url"in e&&e.url&&String(e.url)||"filename"in e&&e.filename&&String(e.filename)||"path"in e&&e.path&&String(e.path))||"").split(/[\\/]/).pop()||void 0}const isAsyncIterable=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],multipartFormRequestOptions=async(e,t)=>({...e,body:await createForm(e.body,t)}),P=new WeakMap;const createForm=async(e,t)=>{if(!(await function supportsFormData(e){const t="function"==typeof e?e:e.fetch,s=P.get(t);if(s)return s;const n=(async()=>{try{const e="Response"in t?t.Response:(await t("data:,")).constructor,s=new FormData;return s.toString()!==await new e(s).text()}catch{return!0}})();return P.set(t,n),n}(t)))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");const s=new FormData;return await Promise.all(Object.entries(e||{}).map(([e,t])=>addFormValue(s,e,t))),s},addFormValue=async(e,t,s)=>{if(void 0!==s){if(null==s)throw new TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if("string"==typeof s||"number"==typeof s||"boolean"==typeof s)e.append(t,String(s));else if(s instanceof Response)e.append(t,makeFile([await s.blob()],getName(s)));else if(isAsyncIterable(s))e.append(t,makeFile([await new Response(ReadableStreamFrom(s)).blob()],getName(s)));else if((e=>e instanceof Blob&&"name"in e)(s))e.append(t,s,getName(s));else if(Array.isArray(s))await Promise.all(s.map(s=>addFormValue(e,t+"[]",s)));else{if("object"!=typeof s)throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${s} instead`);await Promise.all(Object.entries(s).map(([s,n])=>addFormValue(e,`${t}[${s}]`,n)))}}},isBlobLike=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer;async function getBytes(e){let t=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(isBlobLike(e))t.push(e instanceof Blob?e:await e.arrayBuffer());else{if(!isAsyncIterable(e)){const t=e?.constructor?.name;throw new Error(`Unexpected data type: ${typeof e}${t?`; constructor: ${t}`:""}${function propsForError(e){if("object"!=typeof e||null===e)return"";const t=Object.getOwnPropertyNames(e);return`; props: [${t.map(e=>`"${e}"`).join(", ")}]`}(e)}`)}for await(const s of e)t.push(...await getBytes(s))}return t}class APIResource{constructor(e){this._client=e}}function encodeURIPath(e){return e.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}const A=((e=encodeURIPath)=>function path2(t,...s){if(1===t.length)return t[0];let n=!1;const r=t.reduce((t,r,a)=>(/[?#]/.test(r)&&(n=!0),t+r+(a===s.length?"":(n?encodeURIComponent:e)(String(s[a])))),""),a=r.split(/[?#]/,1)[0],o=[],i=/(?<=^|\/)(?:\.|%2e){1,2}(?=\/|$)/gi;let l;for(;null!==(l=i.exec(a));)o.push({start:l.index,length:l[0].length});if(o.length>0){let e=0;const t=o.reduce((t,s)=>{const n=" ".repeat(s.start-e),r="^".repeat(s.length);return e=s.start+s.length,t+n+r},"");throw new OpenAIError(`Path parameters result in path with invalid segments:\n${r}\n${t}`)}return r})(encodeURIPath);let I=class Messages extends APIResource{list(e,t={},s){return this._client.getAPIList(A`/chat/completions/${e}/messages`,CursorPage,{query:t,...s})}};function isRunnableFunctionWithParse(e){return"function"==typeof e.parse}const isAssistantMessage=e=>"assistant"===e?.role,isToolMessage=e=>"tool"===e?.role;var S,F,R,E,O,x,C,$,k,T,G,N,D,M,j,L,q,B,U,W,J;class EventStream{constructor(){S.add(this),this.controller=new AbortController,F.set(this,void 0),R.set(this,()=>{}),E.set(this,()=>{}),O.set(this,void 0),x.set(this,()=>{}),C.set(this,()=>{}),$.set(this,{}),k.set(this,!1),T.set(this,!1),G.set(this,!1),N.set(this,!1),__classPrivateFieldSet(this,F,new Promise((e,t)=>{__classPrivateFieldSet(this,R,e),__classPrivateFieldSet(this,E,t)})),__classPrivateFieldSet(this,O,new Promise((e,t)=>{__classPrivateFieldSet(this,x,e),__classPrivateFieldSet(this,C,t)})),__classPrivateFieldGet(this,F,"f").catch(()=>{}),__classPrivateFieldGet(this,O,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},__classPrivateFieldGet(this,S,"m",D).bind(this))},0)}_connected(){this.ended||(__classPrivateFieldGet(this,R,"f").call(this),this._emit("connect"))}get ended(){return __classPrivateFieldGet(this,k,"f")}get errored(){return __classPrivateFieldGet(this,T,"f")}get aborted(){return __classPrivateFieldGet(this,G,"f")}abort(){this.controller.abort()}on(e,t){return(__classPrivateFieldGet(this,$,"f")[e]||(__classPrivateFieldGet(this,$,"f")[e]=[])).push({listener:t}),this}off(e,t){const s=__classPrivateFieldGet(this,$,"f")[e];if(!s)return this;const n=s.findIndex(e=>e.listener===t);return n>=0&&s.splice(n,1),this}once(e,t){return(__classPrivateFieldGet(this,$,"f")[e]||(__classPrivateFieldGet(this,$,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,s)=>{__classPrivateFieldSet(this,N,!0),"error"!==e&&this.once("error",s),this.once(e,t)})}async done(){__classPrivateFieldSet(this,N,!0),await __classPrivateFieldGet(this,O,"f")}_emit(e,...t){if(__classPrivateFieldGet(this,k,"f"))return;"end"===e&&(__classPrivateFieldSet(this,k,!0),__classPrivateFieldGet(this,x,"f").call(this));const s=__classPrivateFieldGet(this,$,"f")[e];if(s&&(__classPrivateFieldGet(this,$,"f")[e]=s.filter(e=>!e.once),s.forEach(({listener:e})=>e(...t))),"abort"===e){const e=t[0];return __classPrivateFieldGet(this,N,"f")||s?.length||Promise.reject(e),__classPrivateFieldGet(this,E,"f").call(this,e),__classPrivateFieldGet(this,C,"f").call(this,e),void this._emit("end")}if("error"===e){const e=t[0];__classPrivateFieldGet(this,N,"f")||s?.length||Promise.reject(e),__classPrivateFieldGet(this,E,"f").call(this,e),__classPrivateFieldGet(this,C,"f").call(this,e),this._emit("end")}}_emitFinal(){}}function isAutoParsableResponseFormat(e){return"auto-parseable-response-format"===e?.$brand}function isAutoParsableTool$1(e){return"auto-parseable-tool"===e?.$brand}function parseChatCompletion(e,t){const s=e.choices.map(e=>{if("length"===e.finish_reason)throw new LengthFinishReasonError;if("content_filter"===e.finish_reason)throw new ContentFilterFinishReasonError;return{...e,message:{...e.message,...e.message.tool_calls?{tool_calls:e.message.tool_calls?.map(e=>function parseToolCall$1(e,t){const s=e.tools?.find(e=>e.function?.name===t.function.name);return{...t,function:{...t.function,parsed_arguments:isAutoParsableTool$1(s)?s.$parseRaw(t.function.arguments):s?.function.strict?JSON.parse(t.function.arguments):null}}}(t,e))??void 0}:void 0,parsed:e.message.content&&!e.message.refusal?parseResponseFormat(t,e.message.content):null}}});return{...e,choices:s}}function parseResponseFormat(e,t){if("json_schema"!==e.response_format?.type)return null;if("json_schema"===e.response_format?.type){if("$parseRaw"in e.response_format){return e.response_format.$parseRaw(t)}return JSON.parse(t)}return null}function shouldParseToolCall(e,t){if(!e)return!1;const s=e.tools?.find(e=>e.function?.name===t.function.name);return isAutoParsableTool$1(s)||s?.function.strict||!1}function hasAutoParseableInput$1(e){return!!isAutoParsableResponseFormat(e.response_format)||(e.tools?.some(e=>isAutoParsableTool$1(e)||"function"===e.type&&!0===e.function.strict)??!1)}F=new WeakMap,R=new WeakMap,E=new WeakMap,O=new WeakMap,x=new WeakMap,C=new WeakMap,$=new WeakMap,k=new WeakMap,T=new WeakMap,G=new WeakMap,N=new WeakMap,S=new WeakSet,D=function _EventStream_handleError2(e){if(__classPrivateFieldSet(this,T,!0),e instanceof Error&&"AbortError"===e.name&&(e=new APIUserAbortError),e instanceof APIUserAbortError)return __classPrivateFieldSet(this,G,!0),this._emit("abort",e);if(e instanceof OpenAIError)return this._emit("error",e);if(e instanceof Error){const t=new OpenAIError(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new OpenAIError(String(e)))};const X=10;class AbstractChatCompletionRunner extends EventStream{constructor(){super(...arguments),M.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t)if(this._emit("message",e),isToolMessage(e)&&e.content)this._emit("functionToolCallResult",e.content);else if(isAssistantMessage(e)&&e.tool_calls)for(const s of e.tool_calls)"function"===s.type&&this._emit("functionToolCall",s.function)}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new OpenAIError("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),__classPrivateFieldGet(this,M,"m",j).call(this)}async finalMessage(){return await this.done(),__classPrivateFieldGet(this,M,"m",L).call(this)}async finalFunctionToolCall(){return await this.done(),__classPrivateFieldGet(this,M,"m",q).call(this)}async finalFunctionToolCallResult(){return await this.done(),__classPrivateFieldGet(this,M,"m",B).call(this)}async totalUsage(){return await this.done(),__classPrivateFieldGet(this,M,"m",U).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=__classPrivateFieldGet(this,M,"m",L).call(this);t&&this._emit("finalMessage",t);const s=__classPrivateFieldGet(this,M,"m",j).call(this);s&&this._emit("finalContent",s);const n=__classPrivateFieldGet(this,M,"m",q).call(this);n&&this._emit("finalFunctionToolCall",n);const r=__classPrivateFieldGet(this,M,"m",B).call(this);null!=r&&this._emit("finalFunctionToolCallResult",r),this._chatCompletions.some(e=>e.usage)&&this._emit("totalUsage",__classPrivateFieldGet(this,M,"m",U).call(this))}async _createChatCompletion(e,t,s){const n=s?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),__classPrivateFieldGet(this,M,"m",W).call(this,t);const r=await e.chat.completions.create({...t,stream:!1},{...s,signal:this.controller.signal});return this._connected(),this._addChatCompletion(parseChatCompletion(r,t))}async _runChatCompletion(e,t,s){for(const n of t.messages)this._addMessage(n,!1);return await this._createChatCompletion(e,t,s)}async _runTools(e,t,s){const n="tool",{tool_choice:r="auto",stream:a,...o}=t,i="string"!=typeof r&&r?.function?.name,{maxChatCompletions:l=X}=s||{},c=t.tools.map(e=>{if(isAutoParsableTool$1(e)){if(!e.$callback)throw new OpenAIError("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:e.$callback,name:e.function.name,description:e.function.description||"",parameters:e.function.parameters,parse:e.$parseRaw,strict:!0}}}return e}),u={};for(const p of c)"function"===p.type&&(u[p.function.name||p.function.function.name]=p.function);const d="tools"in t?c.map(e=>"function"===e.type?{type:"function",function:{name:e.function.name||e.function.function.name,parameters:e.function.parameters,description:e.function.description,strict:e.function.strict}}:e):void 0;for(const p of t.messages)this._addMessage(p,!1);for(let p=0;p<l;++p){const t=await this._createChatCompletion(e,{...o,tool_choice:r,tools:d,messages:[...this.messages]},s),a=t.choices[0]?.message;if(!a)throw new OpenAIError("missing message in ChatCompletion response");if(!a.tool_calls?.length)return;for(const e of a.tool_calls){if("function"!==e.type)continue;const t=e.id,{name:s,arguments:r}=e.function,a=u[s];if(!a){const e=`Invalid tool_call: ${JSON.stringify(s)}. Available options are: ${Object.keys(u).map(e=>JSON.stringify(e)).join(", ")}. Please try again`;this._addMessage({role:n,tool_call_id:t,content:e});continue}if(i&&i!==s){const e=`Invalid tool_call: ${JSON.stringify(s)}. ${JSON.stringify(i)} requested. Please try again`;this._addMessage({role:n,tool_call_id:t,content:e});continue}let o;try{o=isRunnableFunctionWithParse(a)?await a.parse(r):r}catch(h){const e=h instanceof Error?h.message:String(h);this._addMessage({role:n,tool_call_id:t,content:e});continue}const l=await a.function(o,this),c=__classPrivateFieldGet(this,M,"m",J).call(this,l);if(this._addMessage({role:n,tool_call_id:t,content:c}),i)return}}}}M=new WeakSet,j=function _AbstractChatCompletionRunner_getFinalContent2(){return __classPrivateFieldGet(this,M,"m",L).call(this).content??null},L=function _AbstractChatCompletionRunner_getFinalMessage2(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(isAssistantMessage(t)){return{...t,content:t.content??null,refusal:t.refusal??null}}}throw new OpenAIError("stream ended without producing a ChatCompletionMessage with role=assistant")},q=function _AbstractChatCompletionRunner_getFinalFunctionToolCall2(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(isAssistantMessage(t)&&t?.tool_calls?.length)return t.tool_calls.at(-1)?.function}},B=function _AbstractChatCompletionRunner_getFinalFunctionToolCallResult2(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(isToolMessage(t)&&null!=t.content&&"string"==typeof t.content&&this.messages.some(e=>"assistant"===e.role&&e.tool_calls?.some(e=>"function"===e.type&&e.id===t.tool_call_id)))return t.content}},U=function _AbstractChatCompletionRunner_calculateTotalUsage2(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},W=function _AbstractChatCompletionRunner_validateParams2(e){if(null!=e.n&&e.n>1)throw new OpenAIError("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},J=function _AbstractChatCompletionRunner_stringifyFunctionCallResult2(e){return"string"==typeof e?e:void 0===e?"undefined":JSON.stringify(e)};class ChatCompletionRunner extends AbstractChatCompletionRunner{static runTools(e,t,s){const n=new ChatCompletionRunner,r={...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"runTools"}};return n._run(()=>n._runTools(e,t,r)),n}_addMessage(e,t=!0){super._addMessage(e,t),isAssistantMessage(e)&&e.content&&this._emit("content",e.content)}}const H=1,z=2,K=4,V=8,Q=16,Y=32,Z=64,ee=128,te=256,se=511;class PartialJSON extends Error{}class MalformedJSON extends Error{}const _parseJSON=(e,t)=>{const s=e.length;let n=0;const markPartialJSON=e=>{throw new PartialJSON(`${e} at position ${n}`)},throwMalformedError=e=>{throw new MalformedJSON(`${e} at position ${n}`)},parseAny=()=>(skipBlank(),n>=s&&markPartialJSON("Unexpected end of input"),'"'===e[n]?parseStr():"{"===e[n]?parseObj():"["===e[n]?parseArr():"null"===e.substring(n,n+4)||Q&t&&s-n<4&&"null".startsWith(e.substring(n))?(n+=4,null):"true"===e.substring(n,n+4)||Y&t&&s-n<4&&"true".startsWith(e.substring(n))?(n+=4,!0):"false"===e.substring(n,n+5)||Y&t&&s-n<5&&"false".startsWith(e.substring(n))?(n+=5,!1):"Infinity"===e.substring(n,n+8)||ee&t&&s-n<8&&"Infinity".startsWith(e.substring(n))?(n+=8,1/0):"-Infinity"===e.substring(n,n+9)||te&t&&1<s-n&&s-n<9&&"-Infinity".startsWith(e.substring(n))?(n+=9,-1/0):"NaN"===e.substring(n,n+3)||Z&t&&s-n<3&&"NaN".startsWith(e.substring(n))?(n+=3,NaN):parseNum()),parseStr=()=>{const r=n;let a=!1;for(n++;n<s&&('"'!==e[n]||a&&"\\"===e[n-1]);)a="\\"===e[n]&&!a,n++;if('"'==e.charAt(n))try{return JSON.parse(e.substring(r,++n-Number(a)))}catch(o){throwMalformedError(String(o))}else if(H&t)try{return JSON.parse(e.substring(r,n-Number(a))+'"')}catch(o){return JSON.parse(e.substring(r,e.lastIndexOf("\\"))+'"')}markPartialJSON("Unterminated string literal")},parseObj=()=>{n++,skipBlank();const r={};try{for(;"}"!==e[n];){if(skipBlank(),n>=s&&V&t)return r;const o=parseStr();skipBlank(),n++;try{const e=parseAny();Object.defineProperty(r,o,{value:e,writable:!0,enumerable:!0,configurable:!0})}catch(a){if(V&t)return r;throw a}skipBlank(),","===e[n]&&n++}}catch(a){if(V&t)return r;markPartialJSON("Expected '}' at end of object")}return n++,r},parseArr=()=>{n++;const s=[];try{for(;"]"!==e[n];)s.push(parseAny()),skipBlank(),","===e[n]&&n++}catch(r){if(K&t)return s;markPartialJSON("Expected ']' at end of array")}return n++,s},parseNum=()=>{if(0===n){"-"===e&&z&t&&markPartialJSON("Not sure what '-' is");try{return JSON.parse(e)}catch(a){if(z&t)try{return"."===e[e.length-1]?JSON.parse(e.substring(0,e.lastIndexOf("."))):JSON.parse(e.substring(0,e.lastIndexOf("e")))}catch(o){}throwMalformedError(String(a))}}const r=n;for("-"===e[n]&&n++;e[n]&&!",]}".includes(e[n]);)n++;n!=s||z&t||markPartialJSON("Unterminated number literal");try{return JSON.parse(e.substring(r,n))}catch(a){"-"===e.substring(r,n)&&z&t&&markPartialJSON("Not sure what '-' is");try{return JSON.parse(e.substring(r,e.lastIndexOf("e")))}catch(o){throwMalformedError(String(o))}}},skipBlank=()=>{for(;n<s&&" \n\r\t".includes(e[n]);)n++};return parseAny()},partialParse=e=>function parseJSON(e,t=se){if("string"!=typeof e)throw new TypeError("expecting str, got "+typeof e);if(!e.trim())throw new Error(`${e} is empty`);return _parseJSON(e.trim(),t)}(e,se^z);var ne,re,ae,oe,ie,le,ce,ue,de,he,pe,fe;class ChatCompletionStream extends AbstractChatCompletionRunner{constructor(e){super(),ne.add(this),re.set(this,void 0),ae.set(this,void 0),oe.set(this,void 0),__classPrivateFieldSet(this,re,e),__classPrivateFieldSet(this,ae,[])}get currentChatCompletionSnapshot(){return __classPrivateFieldGet(this,oe,"f")}static fromReadableStream(e){const t=new ChatCompletionStream(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,s){const n=new ChatCompletionStream(t);return n._run(()=>n._runChatCompletion(e,{...t,stream:!0},{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),n}async _createChatCompletion(e,t,s){super._createChatCompletion;const n=s?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),__classPrivateFieldGet(this,ne,"m",ie).call(this);const r=await e.chat.completions.create({...t,stream:!0},{...s,signal:this.controller.signal});this._connected();for await(const a of r)__classPrivateFieldGet(this,ne,"m",ce).call(this,a);if(r.controller.signal?.aborted)throw new APIUserAbortError;return this._addChatCompletion(__classPrivateFieldGet(this,ne,"m",he).call(this))}async _fromReadableStream(e,t){const s=t?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),__classPrivateFieldGet(this,ne,"m",ie).call(this),this._connected();const n=Stream.fromReadableStream(e,this.controller);let r;for await(const a of n)r&&r!==a.id&&this._addChatCompletion(__classPrivateFieldGet(this,ne,"m",he).call(this)),__classPrivateFieldGet(this,ne,"m",ce).call(this,a),r=a.id;if(n.controller.signal?.aborted)throw new APIUserAbortError;return this._addChatCompletion(__classPrivateFieldGet(this,ne,"m",he).call(this))}[(re=new WeakMap,ae=new WeakMap,oe=new WeakMap,ne=new WeakSet,ie=function _ChatCompletionStream_beginRequest2(){this.ended||__classPrivateFieldSet(this,oe,void 0)},le=function _ChatCompletionStream_getChoiceEventState2(e){let t=__classPrivateFieldGet(this,ae,"f")[e.index];return t||(t={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},__classPrivateFieldGet(this,ae,"f")[e.index]=t,t)},ce=function _ChatCompletionStream_addChunk2(e){if(this.ended)return;const t=__classPrivateFieldGet(this,ne,"m",fe).call(this,e);this._emit("chunk",e,t);for(const s of e.choices){const e=t.choices[s.index];null!=s.delta.content&&"assistant"===e.message?.role&&e.message?.content&&(this._emit("content",s.delta.content,e.message.content),this._emit("content.delta",{delta:s.delta.content,snapshot:e.message.content,parsed:e.message.parsed})),null!=s.delta.refusal&&"assistant"===e.message?.role&&e.message?.refusal&&this._emit("refusal.delta",{delta:s.delta.refusal,snapshot:e.message.refusal}),null!=s.logprobs?.content&&"assistant"===e.message?.role&&this._emit("logprobs.content.delta",{content:s.logprobs?.content,snapshot:e.logprobs?.content??[]}),null!=s.logprobs?.refusal&&"assistant"===e.message?.role&&this._emit("logprobs.refusal.delta",{refusal:s.logprobs?.refusal,snapshot:e.logprobs?.refusal??[]});const n=__classPrivateFieldGet(this,ne,"m",le).call(this,e);e.finish_reason&&(__classPrivateFieldGet(this,ne,"m",de).call(this,e),null!=n.current_tool_call_index&&__classPrivateFieldGet(this,ne,"m",ue).call(this,e,n.current_tool_call_index));for(const t of s.delta.tool_calls??[])n.current_tool_call_index!==t.index&&(__classPrivateFieldGet(this,ne,"m",de).call(this,e),null!=n.current_tool_call_index&&__classPrivateFieldGet(this,ne,"m",ue).call(this,e,n.current_tool_call_index)),n.current_tool_call_index=t.index;for(const t of s.delta.tool_calls??[]){const s=e.message.tool_calls?.[t.index];s?.type&&("function"===s?.type?this._emit("tool_calls.function.arguments.delta",{name:s.function?.name,index:t.index,arguments:s.function.arguments,parsed_arguments:s.function.parsed_arguments,arguments_delta:t.function?.arguments??""}):assertNever(s?.type))}}},ue=function _ChatCompletionStream_emitToolCallDoneEvent2(e,t){if(__classPrivateFieldGet(this,ne,"m",le).call(this,e).done_tool_calls.has(t))return;const s=e.message.tool_calls?.[t];if(!s)throw new Error("no tool call snapshot");if(!s.type)throw new Error("tool call snapshot missing `type`");if("function"===s.type){const e=__classPrivateFieldGet(this,re,"f")?.tools?.find(e=>"function"===e.type&&e.function.name===s.function.name);this._emit("tool_calls.function.arguments.done",{name:s.function.name,index:t,arguments:s.function.arguments,parsed_arguments:isAutoParsableTool$1(e)?e.$parseRaw(s.function.arguments):e?.function.strict?JSON.parse(s.function.arguments):null})}else s.type},de=function _ChatCompletionStream_emitContentDoneEvents2(e){const t=__classPrivateFieldGet(this,ne,"m",le).call(this,e);if(e.message.content&&!t.content_done){t.content_done=!0;const s=__classPrivateFieldGet(this,ne,"m",pe).call(this);this._emit("content.done",{content:e.message.content,parsed:s?s.$parseRaw(e.message.content):null})}e.message.refusal&&!t.refusal_done&&(t.refusal_done=!0,this._emit("refusal.done",{refusal:e.message.refusal})),e.logprobs?.content&&!t.logprobs_content_done&&(t.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:e.logprobs.content})),e.logprobs?.refusal&&!t.logprobs_refusal_done&&(t.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:e.logprobs.refusal}))},he=function _ChatCompletionStream_endRequest2(){if(this.ended)throw new OpenAIError("stream has ended, this shouldn't happen");const e=__classPrivateFieldGet(this,oe,"f");if(!e)throw new OpenAIError("request ended without sending any chunks");return __classPrivateFieldSet(this,oe,void 0),__classPrivateFieldSet(this,ae,[]),function finalizeChatCompletion(e,t){const{id:s,choices:n,created:r,model:a,system_fingerprint:o,...i}=e,l={...i,id:s,choices:n.map(({message:t,finish_reason:s,index:n,logprobs:r,...a})=>{if(!s)throw new OpenAIError(`missing finish_reason for choice ${n}`);const{content:o=null,function_call:i,tool_calls:l,...c}=t,u=t.role;if(!u)throw new OpenAIError(`missing role for choice ${n}`);if(i){const{arguments:e,name:l}=i;if(null==e)throw new OpenAIError(`missing function_call.arguments for choice ${n}`);if(!l)throw new OpenAIError(`missing function_call.name for choice ${n}`);return{...a,message:{content:o,function_call:{arguments:e,name:l},role:u,refusal:t.refusal??null},finish_reason:s,index:n,logprobs:r}}return l?{...a,index:n,finish_reason:s,logprobs:r,message:{...c,role:u,content:o,refusal:t.refusal??null,tool_calls:l.map((t,s)=>{const{function:r,type:a,id:o,...i}=t,{arguments:l,name:c,...u}=r||{};if(null==o)throw new OpenAIError(`missing choices[${n}].tool_calls[${s}].id\n${str(e)}`);if(null==a)throw new OpenAIError(`missing choices[${n}].tool_calls[${s}].type\n${str(e)}`);if(null==c)throw new OpenAIError(`missing choices[${n}].tool_calls[${s}].function.name\n${str(e)}`);if(null==l)throw new OpenAIError(`missing choices[${n}].tool_calls[${s}].function.arguments\n${str(e)}`);return{...i,id:o,type:a,function:{...u,name:c,arguments:l}}})}}:{...a,message:{...c,content:o,role:u,refusal:t.refusal??null},finish_reason:s,index:n,logprobs:r}}),created:r,model:a,object:"chat.completion",...o?{system_fingerprint:o}:{}};return function maybeParseChatCompletion(e,t){return t&&hasAutoParseableInput$1(t)?parseChatCompletion(e,t):{...e,choices:e.choices.map(e=>({...e,message:{...e.message,parsed:null,...e.message.tool_calls?{tool_calls:e.message.tool_calls}:void 0}}))}}(l,t)}(e,__classPrivateFieldGet(this,re,"f"))},pe=function _ChatCompletionStream_getAutoParseableResponseFormat2(){const e=__classPrivateFieldGet(this,re,"f")?.response_format;return isAutoParsableResponseFormat(e)?e:null},fe=function _ChatCompletionStream_accumulateChatCompletion2(e){var t,s,n,r;let a=__classPrivateFieldGet(this,oe,"f");const{choices:o,...i}=e;a?Object.assign(a,i):a=__classPrivateFieldSet(this,oe,{...i,choices:[]});for(const{delta:l,finish_reason:c,index:u,logprobs:d=null,...h}of e.choices){let e=a.choices[u];if(e||(e=a.choices[u]={finish_reason:c,index:u,message:{},logprobs:d,...h}),d)if(e.logprobs){const{content:n,refusal:r,...a}=d;Object.assign(e.logprobs,a),n&&((t=e.logprobs).content??(t.content=[]),e.logprobs.content.push(...n)),r&&((s=e.logprobs).refusal??(s.refusal=[]),e.logprobs.refusal.push(...r))}else e.logprobs=Object.assign({},d);if(c&&(e.finish_reason=c,__classPrivateFieldGet(this,re,"f")&&hasAutoParseableInput$1(__classPrivateFieldGet(this,re,"f")))){if("length"===c)throw new LengthFinishReasonError;if("content_filter"===c)throw new ContentFilterFinishReasonError}if(Object.assign(e,h),!l)continue;const{content:o,refusal:i,function_call:p,role:f,tool_calls:m,..._}=l;if(Object.assign(e.message,_),i&&(e.message.refusal=(e.message.refusal||"")+i),f&&(e.message.role=f),p&&(e.message.function_call?(p.name&&(e.message.function_call.name=p.name),p.arguments&&((n=e.message.function_call).arguments??(n.arguments=""),e.message.function_call.arguments+=p.arguments)):e.message.function_call=p),o&&(e.message.content=(e.message.content||"")+o,!e.message.refusal&&__classPrivateFieldGet(this,ne,"m",pe).call(this)&&(e.message.parsed=partialParse(e.message.content))),m){e.message.tool_calls||(e.message.tool_calls=[]);for(const{index:t,id:s,type:n,function:a,...o}of m){const i=(r=e.message.tool_calls)[t]??(r[t]={});Object.assign(i,o),s&&(i.id=s),n&&(i.type=n),a&&(i.function??(i.function={name:a.name??"",arguments:""})),a?.name&&(i.function.name=a.name),a?.arguments&&(i.function.arguments+=a.arguments,shouldParseToolCall(__classPrivateFieldGet(this,re,"f"),i)&&(i.function.parsed_arguments=partialParse(i.function.arguments)))}}}return a},Symbol.asyncIterator)](){const e=[],t=[];let s=!1;return this.on("chunk",s=>{const n=t.shift();n?n.resolve(s):e.push(s)}),this.on("end",()=>{s=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{s=!0;for(const s of t)s.reject(e);t.length=0}),this.on("error",e=>{s=!0;for(const s of t)s.reject(e);t.length=0}),{next:async()=>{if(!e.length)return s?{value:void 0,done:!0}:new Promise((e,s)=>t.push({resolve:e,reject:s})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0});return{value:e.shift(),done:!1}},return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Stream(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function str(e){return JSON.stringify(e)}function assertNever(e){}class ChatCompletionStreamingRunner extends ChatCompletionStream{static fromReadableStream(e){const t=new ChatCompletionStreamingRunner(null);return t._run(()=>t._fromReadableStream(e)),t}static runTools(e,t,s){const n=new ChatCompletionStreamingRunner(t),r={...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"runTools"}};return n._run(()=>n._runTools(e,t,r)),n}}let me=class Completions extends APIResource{constructor(){super(...arguments),this.messages=new I(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(A`/chat/completions/${e}`,t)}update(e,t,s){return this._client.post(A`/chat/completions/${e}`,{body:t,...s})}list(e={},t){return this._client.getAPIList("/chat/completions",CursorPage,{query:e,...t})}delete(e,t){return this._client.delete(A`/chat/completions/${e}`,t)}parse(e,t){return function validateInputTools(e){for(const t of e??[]){if("function"!==t.type)throw new OpenAIError(`Currently only \`function\` tool types support auto-parsing; Received \`${t.type}\``);if(!0!==t.function.strict)throw new OpenAIError(`The \`${t.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"chat.completions.parse"}})._thenUnwrap(t=>parseChatCompletion(t,e))}runTools(e,t){return e.stream?ChatCompletionStreamingRunner.runTools(this._client,e,t):ChatCompletionRunner.runTools(this._client,e,t)}stream(e,t){return ChatCompletionStream.createChatCompletion(this._client,e,t)}};me.Messages=I;class Chat extends APIResource{constructor(){super(...arguments),this.completions=new me(this._client)}}Chat.Completions=me;const _e=Symbol("brand.privateNullableHeaders");function*iterateHeaders(e){if(!e)return;if(_e in e){const{values:t,nulls:s}=e;yield*t.entries();for(const e of s)yield[e,null];return}let t,n=!1;e instanceof Headers?t=e.entries():s(e)?t=e:(n=!0,t=Object.entries(e??{}));for(let r of t){const e=r[0];if("string"!=typeof e)throw new TypeError("expected header name to be a string");const t=s(r[1])?r[1]:[r[1]];let a=!1;for(const s of t)void 0!==s&&(n&&!a&&(a=!0,yield[e,null]),yield[e,s])}}const buildHeaders=e=>{const t=new Headers,s=new Set;for(const n of e){const e=new Set;for(const[r,a]of iterateHeaders(n)){const n=r.toLowerCase();e.has(n)||(t.delete(r),e.add(n)),null===a?(t.delete(r),s.add(n)):(t.append(r,a),s.delete(n))}}return{[_e]:!0,values:t,nulls:s}};class Speech extends APIResource{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:buildHeaders([{Accept:"application/octet-stream"},t?.headers]),__binaryResponse:!0})}}class Transcriptions extends APIResource{create(e,t){return this._client.post("/audio/transcriptions",multipartFormRequestOptions({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}},this._client))}}class Translations extends APIResource{create(e,t){return this._client.post("/audio/translations",multipartFormRequestOptions({body:e,...t,__metadata:{model:e.model}},this._client))}}class Audio extends APIResource{constructor(){super(...arguments),this.transcriptions=new Transcriptions(this._client),this.translations=new Translations(this._client),this.speech=new Speech(this._client)}}Audio.Transcriptions=Transcriptions,Audio.Translations=Translations,Audio.Speech=Speech;class Batches extends APIResource{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(A`/batches/${e}`,t)}list(e={},t){return this._client.getAPIList("/batches",CursorPage,{query:e,...t})}cancel(e,t){return this._client.post(A`/batches/${e}/cancel`,t)}}class Assistants extends APIResource{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(A`/assistants/${e}`,{...t,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,s){return this._client.post(A`/assistants/${e}`,{body:t,...s,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e={},t){return this._client.getAPIList("/assistants",CursorPage,{query:e,...t,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}delete(e,t){return this._client.delete(A`/assistants/${e}`,{...t,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}}class Sessions extends APIResource{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}}class TranscriptionSessions extends APIResource{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}}class Realtime extends APIResource{constructor(){super(...arguments),this.sessions=new Sessions(this._client),this.transcriptionSessions=new TranscriptionSessions(this._client)}}Realtime.Sessions=Sessions,Realtime.TranscriptionSessions=TranscriptionSessions;class Messages2 extends APIResource{create(e,t,s){return this._client.post(A`/threads/${e}/messages`,{body:t,...s,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}retrieve(e,t,s){const{thread_id:n}=t;return this._client.get(A`/threads/${n}/messages/${e}`,{...s,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}update(e,t,s){const{thread_id:n,...r}=t;return this._client.post(A`/threads/${n}/messages/${e}`,{body:r,...s,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e,t={},s){return this._client.getAPIList(A`/threads/${e}/messages`,CursorPage,{query:t,...s,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}delete(e,t,s){const{thread_id:n}=t;return this._client.delete(A`/threads/${n}/messages/${e}`,{...s,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}}class Steps extends APIResource{retrieve(e,t,s){const{thread_id:n,run_id:r,...a}=t;return this._client.get(A`/threads/${n}/runs/${r}/steps/${e}`,{query:a,...s,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e,t,s){const{thread_id:n,...r}=t;return this._client.getAPIList(A`/threads/${n}/runs/${e}/steps`,CursorPage,{query:r,...s,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}}var ge={};const readEnv=e=>void 0!==globalThis.process?ge?.[e]?.trim()??void 0:void 0!==globalThis.Deno?globalThis.Deno.env?.get?.(e)?.trim():void 0;var ye,be,we,ve,Pe,Ae,Ie,Se,Fe,Re,Ee,Oe,xe,Ce,$e,ke,Te,Ge,Ne,De,Me,je,Le;class AssistantStream extends EventStream{constructor(){super(...arguments),ye.add(this),we.set(this,[]),ve.set(this,{}),Pe.set(this,{}),Ae.set(this,void 0),Ie.set(this,void 0),Se.set(this,void 0),Fe.set(this,void 0),Re.set(this,void 0),Ee.set(this,void 0),Oe.set(this,void 0),xe.set(this,void 0),Ce.set(this,void 0)}[(we=new WeakMap,ve=new WeakMap,Pe=new WeakMap,Ae=new WeakMap,Ie=new WeakMap,Se=new WeakMap,Fe=new WeakMap,Re=new WeakMap,Ee=new WeakMap,Oe=new WeakMap,xe=new WeakMap,Ce=new WeakMap,ye=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let s=!1;return this.on("event",s=>{const n=t.shift();n?n.resolve(s):e.push(s)}),this.on("end",()=>{s=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{s=!0;for(const s of t)s.reject(e);t.length=0}),this.on("error",e=>{s=!0;for(const s of t)s.reject(e);t.length=0}),{next:async()=>{if(!e.length)return s?{value:void 0,done:!0}:new Promise((e,s)=>t.push({resolve:e,reject:s})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0});return{value:e.shift(),done:!1}},return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new be;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){const s=t?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),this._connected();const n=Stream.fromReadableStream(e,this.controller);for await(const r of n)__classPrivateFieldGet(this,ye,"m",$e).call(this,r);if(n.controller.signal?.aborted)throw new APIUserAbortError;return this._addRun(__classPrivateFieldGet(this,ye,"m",ke).call(this))}toReadableStream(){return new Stream(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,s,n){const r=new be;return r._run(()=>r._runToolAssistantStream(e,t,s,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),r}async _createToolAssistantStream(e,t,s,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort()));const a={...s,stream:!0},o=await e.submitToolOutputs(t,a,{...n,signal:this.controller.signal});this._connected();for await(const i of o)__classPrivateFieldGet(this,ye,"m",$e).call(this,i);if(o.controller.signal?.aborted)throw new APIUserAbortError;return this._addRun(__classPrivateFieldGet(this,ye,"m",ke).call(this))}static createThreadAssistantStream(e,t,s){const n=new be;return n._run(()=>n._threadAssistantStream(e,t,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),n}static createAssistantStream(e,t,s,n){const r=new be;return r._run(()=>r._runAssistantStream(e,t,s,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),r}currentEvent(){return __classPrivateFieldGet(this,Oe,"f")}currentRun(){return __classPrivateFieldGet(this,xe,"f")}currentMessageSnapshot(){return __classPrivateFieldGet(this,Ae,"f")}currentRunStepSnapshot(){return __classPrivateFieldGet(this,Ce,"f")}async finalRunSteps(){return await this.done(),Object.values(__classPrivateFieldGet(this,ve,"f"))}async finalMessages(){return await this.done(),Object.values(__classPrivateFieldGet(this,Pe,"f"))}async finalRun(){if(await this.done(),!__classPrivateFieldGet(this,Ie,"f"))throw Error("Final run was not received.");return __classPrivateFieldGet(this,Ie,"f")}async _createThreadAssistantStream(e,t,s){const n=s?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort()));const r={...t,stream:!0},a=await e.createAndRun(r,{...s,signal:this.controller.signal});this._connected();for await(const o of a)__classPrivateFieldGet(this,ye,"m",$e).call(this,o);if(a.controller.signal?.aborted)throw new APIUserAbortError;return this._addRun(__classPrivateFieldGet(this,ye,"m",ke).call(this))}async _createAssistantStream(e,t,s,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort()));const a={...s,stream:!0},o=await e.create(t,a,{...n,signal:this.controller.signal});this._connected();for await(const i of o)__classPrivateFieldGet(this,ye,"m",$e).call(this,i);if(o.controller.signal?.aborted)throw new APIUserAbortError;return this._addRun(__classPrivateFieldGet(this,ye,"m",ke).call(this))}static accumulateDelta(e,t){for(const[s,n]of Object.entries(t)){if(!e.hasOwnProperty(s)){e[s]=n;continue}let t=e[s];if(null!=t)if("index"!==s&&"type"!==s){if("string"==typeof t&&"string"==typeof n)t+=n;else if("number"==typeof t&&"number"==typeof n)t+=n;else{if(!isObj(t)||!isObj(n)){if(Array.isArray(t)&&Array.isArray(n)){if(t.every(e=>"string"==typeof e||"number"==typeof e)){t.push(...n);continue}for(const e of n){if(!isObj(e))throw new Error(`Expected array delta entry to be an object but got: ${e}`);const s=e.index;if(null==s)throw console.error(e),new Error("Expected array delta entry to have an `index` property");if("number"!=typeof s)throw new Error(`Expected array delta entry \`index\` property to be a number but got ${s}`);const n=t[s];null==n?t.push(e):t[s]=this.accumulateDelta(n,e)}continue}throw Error(`Unhandled record type: ${s}, deltaValue: ${n}, accValue: ${t}`)}t=this.accumulateDelta(t,n)}e[s]=t}else e[s]=n;else e[s]=n}return e}_addRun(e){return e}async _threadAssistantStream(e,t,s){return await this._createThreadAssistantStream(t,e,s)}async _runAssistantStream(e,t,s,n){return await this._createAssistantStream(t,e,s,n)}async _runToolAssistantStream(e,t,s,n){return await this._createToolAssistantStream(t,e,s,n)}}be=AssistantStream,$e=function _AssistantStream_addEvent2(e){if(!this.ended)switch(__classPrivateFieldSet(this,Oe,e),__classPrivateFieldGet(this,ye,"m",Ne).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":__classPrivateFieldGet(this,ye,"m",Le).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":__classPrivateFieldGet(this,ye,"m",Ge).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":__classPrivateFieldGet(this,ye,"m",Te).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},ke=function _AssistantStream_endRequest2(){if(this.ended)throw new OpenAIError("stream has ended, this shouldn't happen");if(!__classPrivateFieldGet(this,Ie,"f"))throw Error("Final run has not been received");return __classPrivateFieldGet(this,Ie,"f")},Te=function _AssistantStream_handleMessage2(e){const[t,s]=__classPrivateFieldGet(this,ye,"m",Me).call(this,e,__classPrivateFieldGet(this,Ae,"f"));__classPrivateFieldSet(this,Ae,t),__classPrivateFieldGet(this,Pe,"f")[t.id]=t;for(const n of s){const e=t.content[n.index];"text"==e?.type&&this._emit("textCreated",e.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const s of e.data.delta.content){if("text"==s.type&&s.text){let e=s.text,n=t.content[s.index];if(!n||"text"!=n.type)throw Error("The snapshot associated with this text delta is not text or missing");this._emit("textDelta",e,n.text)}if(s.index!=__classPrivateFieldGet(this,Se,"f")){if(__classPrivateFieldGet(this,Fe,"f"))switch(__classPrivateFieldGet(this,Fe,"f").type){case"text":this._emit("textDone",__classPrivateFieldGet(this,Fe,"f").text,__classPrivateFieldGet(this,Ae,"f"));break;case"image_file":this._emit("imageFileDone",__classPrivateFieldGet(this,Fe,"f").image_file,__classPrivateFieldGet(this,Ae,"f"))}__classPrivateFieldSet(this,Se,s.index)}__classPrivateFieldSet(this,Fe,t.content[s.index])}break;case"thread.message.completed":case"thread.message.incomplete":if(void 0!==__classPrivateFieldGet(this,Se,"f")){const t=e.data.content[__classPrivateFieldGet(this,Se,"f")];if(t)switch(t.type){case"image_file":this._emit("imageFileDone",t.image_file,__classPrivateFieldGet(this,Ae,"f"));break;case"text":this._emit("textDone",t.text,__classPrivateFieldGet(this,Ae,"f"))}}__classPrivateFieldGet(this,Ae,"f")&&this._emit("messageDone",e.data),__classPrivateFieldSet(this,Ae,void 0)}},Ge=function _AssistantStream_handleRunStep2(e){const t=__classPrivateFieldGet(this,ye,"m",De).call(this,e);switch(__classPrivateFieldSet(this,Ce,t),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const s=e.data.delta;if(s.step_details&&"tool_calls"==s.step_details.type&&s.step_details.tool_calls&&"tool_calls"==t.step_details.type)for(const e of s.step_details.tool_calls)e.index==__classPrivateFieldGet(this,Re,"f")?this._emit("toolCallDelta",e,t.step_details.tool_calls[e.index]):(__classPrivateFieldGet(this,Ee,"f")&&this._emit("toolCallDone",__classPrivateFieldGet(this,Ee,"f")),__classPrivateFieldSet(this,Re,e.index),__classPrivateFieldSet(this,Ee,t.step_details.tool_calls[e.index]),__classPrivateFieldGet(this,Ee,"f")&&this._emit("toolCallCreated",__classPrivateFieldGet(this,Ee,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":__classPrivateFieldSet(this,Ce,void 0);"tool_calls"==e.data.step_details.type&&__classPrivateFieldGet(this,Ee,"f")&&(this._emit("toolCallDone",__classPrivateFieldGet(this,Ee,"f")),__classPrivateFieldSet(this,Ee,void 0)),this._emit("runStepDone",e.data,t)}},Ne=function _AssistantStream_handleEvent2(e){__classPrivateFieldGet(this,we,"f").push(e),this._emit("event",e)},De=function _AssistantStream_accumulateRunStep2(e){switch(e.event){case"thread.run.step.created":return __classPrivateFieldGet(this,ve,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=__classPrivateFieldGet(this,ve,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let s=e.data;if(s.delta){const n=be.accumulateDelta(t,s.delta);__classPrivateFieldGet(this,ve,"f")[e.data.id]=n}return __classPrivateFieldGet(this,ve,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":__classPrivateFieldGet(this,ve,"f")[e.data.id]=e.data}if(__classPrivateFieldGet(this,ve,"f")[e.data.id])return __classPrivateFieldGet(this,ve,"f")[e.data.id];throw new Error("No snapshot available")},Me=function _AssistantStream_accumulateMessage2(e,t){let s=[];switch(e.event){case"thread.message.created":return[e.data,s];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let n=e.data;if(n.delta.content)for(const e of n.delta.content)if(e.index in t.content){let s=t.content[e.index];t.content[e.index]=__classPrivateFieldGet(this,ye,"m",je).call(this,e,s)}else t.content[e.index]=e,s.push(e);return[t,s];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,s];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},je=function _AssistantStream_accumulateContent2(e,t){return be.accumulateDelta(t,e)},Le=function _AssistantStream_handleRun2(e){switch(__classPrivateFieldSet(this,xe,e.data),e.event){case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":case"thread.run.incomplete":__classPrivateFieldSet(this,Ie,e.data),__classPrivateFieldGet(this,Ee,"f")&&(this._emit("toolCallDone",__classPrivateFieldGet(this,Ee,"f")),__classPrivateFieldSet(this,Ee,void 0))}};let qe=class Runs extends APIResource{constructor(){super(...arguments),this.steps=new Steps(this._client)}create(e,t,s){const{include:n,...r}=t;return this._client.post(A`/threads/${e}/runs`,{query:{include:n},body:r,...s,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},s?.headers]),stream:t.stream??!1})}retrieve(e,t,s){const{thread_id:n}=t;return this._client.get(A`/threads/${n}/runs/${e}`,{...s,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}update(e,t,s){const{thread_id:n,...r}=t;return this._client.post(A`/threads/${n}/runs/${e}`,{body:r,...s,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e,t={},s){return this._client.getAPIList(A`/threads/${e}/runs`,CursorPage,{query:t,...s,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}cancel(e,t,s){const{thread_id:n}=t;return this._client.post(A`/threads/${n}/runs/${e}/cancel`,{...s,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}async createAndPoll(e,t,s){const n=await this.create(e,t,s);return await this.poll(n.id,{thread_id:e},s)}createAndStream(e,t,s){return AssistantStream.createAssistantStream(e,this._client.beta.threads.runs,t,s)}async poll(e,t,s){const n=buildHeaders([s?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":s?.pollIntervalMs?.toString()??void 0}]);for(;;){const{data:r,response:a}=await this.retrieve(e,t,{...s,headers:{...s?.headers,...n}}).withResponse();switch(r.status){case"queued":case"in_progress":case"cancelling":let e=5e3;if(s?.pollIntervalMs)e=s.pollIntervalMs;else{const t=a.headers.get("openai-poll-after-ms");if(t){const s=parseInt(t);isNaN(s)||(e=s)}}await sleep(e);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return r}}}stream(e,t,s){return AssistantStream.createAssistantStream(e,this._client.beta.threads.runs,t,s)}submitToolOutputs(e,t,s){const{thread_id:n,...r}=t;return this._client.post(A`/threads/${n}/runs/${e}/submit_tool_outputs`,{body:r,...s,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},s?.headers]),stream:t.stream??!1})}async submitToolOutputsAndPoll(e,t,s){const n=await this.submitToolOutputs(e,t,s);return await this.poll(n.id,t,s)}submitToolOutputsStream(e,t,s){return AssistantStream.createToolAssistantStream(e,this._client.beta.threads.runs,t,s)}};qe.Steps=Steps;class Threads extends APIResource{constructor(){super(...arguments),this.runs=new qe(this._client),this.messages=new Messages2(this._client)}create(e={},t){return this._client.post("/threads",{body:e,...t,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(A`/threads/${e}`,{...t,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,s){return this._client.post(A`/threads/${e}`,{body:t,...s,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}delete(e,t){return this._client.delete(A`/threads/${e}`,{...t,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},t?.headers]),stream:e.stream??!1})}async createAndRunPoll(e,t){const s=await this.createAndRun(e,t);return await this.runs.poll(s.id,{thread_id:s.thread_id},t)}createAndRunStream(e,t){return AssistantStream.createThreadAssistantStream(e,this._client.beta.threads,t)}}Threads.Runs=qe,Threads.Messages=Messages2;class Beta extends APIResource{constructor(){super(...arguments),this.realtime=new Realtime(this._client),this.assistants=new Assistants(this._client),this.threads=new Threads(this._client)}}Beta.Realtime=Realtime,Beta.Assistants=Assistants,Beta.Threads=Threads;class Completions2 extends APIResource{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}class Content extends APIResource{retrieve(e,t,s){const{container_id:n}=t;return this._client.get(A`/containers/${n}/files/${e}/content`,{...s,headers:buildHeaders([{Accept:"application/binary"},s?.headers]),__binaryResponse:!0})}}let Be=class Files extends APIResource{constructor(){super(...arguments),this.content=new Content(this._client)}create(e,t,s){return this._client.post(A`/containers/${e}/files`,multipartFormRequestOptions({body:t,...s},this._client))}retrieve(e,t,s){const{container_id:n}=t;return this._client.get(A`/containers/${n}/files/${e}`,s)}list(e,t={},s){return this._client.getAPIList(A`/containers/${e}/files`,CursorPage,{query:t,...s})}delete(e,t,s){const{container_id:n}=t;return this._client.delete(A`/containers/${n}/files/${e}`,{...s,headers:buildHeaders([{Accept:"*/*"},s?.headers])})}};Be.Content=Content;class Containers extends APIResource{constructor(){super(...arguments),this.files=new Be(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(A`/containers/${e}`,t)}list(e={},t){return this._client.getAPIList("/containers",CursorPage,{query:e,...t})}delete(e,t){return this._client.delete(A`/containers/${e}`,{...t,headers:buildHeaders([{Accept:"*/*"},t?.headers])})}}Containers.Files=Be;class Embeddings extends APIResource{create(e,t){const s=!!e.encoding_format;let n=s?e.encoding_format:"base64";s&&loggerFor(this._client).debug("embeddings/user defined encoding_format:",e.encoding_format);const r=this._client.post("/embeddings",{body:{...e,encoding_format:n},...t});return s?r:(loggerFor(this._client).debug("embeddings/decoding base64 embeddings from base64"),r._thenUnwrap(e=>(e&&e.data&&e.data.forEach(e=>{const t=e.embedding;e.embedding=(e=>{if("undefined"!=typeof Buffer){const t=Buffer.from(e,"base64");return Array.from(new Float32Array(t.buffer,t.byteOffset,t.length/Float32Array.BYTES_PER_ELEMENT))}{const t=atob(e),s=t.length,n=new Uint8Array(s);for(let e=0;e<s;e++)n[e]=t.charCodeAt(e);return Array.from(new Float32Array(n.buffer))}})(t)}),e)))}}class OutputItems extends APIResource{retrieve(e,t,s){const{eval_id:n,run_id:r}=t;return this._client.get(A`/evals/${n}/runs/${r}/output_items/${e}`,s)}list(e,t,s){const{eval_id:n,...r}=t;return this._client.getAPIList(A`/evals/${n}/runs/${e}/output_items`,CursorPage,{query:r,...s})}}class Runs2 extends APIResource{constructor(){super(...arguments),this.outputItems=new OutputItems(this._client)}create(e,t,s){return this._client.post(A`/evals/${e}/runs`,{body:t,...s})}retrieve(e,t,s){const{eval_id:n}=t;return this._client.get(A`/evals/${n}/runs/${e}`,s)}list(e,t={},s){return this._client.getAPIList(A`/evals/${e}/runs`,CursorPage,{query:t,...s})}delete(e,t,s){const{eval_id:n}=t;return this._client.delete(A`/evals/${n}/runs/${e}`,s)}cancel(e,t,s){const{eval_id:n}=t;return this._client.post(A`/evals/${n}/runs/${e}`,s)}}Runs2.OutputItems=OutputItems;class Evals extends APIResource{constructor(){super(...arguments),this.runs=new Runs2(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(A`/evals/${e}`,t)}update(e,t,s){return this._client.post(A`/evals/${e}`,{body:t,...s})}list(e={},t){return this._client.getAPIList("/evals",CursorPage,{query:e,...t})}delete(e,t){return this._client.delete(A`/evals/${e}`,t)}}Evals.Runs=Runs2;let Ue=class Files2 extends APIResource{create(e,t){return this._client.post("/files",multipartFormRequestOptions({body:e,...t},this._client))}retrieve(e,t){return this._client.get(A`/files/${e}`,t)}list(e={},t){return this._client.getAPIList("/files",CursorPage,{query:e,...t})}delete(e,t){return this._client.delete(A`/files/${e}`,t)}content(e,t){return this._client.get(A`/files/${e}/content`,{...t,headers:buildHeaders([{Accept:"application/binary"},t?.headers]),__binaryResponse:!0})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:s=18e5}={}){const n=new Set(["processed","error","deleted"]),r=Date.now();let a=await this.retrieve(e);for(;!a.status||!n.has(a.status);)if(await sleep(t),a=await this.retrieve(e),Date.now()-r>s)throw new APIConnectionTimeoutError({message:`Giving up on waiting for file ${e} to finish processing after ${s} milliseconds.`});return a}};class Methods extends APIResource{}let We=class Graders extends APIResource{run(e,t){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...t})}validate(e,t){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...t})}};class Alpha extends APIResource{constructor(){super(...arguments),this.graders=new We(this._client)}}Alpha.Graders=We;class Permissions extends APIResource{create(e,t,s){return this._client.getAPIList(A`/fine_tuning/checkpoints/${e}/permissions`,Page,{body:t,method:"post",...s})}retrieve(e,t={},s){return this._client.getAPIList(A`/fine_tuning/checkpoints/${e}/permissions`,CursorPage,{query:t,...s})}delete(e,t,s){const{fine_tuned_model_checkpoint:n}=t;return this._client.delete(A`/fine_tuning/checkpoints/${n}/permissions/${e}`,s)}}let Je=class Checkpoints extends APIResource{constructor(){super(...arguments),this.permissions=new Permissions(this._client)}};Je.Permissions=Permissions;class Checkpoints2 extends APIResource{list(e,t={},s){return this._client.getAPIList(A`/fine_tuning/jobs/${e}/checkpoints`,CursorPage,{query:t,...s})}}class Jobs extends APIResource{constructor(){super(...arguments),this.checkpoints=new Checkpoints2(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(A`/fine_tuning/jobs/${e}`,t)}list(e={},t){return this._client.getAPIList("/fine_tuning/jobs",CursorPage,{query:e,...t})}cancel(e,t){return this._client.post(A`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},s){return this._client.getAPIList(A`/fine_tuning/jobs/${e}/events`,CursorPage,{query:t,...s})}pause(e,t){return this._client.post(A`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(A`/fine_tuning/jobs/${e}/resume`,t)}}Jobs.Checkpoints=Checkpoints2;class FineTuning extends APIResource{constructor(){super(...arguments),this.methods=new Methods(this._client),this.jobs=new Jobs(this._client),this.checkpoints=new Je(this._client),this.alpha=new Alpha(this._client)}}FineTuning.Methods=Methods,FineTuning.Jobs=Jobs,FineTuning.Checkpoints=Je,FineTuning.Alpha=Alpha;class GraderModels extends APIResource{}class Graders2 extends APIResource{constructor(){super(...arguments),this.graderModels=new GraderModels(this._client)}}Graders2.GraderModels=GraderModels;class Images extends APIResource{createVariation(e,t){return this._client.post("/images/variations",multipartFormRequestOptions({body:e,...t},this._client))}edit(e,t){return this._client.post("/images/edits",multipartFormRequestOptions({body:e,...t},this._client))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}class Models extends APIResource{retrieve(e,t){return this._client.get(A`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",Page,e)}delete(e,t){return this._client.delete(A`/models/${e}`,t)}}class Moderations extends APIResource{create(e,t){return this._client.post("/moderations",{body:e,...t})}}function maybeParseResponse(e,t){return t&&function hasAutoParseableInput(e){if(isAutoParsableResponseFormat(e.text?.format))return!0;return!1}(t)?parseResponse(e,t):{...e,output_parsed:null,output:e.output.map(e=>"function_call"===e.type?{...e,parsed_arguments:null}:"message"===e.type?{...e,content:e.content.map(e=>({...e,parsed:null}))}:e)}}function parseResponse(e,t){const s=e.output.map(e=>{if("function_call"===e.type)return{...e,parsed_arguments:parseToolCall(t,e)};if("message"===e.type){const s=e.content.map(e=>"output_text"===e.type?{...e,parsed:parseTextFormat(t,e.text)}:e);return{...e,content:s}}return e}),n=Object.assign({},e,{output:s});return Object.getOwnPropertyDescriptor(e,"output_text")||addOutputText(n),Object.defineProperty(n,"output_parsed",{enumerable:!0,get(){for(const e of n.output)if("message"===e.type)for(const t of e.content)if("output_text"===t.type&&null!==t.parsed)return t.parsed;return null}}),n}function parseTextFormat(e,t){if("json_schema"!==e.text?.format?.type)return null;if("$parseRaw"in e.text?.format){const s=e.text?.format;return s.$parseRaw(t)}return JSON.parse(t)}function parseToolCall(e,t){const s=function getInputToolByName(e,t){return e.find(e=>"function"===e.type&&e.name===t)}(e.tools??[],t.name);return{...t,...t,parsed_arguments:(n=s,"auto-parseable-tool"===n?.$brand?s.$parseRaw(t.arguments):s?.strict?JSON.parse(t.arguments):null)};var n}function addOutputText(e){const t=[];for(const s of e.output)if("message"===s.type)for(const e of s.content)"output_text"===e.type&&t.push(e.text);e.output_text=t.join("")}var Xe,He,ze,Ke,Ve,Qe,Ye,Ze;class ResponseStream extends EventStream{constructor(e){super(),Xe.add(this),He.set(this,void 0),ze.set(this,void 0),Ke.set(this,void 0),__classPrivateFieldSet(this,He,e)}static createResponse(e,t,s){const n=new ResponseStream(t);return n._run(()=>n._createOrRetrieveResponse(e,t,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),n}async _createOrRetrieveResponse(e,t,s){const n=s?.signal;let r;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),__classPrivateFieldGet(this,Xe,"m",Ve).call(this);let a=null;"response_id"in t?(r=await e.responses.retrieve(t.response_id,{stream:!0},{...s,signal:this.controller.signal,stream:!0}),a=t.starting_after??null):r=await e.responses.create({...t,stream:!0},{...s,signal:this.controller.signal}),this._connected();for await(const o of r)__classPrivateFieldGet(this,Xe,"m",Qe).call(this,o,a);if(r.controller.signal?.aborted)throw new APIUserAbortError;return __classPrivateFieldGet(this,Xe,"m",Ye).call(this)}[(He=new WeakMap,ze=new WeakMap,Ke=new WeakMap,Xe=new WeakSet,Ve=function _ResponseStream_beginRequest2(){this.ended||__classPrivateFieldSet(this,ze,void 0)},Qe=function _ResponseStream_addEvent2(e,t){if(this.ended)return;const maybeEmit=(e,s)=>{(null==t||s.sequence_number>t)&&this._emit(e,s)},s=__classPrivateFieldGet(this,Xe,"m",Ze).call(this,e);switch(maybeEmit("event",e),e.type){case"response.output_text.delta":{const t=s.output[e.output_index];if(!t)throw new OpenAIError(`missing output at index ${e.output_index}`);if("message"===t.type){const s=t.content[e.content_index];if(!s)throw new OpenAIError(`missing content at index ${e.content_index}`);if("output_text"!==s.type)throw new OpenAIError(`expected content to be 'output_text', got ${s.type}`);maybeEmit("response.output_text.delta",{...e,snapshot:s.text})}break}case"response.function_call_arguments.delta":{const t=s.output[e.output_index];if(!t)throw new OpenAIError(`missing output at index ${e.output_index}`);"function_call"===t.type&&maybeEmit("response.function_call_arguments.delta",{...e,snapshot:t.arguments});break}default:maybeEmit(e.type,e)}},Ye=function _ResponseStream_endRequest2(){if(this.ended)throw new OpenAIError("stream has ended, this shouldn't happen");const e=__classPrivateFieldGet(this,ze,"f");if(!e)throw new OpenAIError("request ended without sending any events");__classPrivateFieldSet(this,ze,void 0);const t=function finalizeResponse(e,t){return maybeParseResponse(e,t)}(e,__classPrivateFieldGet(this,He,"f"));return __classPrivateFieldSet(this,Ke,t),t},Ze=function _ResponseStream_accumulateResponse2(e){let t=__classPrivateFieldGet(this,ze,"f");if(!t){if("response.created"!==e.type)throw new OpenAIError(`When snapshot hasn't been set yet, expected 'response.created' event, got ${e.type}`);return t=__classPrivateFieldSet(this,ze,e.response),t}switch(e.type){case"response.output_item.added":t.output.push(e.item);break;case"response.content_part.added":{const s=t.output[e.output_index];if(!s)throw new OpenAIError(`missing output at index ${e.output_index}`);"message"===s.type&&s.content.push(e.part);break}case"response.output_text.delta":{const s=t.output[e.output_index];if(!s)throw new OpenAIError(`missing output at index ${e.output_index}`);if("message"===s.type){const t=s.content[e.content_index];if(!t)throw new OpenAIError(`missing content at index ${e.content_index}`);if("output_text"!==t.type)throw new OpenAIError(`expected content to be 'output_text', got ${t.type}`);t.text+=e.delta}break}case"response.function_call_arguments.delta":{const s=t.output[e.output_index];if(!s)throw new OpenAIError(`missing output at index ${e.output_index}`);"function_call"===s.type&&(s.arguments+=e.delta);break}case"response.completed":__classPrivateFieldSet(this,ze,e.response)}return t},Symbol.asyncIterator)](){const e=[],t=[];let s=!1;return this.on("event",s=>{const n=t.shift();n?n.resolve(s):e.push(s)}),this.on("end",()=>{s=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{s=!0;for(const s of t)s.reject(e);t.length=0}),this.on("error",e=>{s=!0;for(const s of t)s.reject(e);t.length=0}),{next:async()=>{if(!e.length)return s?{value:void 0,done:!0}:new Promise((e,s)=>t.push({resolve:e,reject:s})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0});return{value:e.shift(),done:!1}},return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=__classPrivateFieldGet(this,Ke,"f");if(!e)throw new OpenAIError("stream ended without producing a ChatCompletion");return e}}class InputItems extends APIResource{list(e,t={},s){return this._client.getAPIList(A`/responses/${e}/input_items`,CursorPage,{query:t,...s})}}class Responses extends APIResource{constructor(){super(...arguments),this.inputItems=new InputItems(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(e=>("object"in e&&"response"===e.object&&addOutputText(e),e))}retrieve(e,t={},s){return this._client.get(A`/responses/${e}`,{query:t,...s,stream:t?.stream??!1})}delete(e,t){return this._client.delete(A`/responses/${e}`,{...t,headers:buildHeaders([{Accept:"*/*"},t?.headers])})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(t=>parseResponse(t,e))}stream(e,t){return ResponseStream.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(A`/responses/${e}/cancel`,t)}}Responses.InputItems=InputItems;class Parts extends APIResource{create(e,t,s){return this._client.post(A`/uploads/${e}/parts`,multipartFormRequestOptions({body:t,...s},this._client))}}class Uploads extends APIResource{constructor(){super(...arguments),this.parts=new Parts(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(A`/uploads/${e}/cancel`,t)}complete(e,t,s){return this._client.post(A`/uploads/${e}/complete`,{body:t,...s})}}Uploads.Parts=Parts;class FileBatches extends APIResource{create(e,t,s){return this._client.post(A`/vector_stores/${e}/file_batches`,{body:t,...s,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}retrieve(e,t,s){const{vector_store_id:n}=t;return this._client.get(A`/vector_stores/${n}/file_batches/${e}`,{...s,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}cancel(e,t,s){const{vector_store_id:n}=t;return this._client.post(A`/vector_stores/${n}/file_batches/${e}/cancel`,{...s,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}async createAndPoll(e,t,s){const n=await this.create(e,t);return await this.poll(e,n.id,s)}listFiles(e,t,s){const{vector_store_id:n,...r}=t;return this._client.getAPIList(A`/vector_stores/${n}/file_batches/${e}/files`,CursorPage,{query:r,...s,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}async poll(e,t,s){const n=buildHeaders([s?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":s?.pollIntervalMs?.toString()??void 0}]);for(;;){const{data:r,response:a}=await this.retrieve(t,{vector_store_id:e},{...s,headers:n}).withResponse();switch(r.status){case"in_progress":let e=5e3;if(s?.pollIntervalMs)e=s.pollIntervalMs;else{const t=a.headers.get("openai-poll-after-ms");if(t){const s=parseInt(t);isNaN(s)||(e=s)}}await sleep(e);break;case"failed":case"cancelled":case"completed":return r}}}async uploadAndPoll(e,{files:t,fileIds:s=[]},n){if(null==t||0==t.length)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const r=n?.maxConcurrency??5,a=Math.min(r,t.length),o=this._client,i=t.values(),l=[...s];const c=Array(a).fill(i).map(async function processFiles(e){for(let t of e){const e=await o.files.create({file:t,purpose:"assistants"},n);l.push(e.id)}});return await(async e=>{const t=await Promise.allSettled(e),s=t.filter(e=>"rejected"===e.status);if(s.length){for(const e of s)console.error(e.reason);throw new Error(`${s.length} promise(s) failed - see the above errors`)}const n=[];for(const r of t)"fulfilled"===r.status&&n.push(r.value);return n})(c),await this.createAndPoll(e,{file_ids:l})}}class Files3 extends APIResource{create(e,t,s){return this._client.post(A`/vector_stores/${e}/files`,{body:t,...s,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}retrieve(e,t,s){const{vector_store_id:n}=t;return this._client.get(A`/vector_stores/${n}/files/${e}`,{...s,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}update(e,t,s){const{vector_store_id:n,...r}=t;return this._client.post(A`/vector_stores/${n}/files/${e}`,{body:r,...s,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e,t={},s){return this._client.getAPIList(A`/vector_stores/${e}/files`,CursorPage,{query:t,...s,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}delete(e,t,s){const{vector_store_id:n}=t;return this._client.delete(A`/vector_stores/${n}/files/${e}`,{...s,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}async createAndPoll(e,t,s){const n=await this.create(e,t,s);return await this.poll(e,n.id,s)}async poll(e,t,s){const n=buildHeaders([s?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":s?.pollIntervalMs?.toString()??void 0}]);for(;;){const r=await this.retrieve(t,{vector_store_id:e},{...s,headers:n}).withResponse(),a=r.data;switch(a.status){case"in_progress":let e=5e3;if(s?.pollIntervalMs)e=s.pollIntervalMs;else{const t=r.response.headers.get("openai-poll-after-ms");if(t){const s=parseInt(t);isNaN(s)||(e=s)}}await sleep(e);break;case"failed":case"completed":return a}}}async upload(e,t,s){const n=await this._client.files.create({file:t,purpose:"assistants"},s);return this.create(e,{file_id:n.id},s)}async uploadAndPoll(e,t,s){const n=await this.upload(e,t,s);return await this.poll(e,n.id,s)}content(e,t,s){const{vector_store_id:n}=t;return this._client.getAPIList(A`/vector_stores/${n}/files/${e}/content`,Page,{...s,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}}class VectorStores extends APIResource{constructor(){super(...arguments),this.files=new Files3(this._client),this.fileBatches=new FileBatches(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(A`/vector_stores/${e}`,{...t,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,s){return this._client.post(A`/vector_stores/${e}`,{body:t,...s,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e={},t){return this._client.getAPIList("/vector_stores",CursorPage,{query:e,...t,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}delete(e,t){return this._client.delete(A`/vector_stores/${e}`,{...t,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}search(e,t,s){return this._client.getAPIList(A`/vector_stores/${e}/search`,Page,{body:t,method:"post",...s,headers:buildHeaders([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}}var et,tt,st,nt;VectorStores.Files=Files3,VectorStores.FileBatches=FileBatches;class OpenAI{constructor({baseURL:e=readEnv("OPENAI_BASE_URL"),apiKey:t=readEnv("OPENAI_API_KEY"),organization:s=readEnv("OPENAI_ORG_ID")??null,project:n=readEnv("OPENAI_PROJECT_ID")??null,...r}={}){if(et.add(this),st.set(this,void 0),this.completions=new Completions2(this),this.chat=new Chat(this),this.embeddings=new Embeddings(this),this.files=new Ue(this),this.images=new Images(this),this.audio=new Audio(this),this.moderations=new Moderations(this),this.models=new Models(this),this.fineTuning=new FineTuning(this),this.graders=new Graders2(this),this.vectorStores=new VectorStores(this),this.beta=new Beta(this),this.batches=new Batches(this),this.uploads=new Uploads(this),this.responses=new Responses(this),this.evals=new Evals(this),this.containers=new Containers(this),void 0===t)throw new OpenAIError("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const a={apiKey:t,organization:s,project:n,...r,baseURL:e||"https://api.openai.com/v1"};if(!a.dangerouslyAllowBrowser&&"undefined"!=typeof window&&void 0!==window.document&&"undefined"!=typeof navigator)throw new OpenAIError("It looks like you're running in a browser-like environment.\n\nThis is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew OpenAI({ apiKey, dangerouslyAllowBrowser: true });\n\nhttps://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety\n");this.baseURL=a.baseURL,this.timeout=a.timeout??tt.DEFAULT_TIMEOUT,this.logger=a.logger??console;const o="warn";this.logLevel=o,this.logLevel=parseLogLevel(a.logLevel,"ClientOptions.logLevel",this)??parseLogLevel(readEnv("OPENAI_LOG"),"process.env['OPENAI_LOG']",this)??o,this.fetchOptions=a.fetchOptions,this.maxRetries=a.maxRetries??2,this.fetch=a.fetch??function getDefaultFetch(){if("undefined"!=typeof fetch)return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new OpenAI({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}(),__classPrivateFieldSet(this,st,FallbackEncoder),this._options=a,this.apiKey=t,this.organization=s,this.project=n}withOptions(e){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetchOptions:this.fetchOptions,apiKey:this.apiKey,organization:this.organization,project:this.project,...e})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:t}){}authHeaders(e){return buildHeaders([{Authorization:`Bearer ${this.apiKey}`}])}stringifyQuery(e){return stringify(e,{arrayFormat:"brackets"})}getUserAgent(){return`${this.constructor.name}/JS ${n}`}defaultIdempotencyKey(){return`stainless-node-retry-${uuid4()}`}makeStatusError(e,t,s,n){return APIError.generate(e,t,s,n)}buildURL(e,s,n){const r=!__classPrivateFieldGet(this,et,"m",nt).call(this)&&n||this.baseURL,a=(e=>t.test(e))(e)?new URL(e):new URL(r+(r.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),o=this.defaultQuery();return function isEmptyObj(e){if(!e)return!0;for(const t in e)return!1;return!0}(o)||(s={...o,...s}),"object"==typeof s&&s&&!Array.isArray(s)&&(a.search=this.stringifyQuery(s)),a.toString()}async prepareOptions(e){}async prepareRequest(e,{url:t,options:s}){}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,s){return this.request(Promise.resolve(s).then(s=>({method:e,path:t,...s})))}request(e,t=null){return new APIPromise(this,this.makeRequest(e,t,void 0))}async makeRequest(e,t,s){const n=await e,r=n.maxRetries??this.maxRetries;null==t&&(t=r),await this.prepareOptions(n);const{req:a,url:o,timeout:i}=this.buildRequest(n,{retryCount:r-t});await this.prepareRequest(a,{url:o,options:n});const l="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),c=void 0===s?"":`, retryOf: ${s}`,u=Date.now();if(loggerFor(this).debug(`[${l}] sending request`,formatRequestDetails({retryOfRequestLogID:s,method:n.method,url:o,options:n,headers:a.headers})),n.signal?.aborted)throw new APIUserAbortError;const d=new AbortController,h=await this.fetchWithTimeout(o,a,i,d).catch(castToError),p=Date.now();if(h instanceof Error){const e=`retrying, ${t} attempts remaining`;if(n.signal?.aborted)throw new APIUserAbortError;const r=isAbortError(h)||/timed? ?out/i.test(String(h)+("cause"in h?String(h.cause):""));if(t)return loggerFor(this).info(`[${l}] connection ${r?"timed out":"failed"} - ${e}`),loggerFor(this).debug(`[${l}] connection ${r?"timed out":"failed"} (${e})`,formatRequestDetails({retryOfRequestLogID:s,url:o,durationMs:p-u,message:h.message})),this.retryRequest(n,t,s??l);if(loggerFor(this).info(`[${l}] connection ${r?"timed out":"failed"} - error; no more retries left`),loggerFor(this).debug(`[${l}] connection ${r?"timed out":"failed"} (error; no more retries left)`,formatRequestDetails({retryOfRequestLogID:s,url:o,durationMs:p-u,message:h.message})),r)throw new APIConnectionTimeoutError;throw new APIConnectionError({cause:h})}const f=`[${l}${c}${[...h.headers.entries()].filter(([e])=>"x-request-id"===e).map(([e,t])=>", "+e+": "+JSON.stringify(t)).join("")}] ${a.method} ${o} ${h.ok?"succeeded":"failed"} with status ${h.status} in ${p-u}ms`;if(!h.ok){const e=this.shouldRetry(h);if(t&&e){const e=`retrying, ${t} attempts remaining`;return await async function CancelReadableStream(e){if(null===e||"object"!=typeof e)return;if(e[Symbol.asyncIterator])return void(await(e[Symbol.asyncIterator]().return?.()));const t=e.getReader(),s=t.cancel();t.releaseLock(),await s}(h.body),loggerFor(this).info(`${f} - ${e}`),loggerFor(this).debug(`[${l}] response error (${e})`,formatRequestDetails({retryOfRequestLogID:s,url:h.url,status:h.status,headers:h.headers,durationMs:p-u})),this.retryRequest(n,t,s??l,h.headers)}const r=e?"error; no more retries left":"error; not retryable";loggerFor(this).info(`${f} - ${r}`);const a=await h.text().catch(e=>castToError(e).message),o=(e=>{try{return JSON.parse(e)}catch(t){return}})(a),i=o?void 0:a;loggerFor(this).debug(`[${l}] response error (${r})`,formatRequestDetails({retryOfRequestLogID:s,url:h.url,status:h.status,headers:h.headers,message:i,durationMs:Date.now()-u}));throw this.makeStatusError(h.status,o,i,h.headers)}return loggerFor(this).info(f),loggerFor(this).debug(`[${l}] response start`,formatRequestDetails({retryOfRequestLogID:s,url:h.url,status:h.status,headers:h.headers,durationMs:p-u})),{response:h,options:n,controller:d,requestLogID:l,retryOfRequestLogID:s,startTime:u}}getAPIList(e,t,s){return this.requestAPIList(t,{method:"get",path:e,...s})}requestAPIList(e,t){const s=this.makeRequest(t,null,void 0);return new PagePromise(this,s,e)}async fetchWithTimeout(e,t,s,n){const{signal:r,method:a,...o}=t||{};r&&r.addEventListener("abort",()=>n.abort());const i=setTimeout(()=>n.abort(),s),l=globalThis.ReadableStream&&o.body instanceof globalThis.ReadableStream||"object"==typeof o.body&&null!==o.body&&Symbol.asyncIterator in o.body,c={signal:n.signal,...l?{duplex:"half"}:{},method:"GET",...o};a&&(c.method=a.toUpperCase());try{return await this.fetch.call(void 0,e,c)}finally{clearTimeout(i)}}shouldRetry(e){const t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||(409===e.status||(429===e.status||e.status>=500)))}async retryRequest(e,t,s,n){let r;const a=n?.get("retry-after-ms");if(a){const e=parseFloat(a);Number.isNaN(e)||(r=e)}const o=n?.get("retry-after");if(o&&!r){const e=parseFloat(o);r=Number.isNaN(e)?Date.parse(o)-Date.now():1e3*e}if(!(r&&0<=r&&r<6e4)){const s=e.maxRetries??this.maxRetries;r=this.calculateDefaultRetryTimeoutMillis(t,s)}return await sleep(r),this.makeRequest(e,t-1,s)}calculateDefaultRetryTimeoutMillis(e,t){const s=t-e;return Math.min(.5*Math.pow(2,s),8)*(1-.25*Math.random())*1e3}buildRequest(e,{retryCount:t=0}={}){const s={...e},{method:n,path:r,query:a,defaultBaseURL:o}=s,i=this.buildURL(r,a,o);"timeout"in s&&((e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new OpenAIError(`${e} must be an integer`);if(t<0)throw new OpenAIError(`${e} must be a positive integer`)})("timeout",s.timeout),s.timeout=s.timeout??this.timeout;const{bodyHeaders:l,body:c}=this.buildBody({options:s});return{req:{method:n,headers:this.buildHeaders({options:e,method:n,bodyHeaders:l,retryCount:t}),...s.signal&&{signal:s.signal},...globalThis.ReadableStream&&c instanceof globalThis.ReadableStream&&{duplex:"half"},...c&&{body:c},...this.fetchOptions??{},...s.fetchOptions??{}},url:i,timeout:s.timeout}}buildHeaders({options:e,method:t,bodyHeaders:s,retryCount:n}){let a={};this.idempotencyHeader&&"get"!==t&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),a[this.idempotencyHeader]=e.idempotencyKey);const o=buildHeaders([a,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(n),...e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{},...r??(r=getPlatformProperties()),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project},this.authHeaders(e),this._options.defaultHeaders,s,e.headers]);return this.validateHeaders(o),o.values}buildBody({options:{body:e,headers:t}}){if(!e)return{bodyHeaders:void 0,body:void 0};const s=buildHeaders([t]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||"string"==typeof e&&s.values.has("content-type")||e instanceof Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:"object"==typeof e&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&"function"==typeof e.next)?{bodyHeaders:void 0,body:ReadableStreamFrom(e)}:__classPrivateFieldGet(this,st,"f").call(this,{body:e,headers:s})}}tt=OpenAI,st=new WeakMap,et=new WeakSet,nt=function _OpenAI_baseURLOverridden2(){return"https://api.openai.com/v1"!==this.baseURL},OpenAI.OpenAI=tt,OpenAI.DEFAULT_TIMEOUT=6e5,OpenAI.OpenAIError=OpenAIError,OpenAI.APIError=APIError,OpenAI.APIConnectionError=APIConnectionError,OpenAI.APIConnectionTimeoutError=APIConnectionTimeoutError,OpenAI.APIUserAbortError=APIUserAbortError,OpenAI.NotFoundError=NotFoundError,OpenAI.ConflictError=ConflictError,OpenAI.RateLimitError=RateLimitError,OpenAI.BadRequestError=BadRequestError,OpenAI.AuthenticationError=AuthenticationError,OpenAI.InternalServerError=InternalServerError,OpenAI.PermissionDeniedError=PermissionDeniedError,OpenAI.UnprocessableEntityError=UnprocessableEntityError,OpenAI.toFile=async function toFile(e,t,s){if(checkFileSupport(),(e=>null!=e&&"object"==typeof e&&"string"==typeof e.name&&"number"==typeof e.lastModified&&isBlobLike(e))(e=await e))return e instanceof File?e:makeFile([await e.arrayBuffer()],e.name);if((e=>null!=e&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob)(e)){const n=await e.blob();return t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()),makeFile(await getBytes(n),t,s)}const n=await getBytes(e);if(t||(t=getName(e)),!s?.type){const e=n.find(e=>"object"==typeof e&&"type"in e&&e.type);"string"==typeof e&&(s={...s,type:e})}return makeFile(n,t,s)},OpenAI.Completions=Completions2,OpenAI.Chat=Chat,OpenAI.Embeddings=Embeddings,OpenAI.Files=Ue,OpenAI.Images=Images,OpenAI.Audio=Audio,OpenAI.Moderations=Moderations,OpenAI.Models=Models,OpenAI.FineTuning=FineTuning,OpenAI.Graders=Graders2,OpenAI.VectorStores=VectorStores,OpenAI.Beta=Beta,OpenAI.Batches=Batches,OpenAI.Uploads=Uploads,OpenAI.Responses=Responses,OpenAI.Evals=Evals,OpenAI.Containers=Containers;const rt=new OpenAI({apiKey:e.openai.apiKey,dangerouslyAllowBrowser:!0});async function analyzeDocument(t){if(!e.openai.apiKey)throw new Error("OpenAI API key not configured");const s=`\n    Analyze this legal document and provide a structured analysis in JSON format:\n    \n    1. Executive summary (2-3 sentences)\n    2. Key entities (people, organizations, dates, amounts)\n    3. Document classification (contract, agreement, legal notice, etc.)\n    4. Legal implications (potential risks, obligations, rights)\n    5. Recommended actions (what the reader should do)\n    6. Confidence score (0-1, how confident you are in this analysis)\n    \n    Document text:\n    ${t.substring(0,8e3)} ${t.length>8e3?"...":""}\n    \n    Respond with valid JSON only, no additional text.\n  `;try{const t=await rt.chat.completions.create({model:e.openai.model,messages:[{role:"system",content:"You are a legal AI assistant specializing in Singapore law. Provide accurate, helpful analysis of legal documents."},{role:"user",content:s}],max_tokens:e.openai.maxTokens,temperature:e.openai.temperature}),n=t.choices[0]?.message?.content;if(!n)throw new Error("No response from OpenAI");const r=JSON.parse(n);return{summary:r.summary||"",keyEntities:r.keyEntities||[],documentType:r.documentType||"Unknown",legalImplications:r.legalImplications||[],recommendedActions:r.recommendedActions||[],confidence:r.confidence||.5}}catch(n){throw console.error("Error analyzing document:",n),new Error("Failed to analyze document")}}async function generateEmbedding(t){if(!e.openai.apiKey)throw new Error("OpenAI API key not configured");try{const e=await rt.embeddings.create({model:"text-embedding-3-small",input:t.substring(0,8e3)});return{embedding:e.data[0].embedding,usage:e.usage}}catch(s){throw console.error("Error generating embedding:",s),new Error("Failed to generate embedding")}}async function chatWithAI(t,s=[],n=[]){if(!e.openai.apiKey)throw new Error("OpenAI API key not configured");const r=[{role:"system",content:"You are a legal AI assistant specializing in Singapore law. \n    Provide helpful, accurate legal information while being clear that this is not legal advice.\n    Always recommend consulting with a qualified lawyer for specific legal matters.\n    If you reference information from the user's documents, mention that clearly."},...n,{role:"user",content:`${t}${s.length>0?`\n\nRelevant context from your documents:\n${s.join("\n\n")}`:""}`}];try{const t=await rt.chat.completions.create({model:e.openai.model,messages:r,max_tokens:e.openai.maxTokens,temperature:.2}),n=t.choices[0]?.message?.content;if(!n)throw new Error("No response from OpenAI");return{message:n,sources:s.length>0?["Your uploaded documents"]:[],confidence:.8}}catch(a){throw console.error("Error in AI chat:",a),new Error("Failed to get AI response")}}async function summarizeDocument(t,s=500){if(!e.openai.apiKey)throw new Error("OpenAI API key not configured");const n=`\n    Provide a concise summary of this legal document in approximately ${s} characters.\n    Focus on the key points, parties involved, main obligations, and important dates.\n    \n    Document text:\n    ${t.substring(0,8e3)} ${t.length>8e3?"...":""}\n  `;try{const t=await rt.chat.completions.create({model:e.openai.model,messages:[{role:"system",content:"You are a legal AI assistant. Provide clear, concise summaries of legal documents."},{role:"user",content:n}],max_tokens:Math.min(e.openai.maxTokens,1e3),temperature:e.openai.temperature});return t.choices[0]?.message?.content||"Unable to generate summary"}catch(r){throw console.error("Error summarizing document:",r),new Error("Failed to summarize document")}}async function extractEntities(t){if(!e.openai.apiKey)throw new Error("OpenAI API key not configured");const s=`\n    Extract key entities from this legal document and return them in JSON format:\n    \n    {\n      "people": ["names of people"],\n      "organizations": ["company names, law firms, etc."],\n      "dates": ["important dates"],\n      "amounts": ["monetary amounts, percentages"],\n      "locations": ["addresses, jurisdictions"]\n    }\n    \n    Document text:\n    ${t.substring(0,8e3)} ${t.length>8e3?"...":""}\n    \n    Respond with valid JSON only.\n  `;try{const t=await rt.chat.completions.create({model:e.openai.model,messages:[{role:"system",content:"You are a legal AI assistant. Extract entities accurately from legal documents."},{role:"user",content:s}],max_tokens:1e3,temperature:.1}),n=t.choices[0]?.message?.content;if(!n)throw new Error("No response from OpenAI");const r=JSON.parse(n);return{people:r.people||[],organizations:r.organizations||[],dates:r.dates||[],amounts:r.amounts||[],locations:r.locations||[]}}catch(n){return console.error("Error extracting entities:",n),{people:[],organizations:[],dates:[],amounts:[],locations:[]}}}export{analyzeDocument,chatWithAI,extractEntities,generateEmbedding,rt as openai,summarizeDocument};
