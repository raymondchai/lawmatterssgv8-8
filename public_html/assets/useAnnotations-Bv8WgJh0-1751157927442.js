import{r as e}from"./react-vendor-C9QDz5CC-1751157927442.js";import{u as t,a as n,b as a}from"./data-fetching-CNJjrhoC-1751157927442.js";import{v as o,J as s}from"./index-jjbO2EWp-1751157927442.js";const r=new class AnnotationsApi{async getDocumentAnnotations(e){const{data:t,error:n}=await o.from("document_annotations").select("*").eq("document_id",e).order("created_at",{ascending:!0});if(n)throw new Error(`Failed to fetch annotations: ${n.message}`);return t||[]}async createAnnotation(e){const{data:t}=await o.auth.getUser();if(!t.user)throw new Error("User not authenticated");const{data:n,error:a}=await o.from("document_annotations").insert({...e,user_id:t.user.id,is_resolved:!1}).select().single();if(a)throw new Error(`Failed to create annotation: ${a.message}`);return n}async updateAnnotation(e,t){const{data:n,error:a}=await o.from("document_annotations").update(t).eq("id",e).select().single();if(a)throw new Error(`Failed to update annotation: ${a.message}`);return n}async deleteAnnotation(e){const{error:t}=await o.from("document_annotations").delete().eq("id",e);if(t)throw new Error(`Failed to delete annotation: ${t.message}`)}subscribeToAnnotations(e,t){return console.log("Skipping annotations real-time subscription - disabled in production"),{unsubscribe:()=>console.log("Mock unsubscribe called")}}async getDocumentCollaborators(e){const{data:t,error:n}=await o.from("annotation_collaborators").select("\n        *,\n        user:profiles!annotation_collaborators_user_id_fkey(id, email, first_name, last_name),\n        invited_by_user:profiles!annotation_collaborators_invited_by_fkey(id, email, first_name, last_name)\n      ").eq("document_id",e);if(n)throw new Error(`Failed to fetch collaborators: ${n.message}`);return t||[]}async inviteCollaborator(e){const{data:t,error:n}=await o.from("profiles").select("id").eq("email",e.email).single();if(n||!t)throw new Error("User not found with this email address");const{data:a,error:s}=await o.from("annotation_collaborators").insert({document_id:e.document_id,user_id:t.id,permission_level:e.permission_level,invited_by:(await o.auth.getUser()).data.user?.id}).select().single();if(s)throw new Error(`Failed to invite collaborator: ${s.message}`);return a}async removeCollaborator(e){const{error:t}=await o.from("annotation_collaborators").delete().eq("id",e);if(t)throw new Error(`Failed to remove collaborator: ${t.message}`)}async updateCollaboratorPermission(e,t){const{data:n,error:a}=await o.from("annotation_collaborators").update({permission_level:t}).eq("id",e).select().single();if(a)throw new Error(`Failed to update permission: ${a.message}`);return n}async createReply(e){const{data:t}=await o.auth.getUser();if(!t.user)throw new Error("User not authenticated");const{data:n,error:a}=await o.from("annotation_replies").insert({...e,user_id:t.user.id}).select("\n        *,\n        user:profiles!annotation_replies_user_id_fkey(id, email, first_name, last_name)\n      ").single();if(a)throw new Error(`Failed to create reply: ${a.message}`);return n}};function useDocumentAnnotations(o,i){const c=t(),{data:l=[],isLoading:u,error:d,refetch:m}=n({queryKey:["annotations",o,i],queryFn:()=>r.getDocumentAnnotations(o,i),enabled:!!o,staleTime:3e4}),g=a({mutationFn:r.createAnnotation,onSuccess:e=>{c.setQueryData(["annotations",o,i],(t=[])=>[...t,e]),s.success("Annotation created successfully")},onError:e=>{s.error(`Failed to create annotation: ${e.message}`)}}),f=a({mutationFn:({id:e,data:t})=>r.updateAnnotation(e,t),onSuccess:e=>{c.setQueryData(["annotations",o,i],(t=[])=>t.map(t=>t.id===e.id?e:t)),s.success("Annotation updated successfully")},onError:e=>{s.error(`Failed to update annotation: ${e.message}`)}}),y=a({mutationFn:r.deleteAnnotation,onSuccess:(e,t)=>{c.setQueryData(["annotations",o,i],(e=[])=>e.filter(e=>e.id!==t)),s.success("Annotation deleted successfully")},onError:e=>{s.error(`Failed to delete annotation: ${e.message}`)}});return{annotations:l,isLoading:u,error:d,refetch:m,createAnnotation:e.useCallback(e=>g.mutateAsync(e),[g]),updateAnnotation:e.useCallback((e,t)=>f.mutateAsync({id:e,data:t}),[f]),deleteAnnotation:e.useCallback(e=>y.mutateAsync(e),[y]),isCreating:g.isPending,isUpdating:f.isPending,isDeleting:y.isPending}}function useAnnotationComments(n){const o=t(),i=a({mutationFn:r.addComment,onSuccess:e=>{o.setQueriesData({queryKey:["annotations"]},(t=[])=>t.map(t=>t.id===n?{...t,comments:[...t.comments||[],e]}:t)),s.success("Comment added successfully")},onError:e=>{s.error(`Failed to add comment: ${e.message}`)}}),c=a({mutationFn:({id:e,content:t})=>r.updateComment(e,t),onSuccess:e=>{o.setQueriesData({queryKey:["annotations"]},(t=[])=>t.map(t=>t.id===n?{...t,comments:t.comments?.map(t=>t.id===e.id?e:t)||[]}:t)),s.success("Comment updated successfully")},onError:e=>{s.error(`Failed to update comment: ${e.message}`)}}),l=a({mutationFn:r.deleteComment,onSuccess:(e,t)=>{o.setQueriesData({queryKey:["annotations"]},(e=[])=>e.map(e=>e.id===n?{...e,comments:e.comments?.filter(e=>e.id!==t)||[]}:e)),s.success("Comment deleted successfully")},onError:e=>{s.error(`Failed to delete comment: ${e.message}`)}});return{addComment:e.useCallback(e=>i.mutateAsync(e),[i]),updateComment:e.useCallback((e,t)=>c.mutateAsync({id:e,content:t}),[c]),deleteComment:e.useCallback(e=>l.mutateAsync(e),[l]),isAddingComment:i.isPending,isUpdatingComment:c.isPending,isDeletingComment:l.isPending}}function useAnnotationSharing(){const n=t(),o=a({mutationFn:r.shareAnnotation,onSuccess:e=>{n.setQueriesData({queryKey:["annotations"]},(t=[])=>t.map(t=>t.id===e.annotationId?{...t,shares:[...t.shares||[],e]}:t)),s.success("Annotation shared successfully")},onError:e=>{s.error(`Failed to share annotation: ${e.message}`)}}),i=a({mutationFn:r.removeShare,onSuccess:(e,t)=>{n.setQueriesData({queryKey:["annotations"]},(e=[])=>e.map(e=>({...e,shares:e.shares?.filter(e=>e.id!==t)||[]}))),s.success("Share removed successfully")},onError:e=>{s.error(`Failed to remove share: ${e.message}`)}});return{shareAnnotation:e.useCallback(e=>o.mutateAsync(e),[o]),removeShare:e.useCallback(e=>i.mutateAsync(e),[i]),isSharing:o.isPending,isRemoving:i.isPending}}function useAnnotationState(){const[t,n]=e.useState({annotation:null,isEditing:!1}),[a,o]=e.useState({type:"highlight",color:"yellow",isActive:!1}),[s,r]=e.useState({isDrawing:!1,currentPath:"",strokeWidth:2,color:"red"});return{selectedAnnotation:t,activeTool:a,drawingState:s,selectAnnotation:e.useCallback((e,t=!1)=>{n({annotation:e,isEditing:t})},[]),activateTool:e.useCallback((e,t="yellow")=>{o({type:e,color:t,isActive:!0})},[]),deactivateTool:e.useCallback(()=>{o(e=>({...e,isActive:!1}))},[]),startDrawing:e.useCallback((e="red",t=2)=>{r({isDrawing:!0,currentPath:"",strokeWidth:t,color:e})},[]),updateDrawingPath:e.useCallback(e=>{r(t=>({...t,currentPath:e}))},[]),stopDrawing:e.useCallback(()=>{r(e=>({...e,isDrawing:!1}))},[])}}export{useAnnotationSharing as a,useDocumentAnnotations as b,useAnnotationState as c,useAnnotationComments as u};
