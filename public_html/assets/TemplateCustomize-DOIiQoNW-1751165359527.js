import{r as e,j as s}from"./react-vendor-C9QDz5CC-1751165359527.js";import{ah as a,a9 as t,ai as l,aj as i,C as n,n as r,B as c,ak as m,g as d,t as o,u as x,A as h,a1 as u,N as j,O as p,v as f,I as g,a2 as v,E as N,G as y,H as b,K as w,M as k,o as C}from"./index-CCKGRA2X-1751165359527.js";import{aY as S,aF as E,bt as z,aT as F,bE as L,aM as $,w as T,F as _}from"./ui-components-Dc-JUrqW-1751165359527.js";import"./supabase-vEdrjZLM-1751165359527.js";import"./data-fetching-BdKiLmME-1751165359527.js";import"./utilities-aAdqUWEK-1751165359527.js";import"./forms-D5ph1Ffz-1751165359527.js";import"./ai-services-BdAg_3mV-1751165359527.js";function TemplateCustomize(){const{slug:O}=a(),P=t(),[D,H]=e.useState(null),[I,M]=e.useState(null),[B,U]=e.useState(!0),[q,V]=e.useState(!1),[R,A]=e.useState(!1),[G,K]=e.useState(null),[X,Y]=e.useState({}),[J,Q]=e.useState({}),[W,Z]=e.useState(!1),[ee,se]=e.useState("");e.useEffect(()=>{O&&loadTemplate(O)},[O]);const loadTemplate=async e=>{try{U(!0);const s=await l.getTemplate(e);if(!s)return void K("Template not found");H(s);const a={};s.fields.forEach(e=>{void 0!==e.defaultValue&&(a[e.name]=e.defaultValue)}),Y(a),await l.trackEvent(s.id,"customization_started",{source:"customize_page",access_level:s.accessLevel})}catch(s){K(s instanceof Error?s.message:"Failed to load template")}finally{U(!1)}},validateForm=()=>{if(!D)return!1;const e={};return D.fields.forEach(s=>{const a=((e,s)=>{if(e.required&&(!s||""===s.toString().trim()))return`${e.label} is required`;if(s&&e.validation){const a=e.validation;if(a.minLength&&s.toString().length<a.minLength)return`${e.label} must be at least ${a.minLength} characters`;if(a.maxLength&&s.toString().length>a.maxLength)return`${e.label} must be no more than ${a.maxLength} characters`;if(a.pattern&&!new RegExp(a.pattern).test(s.toString()))return`${e.label} format is invalid`;if("number"===e.type){const t=Number(s);if(a.min&&t<a.min)return`${e.label} must be at least ${a.min}`;if(a.max&&t>a.max)return`${e.label} must be no more than ${a.max}`}}return null})(s,X[s.name]);a&&(e[s.name]=a)}),Q(e),0===Object.keys(e).length},handleFieldChange=(e,s)=>{Y(a=>({...a,[e]:s})),J[e]&&Q(s=>{const a={...s};return delete a[e],a})},handleDownload=async(e="pdf")=>{if(D&&I)try{A(!0);const{data:s,error:a}=await f.functions.invoke("template-document-generator",{body:{customizationId:I.id,format:e,templateData:{title:D.title,content:D.content.template||"",customFields:X}}});if(a)throw new Error(a.message||"Failed to generate document");const t=document.createElement("a");t.href=s.downloadUrl,t.download=`${D.title.replace(/[^a-z0-9]/gi,"_").toLowerCase()}.${e}`,document.body.appendChild(t),t.click(),document.body.removeChild(t),await l.recordDownload(D.id,I.id,e)}catch(s){K(s instanceof Error?s.message:"Failed to download document")}finally{A(!1)}},renderField=e=>{const a=X[e.name]||"",t=J[e.name],l={id:e.id,value:a,onChange:s=>handleFieldChange(e.name,s.target.value),placeholder:e.placeholder,className:t?"border-red-500":""};switch(e.type){case"textarea":return s.jsx(C,{...l,rows:4});case"select":return s.jsxs(N,{value:a,onValueChange:s=>handleFieldChange(e.name,s),children:[s.jsx(y,{className:t?"border-red-500":"",children:s.jsx(b,{placeholder:e.placeholder})}),s.jsx(w,{children:e.options?.map(e=>s.jsx(k,{value:e.value,children:e.label},e.value))})]});case"checkbox":return s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(v,{id:e.id,checked:!0===a,onCheckedChange:s=>handleFieldChange(e.name,s)}),s.jsx(u,{htmlFor:e.id,children:e.label})]});case"number":return s.jsx(g,{...l,type:"number",min:e.validation?.min,max:e.validation?.max,onChange:s=>handleFieldChange(e.name,Number(s.target.value))});case"date":return s.jsx(g,{...l,type:"date"});case"email":return s.jsx(g,{...l,type:"email"});case"phone":return s.jsx(g,{...l,type:"tel"});default:return s.jsx(g,{...l,type:"text"})}};return B?s.jsx("div",{className:"min-h-screen bg-gray-50",children:s.jsx("div",{className:"container mx-auto px-4 py-8",children:s.jsxs("div",{className:"max-w-4xl mx-auto space-y-8",children:[s.jsx(i,{className:"h-8 w-32"}),s.jsxs("div",{className:"grid lg:grid-cols-2 gap-8",children:[s.jsxs("div",{className:"space-y-6",children:[s.jsx(i,{className:"h-64 w-full"}),s.jsx(i,{className:"h-32 w-full"})]}),s.jsx("div",{className:"space-y-6",children:s.jsx(i,{className:"h-48 w-full"})})]})]})})}):G||!D?s.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:s.jsx(n,{className:"w-full max-w-md",children:s.jsxs(r,{className:"p-8 text-center",children:[s.jsx(S,{className:"h-12 w-12 text-red-500 mx-auto mb-4"}),s.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Unable to Load Template"}),s.jsx("p",{className:"text-gray-600 mb-6",children:G||"The template you're trying to customize is not available."}),s.jsx(c,{onClick:()=>P(m.templateBrowser),children:"Browse Templates"})]})})}):s.jsx("div",{className:"min-h-screen bg-gray-50",children:s.jsx("div",{className:"container mx-auto px-4 py-8",children:s.jsxs("div",{className:"max-w-6xl mx-auto",children:[s.jsxs("div",{className:"flex items-center justify-between mb-8",children:[s.jsxs("div",{className:"flex items-center gap-4",children:[s.jsxs(c,{variant:"ghost",size:"sm",onClick:()=>P(`${m.templatePreview}/${D.slug}`),children:[s.jsx(E,{className:"h-4 w-4 mr-2"}),"Back to Preview"]}),s.jsxs("div",{children:[s.jsxs("h1",{className:"text-2xl font-bold text-gray-900",children:["Customize: ",D.title]}),s.jsx("p",{className:"text-gray-600",children:"Fill in the fields below to customize your document"})]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(d,{variant:"outline",children:D.category?.name}),"public"!==D.accessLevel&&s.jsx(d,{variant:"secondary",children:D.accessLevel})]})]}),s.jsxs("div",{className:"grid lg:grid-cols-2 gap-8",children:[s.jsxs("div",{className:"space-y-6",children:[s.jsxs(n,{children:[s.jsxs(o,{children:[s.jsxs(x,{className:"flex items-center gap-2",children:[s.jsx(z,{className:"h-5 w-5"}),"Document Fields"]}),s.jsx(h,{children:"Complete the form below to customize your document"})]}),s.jsx(r,{className:"space-y-6",children:D.fields.map(e=>s.jsxs("div",{className:"space-y-2",children:[s.jsxs(u,{htmlFor:e.id,className:"flex items-center gap-2",children:[e.label,e.required&&s.jsx("span",{className:"text-red-500",children:"*"})]}),renderField(e),e.helpText&&s.jsx("p",{className:"text-xs text-gray-500",children:e.helpText}),J[e.name]&&s.jsx("p",{className:"text-xs text-red-500",children:J[e.name]})]},e.id))})]}),s.jsx(n,{children:s.jsxs(r,{className:"p-6",children:[s.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[s.jsxs(c,{onClick:async()=>{if(D&&validateForm())try{if(V(!0),I){const e=await l.updateCustomization(I.id,{customFields:X});M(e)}else{const e=crypto.randomUUID(),s=await l.createCustomization(D.id,X,void 0,e);M(s)}await l.trackEvent(D.id,"customization_saved",{fields_filled:Object.keys(X).length,completion_rate:Object.keys(X).length/D.fields.length*100})}catch(e){K(e instanceof Error?e.message:"Failed to save customization")}finally{V(!1)}},disabled:q,className:"flex-1",children:[q?s.jsx(F,{className:"h-4 w-4 mr-2 animate-spin"}):s.jsx(L,{className:"h-4 w-4 mr-2"}),"Save Progress"]}),s.jsxs(c,{variant:"outline",onClick:async()=>{if(D&&validateForm())try{A(!0);let e=D.content.template||"";Object.entries(X).forEach(([s,a])=>{const t=new RegExp(`{{${s}}}`,"g");e=e.replace(t,a?.toString()||"")}),se(e),Z(!0),await l.trackEvent(D.id,"preview_generated",{fields_filled:Object.keys(X).length})}catch(e){K(e instanceof Error?e.message:"Failed to generate preview")}finally{A(!1)}},disabled:R,className:"flex-1",children:[R?s.jsx(F,{className:"h-4 w-4 mr-2 animate-spin"}):s.jsx($,{className:"h-4 w-4 mr-2"}),"Preview"]}),s.jsxs("div",{className:"flex gap-2 flex-1",children:[s.jsxs(c,{variant:"outline",onClick:()=>handleDownload("pdf"),disabled:!I||R,className:"flex-1",children:[s.jsx(T,{className:"h-4 w-4 mr-2"}),"PDF"]}),s.jsxs(c,{variant:"outline",onClick:()=>handleDownload("docx"),disabled:!I||R,className:"flex-1",children:[s.jsx(T,{className:"h-4 w-4 mr-2"}),"DOCX"]}),s.jsxs(c,{variant:"outline",onClick:()=>handleDownload("html"),disabled:!I||R,className:"flex-1",children:[s.jsx(T,{className:"h-4 w-4 mr-2"}),"HTML"]})]})]}),Object.keys(J).length>0&&s.jsxs(j,{className:"mt-4",children:[s.jsx(S,{className:"h-4 w-4"}),s.jsx(p,{children:"Please fix the validation errors above before proceeding."})]})]})})]}),s.jsx("div",{className:"space-y-6",children:s.jsxs(n,{className:"sticky top-6",children:[s.jsxs(o,{children:[s.jsxs(x,{className:"flex items-center gap-2",children:[s.jsx(_,{className:"h-5 w-5"}),"Live Preview"]}),s.jsx(h,{children:"See how your document will look as you fill in the fields"})]}),s.jsx(r,{children:W&&ee?s.jsx("div",{className:"prose max-w-none border rounded-lg p-4 bg-white min-h-96 text-sm",dangerouslySetInnerHTML:{__html:ee}}):D.previewHtml?s.jsx("div",{className:"prose max-w-none border rounded-lg p-4 bg-white min-h-96 text-sm opacity-60",dangerouslySetInnerHTML:{__html:D.previewHtml}}):s.jsx("div",{className:"border rounded-lg p-8 bg-white min-h-96 flex items-center justify-center text-gray-500",children:s.jsxs("div",{className:"text-center",children:[s.jsx(_,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),s.jsx("p",{children:"Fill in the fields to see your customized document"})]})})})]})})]})]})})})}export{TemplateCustomize as default};
