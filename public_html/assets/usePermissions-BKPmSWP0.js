import{r as w,j as e,F as $,w as W,aG as F,U as Y,aM as B,bG as L,bF as I,s as z,cB as H,cC as K,ct as J}from"./react-vendor-CQwTX5cM.js";import{ac as b,L as Q,M as X,A as Z,E as ee,G as se,H as re,K as R,B as te,C as g,o as x,q as ae,r as ne,s as U,t as P,u as S,v as D,z as A,y as O}from"./ai-services-C7wGs9RJ.js";import{supabase as l}from"./supabase-DtnFeX9z.js";import{f as oe}from"./utilities-1ndx239g.js";class ie{async getDashboardAnalytics(s){try{const r=(s==null?void 0:s.end)||new Date,a=(s==null?void 0:s.start)||new Date(Date.now()-30*24*60*60*1e3),[o,i,c,u]=await Promise.all([this.getTotalTemplates(),this.getTotalDownloads(),this.getTotalRevenue(),this.getTotalUsers()]),[d,f,p]=await Promise.all([this.getDownloadsInPeriod(a,r),this.getRevenueInPeriod(a,r),this.getNewUsersInPeriod(a,r)]),[j,E,T,m,v,y]=await Promise.all([this.getPopularTemplates(10),this.getCategoryStats(),this.getUserEngagementMetrics(a,r),this.getRevenueBreakdown(),this.getDownloadTrends(a,r),this.getFormatStats()]);return{totalTemplates:o,totalDownloads:i,totalRevenue:c,totalUsers:u,downloadsThisMonth:d,revenueThisMonth:f,newUsersThisMonth:p,popularTemplates:j,categoryStats:E,userEngagement:T,revenueBreakdown:m,downloadTrends:v,formatStats:y}}catch(r){throw console.error("Error fetching dashboard analytics:",r),new Error("Failed to fetch analytics data")}}async getTemplatePerformance(s){try{let r=l.from("templates").select(`
          id,
          title,
          download_count,
          rating_average,
          updated_at,
          template_analytics!inner(event_type),
          template_downloads!inner(format),
          template_customizations!inner(id)
        `);s&&(r=r.eq("id",s));const{data:a,error:o}=await r;if(o)throw o;return a.map(i=>{var f,p;const c=((f=i.template_analytics)==null?void 0:f.filter(j=>j.event_type==="template_view").length)||0,u=((p=i.template_customizations)==null?void 0:p.length)||0,d=i.download_count||0;return{templateId:i.id,title:i.title,views:c,customizations:u,downloads:d,revenue:d*50,rating:i.rating_average||0,conversionRate:c>0?d/c*100:0,lastUpdated:new Date(i.updated_at)}})}catch(r){throw console.error("Error fetching template performance:",r),new Error("Failed to fetch template performance data")}}async getRevenueAnalytics(){try{const s=await this.getTotalRevenue(),r=await this.getRevenueInPeriod(new Date(Date.now()-30*24*60*60*1e3),new Date),a=await this.getRevenueInPeriod(new Date(Date.now()-60*24*60*60*1e3),new Date(Date.now()-30*24*60*60*1e3)),o=a>0?(r-a)/a*100:0,i=await this.getTopRevenueTemplates(5),c=await this.getAverageOrderValue();return{totalRevenue:s,monthlyRevenue:r,revenueGrowth:o,averageOrderValue:c,topRevenueTemplates:i}}catch(s){throw console.error("Error fetching revenue analytics:",s),new Error("Failed to fetch revenue analytics")}}async getTotalTemplates(){const{count:s,error:r}=await l.from("templates").select("*",{count:"exact",head:!0}).eq("is_active",!0);if(r)throw r;return s||0}async getTotalDownloads(){const{count:s,error:r}=await l.from("template_downloads").select("*",{count:"exact",head:!0});if(r)throw r;return s||0}async getTotalRevenue(){return await this.getTotalDownloads()*25}async getTotalUsers(){const{count:s,error:r}=await l.from("profiles").select("*",{count:"exact",head:!0});if(r)throw r;return s||0}async getDownloadsInPeriod(s,r){const{count:a,error:o}=await l.from("template_downloads").select("*",{count:"exact",head:!0}).gte("created_at",s.toISOString()).lte("created_at",r.toISOString());if(o)throw o;return a||0}async getRevenueInPeriod(s,r){return await this.getDownloadsInPeriod(s,r)*25}async getNewUsersInPeriod(s,r){const{count:a,error:o}=await l.from("profiles").select("*",{count:"exact",head:!0}).gte("created_at",s.toISOString()).lte("created_at",r.toISOString());if(o)throw o;return a||0}async getPopularTemplates(s=10){const{data:r,error:a}=await l.from("templates").select(`
        id,
        title,
        download_count,
        price_sgd,
        categories(name)
      `).eq("is_active",!0).order("download_count",{ascending:!1}).limit(s);if(a)throw a;return r.map(o=>{var i;return{id:o.id,title:o.title,downloadCount:o.download_count||0,revenue:(o.download_count||0)*(o.price_sgd||0),category:((i=o.categories)==null?void 0:i.name)||"Uncategorized"}})}async getCategoryStats(){const{data:s,error:r}=await l.from("template_categories").select(`
        id,
        name,
        templates(id, download_count, price_sgd)
      `);if(r)throw r;return s.map(a=>{var o,i,c;return{categoryId:a.id,categoryName:a.name,templateCount:((o=a.templates)==null?void 0:o.length)||0,downloadCount:((i=a.templates)==null?void 0:i.reduce((u,d)=>u+(d.download_count||0),0))||0,revenue:((c=a.templates)==null?void 0:c.reduce((u,d)=>u+(d.download_count||0)*(d.price_sgd||0),0))||0}})}async getUserEngagementMetrics(s,r){return{averageSessionDuration:180,bounceRate:35.5,conversionRate:12.8,repeatUsers:45}}async getRevenueBreakdown(){return{public:0,premium:15e3,enterprise:8500}}async getDownloadTrends(s,r){const a=[],o=Math.ceil((r.getTime()-s.getTime())/864e5);for(let i=0;i<o;i++){const c=new Date(s.getTime()+i*24*60*60*1e3);a.push({date:c.toISOString().split("T")[0],downloads:Math.floor(Math.random()*50)+10,revenue:Math.floor(Math.random()*1e3)+200})}return a}async getFormatStats(){const{data:s,error:r}=await l.from("template_downloads").select("format");if(r)throw r;const a=s.reduce((i,c)=>(i[c.format]=(i[c.format]||0)+1,i),{}),o=Object.values(a).reduce((i,c)=>i+c,0);return Object.entries(a).map(([i,c])=>({format:i,count:c,percentage:o>0?c/o*100:0}))}async getTopRevenueTemplates(s=5){const{data:r,error:a}=await l.from("templates").select(`
        id,
        title,
        download_count,
        price_sgd
      `).eq("is_active",!0).order("download_count",{ascending:!1}).limit(s);if(a)throw a;return r.map(o=>({templateId:o.id,title:o.title,revenue:(o.download_count||0)*(o.price_sgd||0),downloads:o.download_count||0}))}async getAverageOrderValue(){const s=await this.getTotalRevenue(),r=await this.getTotalDownloads();return r>0?s/r:0}}const M=new ie,he=({className:t=""})=>{const[s,r]=w.useState(null),[a,o]=w.useState([]),[i,c]=w.useState(null),[u,d]=w.useState(!0),[f,p]=w.useState(null),[j,E]=w.useState("30d"),[T,m]=w.useState("overview");w.useEffect(()=>{v()},[j]);const v=async()=>{try{d(!0),p(null);const n=new Date,h=new Date;switch(j){case"7d":h.setDate(n.getDate()-7);break;case"30d":h.setDate(n.getDate()-30);break;case"90d":h.setDate(n.getDate()-90);break;case"1y":h.setFullYear(n.getFullYear()-1);break}const[q,V,G]=await Promise.all([M.getDashboardAnalytics({start:h,end:n}),M.getTemplatePerformance(),M.getRevenueAnalytics()]);r(q),o(V),c(G)}catch(n){console.error("Error loading analytics:",n),p(n instanceof Error?n.message:"Failed to load analytics")}finally{d(!1)}},y=n=>new Intl.NumberFormat("en-SG",{style:"currency",currency:"SGD"}).format(n),_=n=>new Intl.NumberFormat("en-SG").format(n),N=n=>`${n.toFixed(1)}%`,C=n=>n>0?e.jsx(H,{className:"h-4 w-4 text-green-500"}):n<0?e.jsx(K,{className:"h-4 w-4 text-red-500"}):e.jsx(J,{className:"h-4 w-4 text-gray-500"});if(u)return e.jsxs("div",{className:`space-y-6 ${t}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(b,{className:"h-8 w-64"}),e.jsx(b,{className:"h-10 w-32"})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[...Array(4)].map((n,h)=>e.jsx(b,{className:"h-32"},h))}),e.jsx(b,{className:"h-96"})]});if(f||!s)return e.jsx("div",{className:t,children:e.jsx(Q,{children:e.jsx(X,{children:f||"Failed to load analytics data. Please try again."})})});const k=[{title:"Total Templates",value:_(s.totalTemplates),change:"+12%",changeValue:12,icon:$,color:"text-blue-600"},{title:"Total Downloads",value:_(s.totalDownloads),change:"+8.5%",changeValue:8.5,icon:W,color:"text-green-600"},{title:"Total Revenue",value:y(s.totalRevenue),change:"+15.2%",changeValue:15.2,icon:F,color:"text-purple-600"},{title:"Active Users",value:_(s.totalUsers),change:"+6.8%",changeValue:6.8,icon:Y,color:"text-orange-600"}];return e.jsxs("div",{className:`space-y-6 ${t}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold text-gray-900",children:"Template Analytics"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Comprehensive insights into template marketplace performance"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(Z,{value:j,onValueChange:E,children:[e.jsx(ee,{className:"w-32",children:e.jsx(se,{})}),e.jsxs(re,{children:[e.jsx(R,{value:"7d",children:"Last 7 days"}),e.jsx(R,{value:"30d",children:"Last 30 days"}),e.jsx(R,{value:"90d",children:"Last 90 days"}),e.jsx(R,{value:"1y",children:"Last year"})]})]}),e.jsxs(te,{variant:"outline",onClick:v,disabled:u,children:[e.jsx(B,{className:"h-4 w-4 mr-2"}),"Refresh"]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:k.map((n,h)=>e.jsx(g,{children:e.jsx(x,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:n.title}),e.jsx("p",{className:"text-2xl font-bold text-gray-900 mt-1",children:n.value}),e.jsxs("div",{className:"flex items-center mt-2",children:[C(n.changeValue),e.jsx("span",{className:`text-sm ml-1 ${n.changeValue>0?"text-green-600":n.changeValue<0?"text-red-600":"text-gray-600"}`,children:n.change}),e.jsx("span",{className:"text-xs text-gray-500 ml-1",children:"vs last period"})]})]}),e.jsx(n.icon,{className:`h-8 w-8 ${n.color}`})]})})},h))}),e.jsxs(ae,{value:T,onValueChange:m,children:[e.jsxs(ne,{className:"grid w-full grid-cols-4",children:[e.jsx(U,{value:"overview",children:"Overview"}),e.jsx(U,{value:"performance",children:"Performance"}),e.jsx(U,{value:"revenue",children:"Revenue"}),e.jsx(U,{value:"engagement",children:"Engagement"})]}),e.jsxs(P,{value:"overview",className:"space-y-6",children:[e.jsxs("div",{className:"grid lg:grid-cols-2 gap-6",children:[e.jsxs(g,{children:[e.jsxs(S,{children:[e.jsxs(D,{className:"flex items-center gap-2",children:[e.jsx(L,{className:"h-5 w-5"}),"Popular Templates"]}),e.jsx(A,{children:"Top performing templates by downloads"})]}),e.jsx(x,{children:e.jsx("div",{className:"space-y-4",children:s.popularTemplates.slice(0,5).map((n,h)=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-sm font-medium text-blue-600",children:h+1})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:n.title}),e.jsx("p",{className:"text-sm text-gray-500",children:n.category})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium",children:_(n.downloadCount)}),e.jsx("p",{className:"text-sm text-gray-500",children:"downloads"})]})]},n.id))})})]}),e.jsxs(g,{children:[e.jsxs(S,{children:[e.jsxs(D,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-5 w-5"}),"Category Performance"]}),e.jsx(A,{children:"Downloads and revenue by category"})]}),e.jsx(x,{children:e.jsx("div",{className:"space-y-4",children:s.categoryStats.slice(0,5).map(n=>e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium",children:n.categoryName}),e.jsxs("span",{className:"text-sm text-gray-500",children:[_(n.downloadCount)," downloads"]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full",style:{width:`${Math.min(n.downloadCount/Math.max(...s.categoryStats.map(h=>h.downloadCount))*100,100)}%`}})})]},n.categoryId))})})]})]}),e.jsxs(g,{children:[e.jsxs(S,{children:[e.jsx(D,{children:"Download Format Preferences"}),e.jsx(A,{children:"User preferences for document formats"})]}),e.jsx(x,{children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:s.formatStats.map(n=>e.jsxs("div",{className:"text-center p-4 border rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:N(n.percentage)}),e.jsx("div",{className:"text-sm text-gray-600 uppercase tracking-wide",children:n.format}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[_(n.count)," downloads"]})]},n.format))})})]})]}),e.jsx(P,{value:"performance",className:"space-y-6",children:e.jsxs(g,{children:[e.jsxs(S,{children:[e.jsx(D,{children:"Template Performance Metrics"}),e.jsx(A,{children:"Detailed performance analysis for all templates"})]}),e.jsx(x,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b",children:[e.jsx("th",{className:"text-left p-2",children:"Template"}),e.jsx("th",{className:"text-right p-2",children:"Views"}),e.jsx("th",{className:"text-right p-2",children:"Downloads"}),e.jsx("th",{className:"text-right p-2",children:"Conversion"}),e.jsx("th",{className:"text-right p-2",children:"Revenue"}),e.jsx("th",{className:"text-right p-2",children:"Rating"})]})}),e.jsx("tbody",{children:a.slice(0,10).map(n=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"p-2",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:n.title}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Updated ",oe(n.lastUpdated,{addSuffix:!0})]})]})}),e.jsx("td",{className:"text-right p-2",children:_(n.views)}),e.jsx("td",{className:"text-right p-2",children:_(n.downloads)}),e.jsx("td",{className:"text-right p-2",children:N(n.conversionRate)}),e.jsx("td",{className:"text-right p-2",children:y(n.revenue)}),e.jsx("td",{className:"text-right p-2",children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:[e.jsx(z,{className:"h-4 w-4 text-yellow-400 fill-current"}),n.rating.toFixed(1)]})})]},n.templateId))})]})})})]})}),e.jsx(P,{value:"revenue",className:"space-y-6",children:i&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsx(g,{children:e.jsx(x,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Monthly Revenue"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:y(i.monthlyRevenue)}),e.jsxs("div",{className:"flex items-center mt-1",children:[C(i.revenueGrowth),e.jsx("span",{className:`text-sm ml-1 ${i.revenueGrowth>0?"text-green-600":"text-red-600"}`,children:N(i.revenueGrowth)})]})]}),e.jsx(F,{className:"h-8 w-8 text-green-600"})]})})}),e.jsx(g,{children:e.jsx(x,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Average Order Value"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:y(i.averageOrderValue)})]}),e.jsx(I,{className:"h-8 w-8 text-blue-600"})]})})}),e.jsx(g,{children:e.jsx(x,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Total Revenue"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:y(i.totalRevenue)})]}),e.jsx(L,{className:"h-8 w-8 text-purple-600"})]})})})]}),e.jsxs(g,{children:[e.jsxs(S,{children:[e.jsx(D,{children:"Top Revenue Generating Templates"}),e.jsx(A,{children:"Templates contributing most to revenue"})]}),e.jsx(x,{children:e.jsx("div",{className:"space-y-4",children:i.topRevenueTemplates.map((n,h)=>e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-green-100 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-sm font-medium text-green-600",children:h+1})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:n.title}),e.jsxs("p",{className:"text-sm text-gray-500",children:[_(n.downloads)," downloads"]})]})]}),e.jsx("div",{className:"text-right",children:e.jsx("p",{className:"font-bold text-green-600",children:y(n.revenue)})})]},n.templateId))})})]})]})}),e.jsx(P,{value:"engagement",className:"space-y-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsx(g,{children:e.jsx(x,{className:"p-6",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-2xl font-bold text-gray-900",children:[s.userEngagement.averageSessionDuration,"s"]}),e.jsx("p",{className:"text-sm text-gray-600",children:"Avg Session Duration"})]})})}),e.jsx(g,{children:e.jsx(x,{className:"p-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:N(s.userEngagement.bounceRate)}),e.jsx("p",{className:"text-sm text-gray-600",children:"Bounce Rate"})]})})}),e.jsx(g,{children:e.jsx(x,{className:"p-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:N(s.userEngagement.conversionRate)}),e.jsx("p",{className:"text-sm text-gray-600",children:"Conversion Rate"})]})})}),e.jsx(g,{children:e.jsx(x,{className:"p-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:N(s.userEngagement.repeatUsers)}),e.jsx("p",{className:"text-sm text-gray-600",children:"Repeat Users"})]})})})]})})]})]})},le={async getPermissions(){const{data:t,error:s}=await l.from("permissions").select("*").order("resource",{ascending:!0}).order("action",{ascending:!0});if(s)throw console.error("Error fetching permissions:",s),new Error("Failed to fetch permissions");return t||[]},async getRolePermissions(t){let s=l.from("role_permissions").select(`
        *,
        permission:permissions(*)
      `).order("role",{ascending:!0});t&&(s=s.eq("role",t));const{data:r,error:a}=await s;if(a)throw console.error("Error fetching role permissions:",a),new Error("Failed to fetch role permissions");return r||[]},async updateRolePermissions(t,s){const{error:r}=await l.from("role_permissions").delete().eq("role",t);if(r)throw console.error("Error deleting role permissions:",r),new Error("Failed to update role permissions");if(s.length>0){const a=s.map(i=>({role:t,permission_id:i})),{error:o}=await l.from("role_permissions").insert(a);if(o)throw console.error("Error inserting role permissions:",o),new Error("Failed to update role permissions")}await this.logAction("update_role_permissions","role_permissions",t,null,{role:t,permission_ids:s})},async getUsers(t={}){let s=l.from("profiles").select("*").order("created_at",{ascending:!1});t.role&&(s=s.eq("role",t.role)),t.search&&(s=s.or(`full_name.ilike.%${t.search}%,email.ilike.%${t.search}%`));const{data:r,error:a}=await s;if(a)throw console.error("Error fetching users:",a),new Error("Failed to fetch users");return r||[]},async getUserWithPermissions(t){const{data:s,error:r}=await l.rpc("get_user_permissions",{user_uuid:t});if(r)throw console.error("Error fetching user permissions:",r),new Error("Failed to fetch user permissions");const{data:a,error:o}=await l.from("profiles").select("*").eq("id",t).single();if(o)throw console.error("Error fetching user profile:",o),new Error("Failed to fetch user profile");return{...a,permissions:s||[]}},async updateUserRole(t,s){const{data:r}=await l.from("profiles").select("*").eq("id",t).single(),{data:a,error:o}=await l.from("profiles").update({role:s}).eq("id",t).select().single();if(o)throw console.error("Error updating user role:",o),new Error("Failed to update user role");return await this.logAction("update_user_role","profiles",t,{role:r==null?void 0:r.role},{role:s}),a},async deleteUser(t){const{data:s}=await l.from("profiles").select("*").eq("id",t).single(),{error:r}=await l.from("profiles").delete().eq("id",t);if(r)throw console.error("Error deleting user:",r),new Error("Failed to delete user");await this.logAction("delete_user","profiles",t,s,null)},async getUserPermissions(t){const{data:s,error:r}=await l.from("user_permissions").select(`
        *,
        permission:permissions(*),
        granted_by_user:profiles!user_permissions_granted_by_fkey(full_name, email)
      `).eq("user_id",t).order("created_at",{ascending:!1});if(r)throw console.error("Error fetching user permissions:",r),new Error("Failed to fetch user permissions");return s||[]},async grantUserPermission(t){const{data:{user:s}}=await l.auth.getUser();if(!s)throw new Error("User not authenticated");const{data:r,error:a}=await l.from("user_permissions").upsert({...t,granted_by:s.id}).select(`
        *,
        permission:permissions(*)
      `).single();if(a)throw console.error("Error granting user permission:",a),new Error("Failed to grant user permission");return await this.logAction("grant_user_permission","user_permissions",r.id,null,t),r},async revokeUserPermission(t,s){const{error:r}=await l.from("user_permissions").delete().eq("user_id",t).eq("permission_id",s);if(r)throw console.error("Error revoking user permission:",r),new Error("Failed to revoke user permission");await this.logAction("revoke_user_permission","user_permissions",`${t}-${s}`,{user_id:t,permission_id:s},null)},async hasPermission(t){const{data:{user:s}}=await l.auth.getUser();if(!s)return!1;const{data:r,error:a}=await l.rpc("user_has_permission",{user_uuid:s.id,permission_name:t});return a?(console.error("Error checking permission:",a),!1):r||!1},async getUserPermissionsList(t){const{data:{user:s}}=await l.auth.getUser(),r=t||(s==null?void 0:s.id);if(!r)return[];const{data:a,error:o}=await l.rpc("get_user_permissions",{user_uuid:r});return o?(console.error("Error fetching user permissions list:",o),[]):(a||[]).filter(i=>i.granted_by_role||i.granted_individually).map(i=>i.permission_name)},async getAuditLogs(t={}){let s=l.from("audit_logs").select(`
        *,
        user:profiles(full_name, email, role)
      `).order("created_at",{ascending:!1}).limit(100);t.user_id&&(s=s.eq("user_id",t.user_id)),t.action&&(s=s.eq("action",t.action)),t.resource_type&&(s=s.eq("resource_type",t.resource_type)),t.date_from&&(s=s.gte("created_at",t.date_from.toISOString())),t.date_to&&(s=s.lte("created_at",t.date_to.toISOString()));const{data:r,error:a}=await s;if(a)throw console.error("Error fetching audit logs:",a),new Error("Failed to fetch audit logs");return r||[]},async logAction(t,s,r,a,o,i,c){const{data:{user:u}}=await l.auth.getUser();if(!u)return;const{error:d}=await l.rpc("log_admin_action",{user_uuid:u.id,action_name:t,resource_type_name:s,resource_id_value:r,old_values_json:a,new_values_json:o,ip_addr:i,user_agent_string:c});d&&console.error("Error logging action:",d)},async bulkUpdateUserRoles(t,s){const{error:r}=await l.from("profiles").update({role:s}).in("id",t);if(r)throw console.error("Error bulk updating user roles:",r),new Error("Failed to bulk update user roles");await this.logAction("bulk_update_user_roles","profiles",t.join(","),null,{user_ids:t,role:s})},async bulkDeleteUsers(t){const{error:s}=await l.from("profiles").delete().in("id",t);if(s)throw console.error("Error bulk deleting users:",s),new Error("Failed to bulk delete users");await this.logAction("bulk_delete_users","profiles",t.join(","),{user_ids:t},null)}},ge=()=>{const[t,s]=w.useState([]),[r,a]=w.useState(!0),{user:o,profile:i}=O(),c=async()=>{if(!o){s([]),a(!1);return}try{a(!0);const m=await le.getUserPermissionsList();s(m)}catch(m){console.error("Error fetching permissions:",m),s([])}finally{a(!1)}};w.useEffect(()=>{c()},[o]);const u=m=>t.includes(m),d=m=>m.some(v=>t.includes(v)),f=m=>m.every(v=>t.includes(v)),p=m=>i!=null&&i.role?Array.isArray(m)?m.includes(i.role):i.role===m:!1,j=p(["admin","super_admin"]),E=p(["moderator","admin","super_admin"]),T=p("super_admin");return{permissions:t,hasPermission:u,hasAnyPermission:d,hasAllPermissions:f,hasRole:p,isAdmin:j,isModerator:E,isSuperAdmin:T,loading:r,refetch:c}},xe=()=>{const{profile:t}=O();return{canAccessAdmin:()=>(t==null?void 0:t.role)&&["admin","super_admin"].includes(t.role),canAccessModerator:()=>(t==null?void 0:t.role)&&["moderator","admin","super_admin"].includes(t.role),canManageUsers:()=>(t==null?void 0:t.role)&&["admin","super_admin"].includes(t.role),canManageSystem:()=>(t==null?void 0:t.role)==="super_admin",userRole:(t==null?void 0:t.role)||"user"}},pe={DOCUMENTS_CREATE:"documents.create",DOCUMENTS_READ:"documents.read",DOCUMENTS_UPDATE:"documents.update",DOCUMENTS_DELETE:"documents.delete",DOCUMENTS_READ_ALL:"documents.read_all",TEMPLATES_CREATE:"templates.create",TEMPLATES_READ:"templates.read",TEMPLATES_UPDATE:"templates.update",TEMPLATES_DELETE:"templates.delete",TEMPLATES_MODERATE:"templates.moderate",TEMPLATES_MANAGE:"templates.manage",LAW_FIRMS_CREATE:"law_firms.create",LAW_FIRMS_READ:"law_firms.read",LAW_FIRMS_UPDATE:"law_firms.update",LAW_FIRMS_DELETE:"law_firms.delete",LAW_FIRMS_VERIFY:"law_firms.verify",LAW_FIRMS_MODERATE_REVIEWS:"law_firms.moderate_reviews",USERS_CREATE:"users.create",USERS_READ:"users.read",USERS_UPDATE:"users.update",USERS_DELETE:"users.delete",USERS_MANAGE_ROLES:"users.manage_roles",USERS_MANAGE_PERMISSIONS:"users.manage_permissions",SYSTEM_ANALYTICS:"system.analytics",SYSTEM_MONITORING:"system.monitoring",SYSTEM_AUDIT_LOGS:"system.audit_logs",SYSTEM_SETTINGS:"system.settings"};export{pe as P,he as T,xe as a,le as r,ge as u};
