import{supabase as h}from"./supabase-B5_W4sir.js";import{x as f}from"./ai-services-DbCQJDXZ.js";async function _(c){const{query:s,userId:m,similarityThreshold:n=.7,maxResults:i=10,documentIds:e}=c;try{const{embedding:a}=await f(s),{data:d,error:o}=await h.rpc("search_similar_chunks",{query_embedding:a,similarity_threshold:n,match_count:i,user_filter:m||null});if(o)throw console.error("Semantic search error:",o),new Error("Failed to perform semantic search");let l=d||[];return e&&e.length>0&&(l=l.filter(t=>e.includes(t.document_id))),await Promise.all(l.map(async t=>{const{data:r}=await h.from("uploaded_documents").select("*").eq("id",t.document_id).single();return{id:t.id,document_id:t.document_id,chunk_text:t.chunk_text,similarity:t.similarity,document:r||void 0}}))}catch(a){throw console.error("Semantic search failed:",a),a}}async function y(c){const{query:s,userId:m,documentType:n,dateRange:i}=c;try{let e=h.from("uploaded_documents").select("*").eq("user_id",m).textSearch("ocr_text",s,{type:"websearch",config:"english"});n&&(e=e.eq("document_type",n)),i&&(e=e.gte("created_at",i.start.toISOString()).lte("created_at",i.end.toISOString())),e=e.order("created_at",{ascending:!1});const{data:a,error:d}=await e;if(d)throw console.error("Text search error:",d),new Error("Failed to perform text search");return a||[]}catch(e){throw console.error("Text search failed:",e),e}}async function x(c,s,m={}){const{semanticWeight:n=.7,textWeight:i=.3,maxResults:e=20,documentType:a,dateRange:d}=m;try{const[o,l]=await Promise.all([_({query:c,userId:s,maxResults:Math.ceil(e*n)}),y({query:c,userId:s,documentType:a,dateRange:d})]),u=new Set,t=[];return o.forEach(r=>{r.document&&!u.has(r.document.id)&&(u.add(r.document.id),t.push(r.document))}),l.forEach(r=>{u.has(r.id)||(u.add(r.id),t.push(r))}),{semanticResults:o,textResults:t.slice(0,e),totalResults:t.length}}catch(o){throw console.error("Combined search failed:",o),o}}export{x as c,_ as s,y as t};
